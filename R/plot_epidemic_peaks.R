#' Plot Epidemic Peaks from Detection Results
#'
#' This function loads the epidemic peak detection results and creates a multi-page
#' PDF with time series plots showing cases and identified peaks for each location.
#'
#' @param PATHS List of paths generated by get_paths() containing required data locations
#' @param output_file Character string specifying the output PDF filename 
#'   (default: "epidemic_peaks_visualization.pdf")
#' @param height_per_plot Numeric specifying the height in inches for each subplot (default: 3)
#' @param plots_per_page Integer specifying number of plots per page (default: 4)
#'
#' @return NULL (creates PDF file as side effect)
#'
#' @export
#'
#' @examples
#' \dontrun{
#' # Set up paths and create visualization
#' set_root_directory("~/MOSAIC")
#' PATHS <- get_paths()
#' 
#' # Run peak detection first
#' est_epidemic_peaks(PATHS, method = 'algorithm')
#' 
#' # Create visualization PDF
#' plot_epidemic_peaks(PATHS)
#' }
#'
#' @importFrom readr read_csv
#' @importFrom dplyr filter arrange mutate group_by
#' @importFrom lubridate as_date
#' @importFrom grDevices pdf dev.off
#' @importFrom graphics plot lines abline points legend par mtext rect
#'
plot_epidemic_peaks <- function(PATHS, 
                                output_file = "epidemic_peaks_visualization.pdf",
                                height_per_plot = 3,
                                plots_per_page = 4) {
  
  # Load the peak detection results
  peaks_file <- file.path(PATHS$MODEL_INPUT, "param_epidemic_peaks.csv")
  
  if (!file.exists(peaks_file)) {
    stop(paste("Peak detection results not found at:", peaks_file,
               "\nPlease run est_epidemic_peaks() first."))
  }
  
  peaks_data <- read_csv(peaks_file, show_col_types = FALSE)
  
  # Load the original cholera surveillance data
  data_file <- file.path(PATHS$DATA_CHOLERA_DAILY, "cholera_surveillance_daily_combined.csv")
  
  if (!file.exists(data_file)) {
    stop(paste("Cholera surveillance data not found at:", data_file))
  }
  
  cholera_data <- read_csv(data_file, show_col_types = FALSE)
  
  # Get unique locations from peaks data
  locations <- unique(peaks_data$location_code)
  n_locations <- length(locations)
  
  if (n_locations == 0) {
    stop("No locations found in peak detection results")
  }
  
  # Calculate PDF dimensions
  page_height <- height_per_plot * plots_per_page + 2  # Add margin
  n_pages <- ceiling(n_locations / plots_per_page)
  
  # Create output directory if needed
  output_dir <- file.path(PATHS$DOCS_FIGURES, "epidemic_peaks")
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  # Full path for output file
  output_path <- file.path(output_dir, output_file)
  
  # Start PDF device
  pdf(output_path, width = 10, height = page_height)
  
  # Set up multi-panel layout
  plot_counter <- 0
  
  for (loc_idx in seq_along(locations)) {
    
    loc <- locations[loc_idx]
    
    # Check if we need a new page
    if (plot_counter %% plots_per_page == 0) {
      par(mfrow = c(plots_per_page, 1), 
          mar = c(3, 4, 3, 2),
          oma = c(2, 2, 2, 2))
    }
    
    # Get data for this location
    loc_data <- cholera_data %>%
      filter(iso_code == loc) %>%
      arrange(date) %>%
      mutate(
        date = as_date(date),
        cases = ifelse(is.na(cases), 0, cases)
      )
    
    # Skip if no data
    if (nrow(loc_data) == 0) {
      next
    }
    
    # Apply same smoothing as in est_epidemic_peaks
    window_size <- 21  # 3-week window for better smoothing
    n <- nrow(loc_data)
    loc_data$smoothed <- NA
    
    for (i in 1:n) {
      start_idx <- max(1, i - floor(window_size/2))
      end_idx <- min(n, i + floor(window_size/2))
      loc_data$smoothed[i] <- mean(loc_data$cases[start_idx:end_idx], na.rm = TRUE)
    }
    
    # Get peaks for this location
    loc_peaks <- peaks_data %>%
      filter(location_code == loc)
    
    # Create plot
    plot(loc_data$date, loc_data$cases,
         type = "l", col = "gray70", lwd = 0.5,
         xlab = "", ylab = "Cases",
         main = paste(loc, "-", nrow(loc_peaks), "epidemic peak(s) detected"),
         las = 1)
    
    # Add smoothed line
    lines(loc_data$date, loc_data$smoothed, 
          col = "blue", lwd = 2)
    
    # Add epidemic periods as shaded regions
    if (nrow(loc_peaks) > 0) {
      for (j in 1:nrow(loc_peaks)) {
        # Shade epidemic period
        rect(xleft = as.Date(loc_peaks$peak_start[j]),
             xright = as.Date(loc_peaks$peak_end[j]),
             ybottom = 0,
             ytop = max(loc_data$cases, na.rm = TRUE) * 1.1,
             col = rgb(1, 0, 0, 0.1),
             border = NA)
        
        # Mark peak
        points(as.Date(loc_peaks$peak_date[j]), 
               loc_peaks$peak_magnitude[j],
               col = "red", pch = 19, cex = 1.5)
        
        # Add vertical line at peak
        abline(v = as.Date(loc_peaks$peak_date[j]),
               col = "red", lty = 3, lwd = 0.5)
      }
    }
    
    # Add legend (only on first plot of each page)
    if (plot_counter %% plots_per_page == 0) {
      legend("topright",
             legend = c("Observed cases", "Smoothed (21-day mean)", 
                       "Detected peak", "Epidemic period"),
             col = c("gray70", "blue", "red", rgb(1, 0, 0, 0.2)),
             lty = c(1, 1, NA, NA),
             pch = c(NA, NA, 19, NA),
             fill = c(NA, NA, NA, rgb(1, 0, 0, 0.2)),
             border = c(NA, NA, NA, NA),
             lwd = c(1, 2, NA, NA),
             cex = 0.8,
             bg = "white")
    }
    
    # Add date range info
    date_range <- paste("Data:", format(min(loc_data$date), "%Y-%m-%d"),
                       "to", format(max(loc_data$date), "%Y-%m-%d"))
    mtext(date_range, side = 1, line = 2, cex = 0.7, col = "gray50")
    
    plot_counter <- plot_counter + 1
  }
  
  # Add overall title on last page
  if (n_locations > 0) {
    mtext(paste("Epidemic Peak Detection Results -", n_locations, "locations,",
                nrow(peaks_data), "total peaks"),
          outer = TRUE, cex = 1.2, font = 2, line = -1)
  }
  
  # Close PDF device
  dev.off()
  
  message(paste("\nEpidemic peaks visualization saved to:", output_path))
  message(paste("  - Locations plotted:", n_locations))
  message(paste("  - Total peaks shown:", nrow(peaks_data)))
  message(paste("  - PDF pages:", n_pages))
  
  invisible(NULL)
}


#' Create Summary Plot of Epidemic Peak Statistics
#'
#' This function creates a summary visualization showing peak statistics across all locations
#'
#' @param PATHS List of paths generated by get_paths() containing required data locations
#' @param output_file Character string specifying the output filename 
#'   (default: "epidemic_peaks_summary.pdf")
#'
#' @return NULL (creates PDF file as side effect)
#'
#' @export
#'
#' @examples
#' \dontrun{
#' # Create summary visualization
#' plot_epidemic_peaks_summary(PATHS)
#' }
#'
#' @importFrom readr read_csv
#' @importFrom dplyr group_by summarise arrange n
#' @importFrom graphics barplot hist boxplot
#'
plot_epidemic_peaks_summary <- function(PATHS, 
                                       output_file = "epidemic_peaks_summary.pdf") {
  
  # Load the peak detection results
  peaks_file <- file.path(PATHS$MODEL_INPUT, "param_epidemic_peaks.csv")
  
  if (!file.exists(peaks_file)) {
    stop(paste("Peak detection results not found at:", peaks_file,
               "\nPlease run est_epidemic_peaks() first."))
  }
  
  peaks_data <- read_csv(peaks_file, show_col_types = FALSE)
  
  # Calculate summary statistics
  peaks_by_location <- peaks_data %>%
    group_by(location_code) %>%
    summarise(
      n_peaks = n(),
      mean_magnitude = mean(peak_magnitude, na.rm = TRUE),
      max_magnitude = max(peak_magnitude, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(desc(n_peaks))
  
  # Calculate epidemic durations
  peaks_data$duration_days <- as.numeric(
    as.Date(peaks_data$peak_end) - as.Date(peaks_data$peak_start)
  )
  
  # Create output directory if needed
  output_dir <- file.path(PATHS$DOCS_FIGURES, "epidemic_peaks")
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  # Full path for output file
  output_path <- file.path(output_dir, output_file)
  
  # Create summary plots
  pdf(output_path, width = 12, height = 10)
  
  # Set up 2x2 layout
  par(mfrow = c(2, 2), mar = c(5, 4, 4, 2))
  
  # 1. Number of peaks by location
  barplot(peaks_by_location$n_peaks,
          names.arg = peaks_by_location$location_code,
          las = 2,
          col = "steelblue",
          main = "Number of Epidemic Peaks by Location",
          ylab = "Number of peaks",
          xlab = "")
  
  # 2. Distribution of peak magnitudes
  hist(peaks_data$peak_magnitude,
       breaks = 30,
       col = "coral",
       main = "Distribution of Peak Magnitudes",
       xlab = "Peak magnitude (smoothed cases)",
       ylab = "Frequency")
  
  # 3. Distribution of epidemic durations
  hist(peaks_data$duration_days,
       breaks = 30,
       col = "lightgreen",
       main = "Distribution of Epidemic Durations",
       xlab = "Duration (days)",
       ylab = "Frequency")
  
  # 4. Peak timing by month
  peaks_data$peak_month <- as.numeric(format(as.Date(peaks_data$peak_date), "%m"))
  
  # Create counts for all 12 months (some may be 0)
  all_months <- 1:12
  month_counts <- rep(0, 12)
  observed_months <- table(peaks_data$peak_month)
  month_counts[as.numeric(names(observed_months))] <- observed_months
  
  barplot(month_counts,
          names.arg = month.abb,
          col = "gold",
          main = "Seasonal Distribution of Epidemic Peaks",
          xlab = "Month",
          ylab = "Number of peaks")
  
  # Add overall title
  mtext(paste("Epidemic Peak Detection Summary -", 
              length(unique(peaks_data$location_code)), "locations,",
              nrow(peaks_data), "total peaks"),
        outer = TRUE, cex = 1.3, font = 2, line = -2)
  
  dev.off()
  
  message(paste("\nEpidemic peaks summary saved to:", output_path))
  
  invisible(NULL)
}