#' Process Weekly Cholera Data: Convert Country Names to ISO3 and Filter by WHO AFRO Region with Cutoff for Binary Cases
#'
#' This function processes weekly cholera data by converting country names to ISO3 codes, filtering the data for countries in the WHO AFRO region, and organizing the data by year and week. It adds binary outbreak indicators based on a specified case cutoff value and generates start and stop dates for each ISO week.
#'
#' @param PATHS A list containing paths to the raw and processed data directories. Typically generated by the `get_paths()` function and should include:
#' \itemize{
#'   \item \strong{DATA_SCRAPE_WHO_WEEKLY}: Path to the raw cholera data file (e.g., `cholera_country_weekly.csv`).
#'   \item \strong{DATA_WHO_WEEKLY}: Path to save the processed cholera data (e.g., `cholera_country_weekly_processed.csv`).
#' }
#' @param cutoff An integer specifying the case count threshold above which a binary outbreak indicator is set to 1. Specific countries (e.g., Cameroon) can have adjusted cutoff values.
#'
#' @return The function processes cholera data, adds a binary outbreak indicator, and saves the result as a CSV file. No value is returned.
#'
#' @details
#' This function performs the following tasks:
#' \itemize{
#'   \item Reads raw cholera data from a CSV file.
#'   \item Converts country names to ISO3 codes using the `MOSAIC::convert_country_to_iso` and `MOSAIC::convert_iso_to_country` functions.
#'   \item Filters the dataset to include only countries in the WHO AFRO region (based on `MOSAIC::iso_codes_who_afro`).
#'   \item Orders the data by year, week, and country.
#'   \item Renames columns for consistency: `cases_by_week` to `cases` and `deaths_by_week` to `deaths`.
#'   \item Adds `date_start` and `date_stop` columns based on ISO week, using the `ISOweek::ISOweek2date` function.
#'   \item Adds a binary outbreak indicator (`cases_binary`) based on a specified `cutoff` for case counts, with specific adjustments for certain countries (e.g., Cameroon).
#'   \item Reorganizes the columns for clarity and saves the processed data to the specified path.
#' }
#'
#' @importFrom utils read.csv write.csv
#' @importFrom ISOweek ISOweek2date
#' @examples
#' \dontrun{
#' # Define paths for raw and processed cholera data
#' PATHS <- get_paths()
#'
#' # Process the weekly cholera data with a cutoff of 700 cases
#' process_WHO_weekly_data(PATHS, cutoff = 700)
#' }
#' @export

process_WHO_weekly_data <- function(PATHS, cutoff) {

     if (!dir.exists(PATHS$DATA_WHO_WEEKLY)) dir.create(PATHS$DATA_WHO_WEEKLY, recursive = TRUE)

     # Read the cholera data from the raw data directory
     raw_data_path <- file.path(PATHS$DATA_SCRAPE_WHO_WEEKLY, "cholera_country_weekly.csv")
     message("Loading raw data from: ", raw_data_path)

     d <- utils::read.csv(raw_data_path, stringsAsFactors = FALSE)

     # Convert country names to ISO3 codes and back
     d$iso_code <- MOSAIC::convert_country_to_iso(d$country)
     d$country <- MOSAIC::convert_iso_to_country(d$iso_code)

     # Filter the data to include only AFRO countries
     d <- d[d$iso_code %in% MOSAIC::iso_codes_who_afro, ]

     # Order the data by year, week, and country
     d <- d[order(d$year, d$week, d$country), ]

     # Rename columns for consistency
     colnames(d)[colnames(d) == "cases_by_week"] <- "cases"
     colnames(d)[colnames(d) == "deaths_by_week"] <- "deaths"

     d$iso_week <- paste0(d$year, "-W", sprintf("%02d", d$week))
     d$date_start <- ISOweek::ISOweek2date(paste0(d$iso_week, "-1"))
     d$date_stop <- ISOweek::ISOweek2date(paste0(d$iso_week, "-7"))
     d$iso_week <- NULL

     d$month <- lubridate::month(as.Date(d$date_start))

     # Reorganize the columns for clarity
     d <- d[, c("country", "iso_code", "year", "month", "week", "date_start", "date_stop", "cases", "deaths")]



     # Set binary presence/absence for outbreak status

     # Filter out countries with fewer than 30 observations
     tmp <- table(d$iso_code)
     keep <- names(tmp[tmp > 10])
     d <- d[d$iso_code %in% keep,]

     d$date_start <- as.Date(d$date_start)
     d$date_stop <- as.Date(d$date_stop)

     # Initialize cases_binary column
     d$cases_binary <- 0

     # Split the data by iso_code
     split_data <- split(d, d$iso_code)

     # Apply the logic to each subset and update the binary column
     split_data <- lapply(split_data, function(country_data) {

          # Set cases_binary to 1 where cases >= cutoff
          country_data$cases_binary <- as.numeric(country_data$cases >= cutoff)

          # Check for one time step over the cutoff and set the previous one time steps to 1
          for (i in 2:nrow(country_data)) {

               if (!is.na(country_data$cases_binary[i]) && country_data$cases_binary[i] == 1) {
                    country_data$cases_binary[i - 1] <- 1

               }
          }

          # Check for two consecutive time steps over the cutoff and set the previous two time steps to 1
          for (i in 4:nrow(country_data)) {

               if (!is.na(country_data$cases_binary[i]) && !is.na(country_data$cases_binary[i - 1])) {

                    if (country_data$cases_binary[i] == 1 && country_data$cases_binary[i - 1] == 1) {

                         country_data$cases_binary[i - 2] <- 1
                         country_data$cases_binary[i - 3] <- 1

                    }
               }
          }

          return(country_data)

     })

     # Reassemble the data back into one data frame
     d <- do.call(rbind, split_data)

     # Reset row names
     row.names(d) <- NULL



     # Print the first few rows for verification
     print(head(d))

     message("Latest observation: ", max(d$date_stop, na.rm=TRUE))

     if (53 %in% d$week) stop("week index is out of bounds")

     # Save the processed data to the processed data directory
     processed_data_path <- file.path(PATHS$DATA_WHO_WEEKLY, "cholera_country_weekly_processed.csv")
     utils::write.csv(d, file = processed_data_path, row.names = FALSE)

     message("Processed cholera data saved to: ", processed_data_path)
}
