<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md - MOSAIC R Package ‚Ä¢ MOSAIC</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md - MOSAIC R Package"><meta property="og:image" content="https://institutefordiseasemodeling.github.io/MOSAIC-pkg/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">MOSAIC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.13.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/Installation.html">Installation</a></li>
    <li><a class="dropdown-item" href="articles/Running-LASER.html">Running LASER</a></li>
    <li><a class="dropdown-item" href="articles/Running-MOSAIC.html">Running MOSAIC</a></li>
    <li><a class="dropdown-item" href="articles/Deployment.html">Deployment</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>CLAUDE.md - MOSAIC R Package</h1>
      <small class="dont-index">Source: <a href="https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/blob/HEAD/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd---mosaic-r-package" class="section level1">

<p>This file provides comprehensive guidance for Claude Code when working with the MOSAIC R package.</p>
<div class="section level2">
<h2 id="id_-table-of-contents">üìö Table of Contents<a class="anchor" aria-label="anchor" href="#id_-table-of-contents"></a></h2>
<p><strong>Quick Start:</strong> - <a href="#id_-quick-reference-card">‚ö° Quick Reference Card</a> - <a href="#id_-first-time-on-mosaic">üöÄ First Time on MOSAIC</a> - <a href="#id_-common-tasks-step-by-step">üìã Common Tasks</a></p>
<p><strong>Understanding MOSAIC:</strong> - <a href="#package-overview">Package Overview</a> - <a href="#architecture">Architecture</a> - <a href="#the-run_mosaic-workflow-centerpiece-of-the-package">The run_MOSAIC Workflow</a> ‚≠ê CENTERPIECE - <a href="#function-organization-219-files">Function Organization</a> - <a href="#parameter-system-architecture">Parameter System</a></p>
<p><strong>Development:</strong> - <a href="#working-with-claude-code-development-standards">Development Standards</a> üìã CRITICAL - <a href="#id_2-package-version-management">Version Management</a> - <a href="#id_3-testing-requirements">Testing</a> - <a href="#id_6-git-workflow">Git Workflow</a> - <a href="#id_7-documentation-standards">Documentation</a></p>
<p><strong>Deep Dives:</strong> - <a href="#python-integration">Python Integration</a> - <a href="#likelihood-calculation">Likelihood Calculation</a> - <a href="#critical-npe-performance-optimization">NPE Performance</a> ‚ö° PERFORMANCE CRITICAL</p>
<p><strong>Troubleshooting &amp; Reference:</strong> - <a href="#id_-when-things-go-wrong">When Things Go Wrong</a> - <a href="#key-files-reference">Key Files Reference</a> - <a href="#id_-why-we-do-this-design-decisions">Design Decisions</a> - <a href="#system-requirements">System Requirements</a></p>
<hr></div>
<div class="section level2">
<h2 id="id_-quick-reference-card">‚ö° Quick Reference Card<a class="anchor" aria-label="anchor" href="#id_-quick-reference-card"></a></h2>
<p><strong>Check current state (do this FIRST):</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">git</span> status                      <span class="co"># Any uncommitted changes?</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--oneline</span> <span class="at">-5</span>           <span class="co"># Recent commits</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"^Version:"</span> DESCRIPTION   <span class="co"># Current version (you'll bump this)</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span> <span class="co"># Baseline: all tests should pass</span></span></code></pre></div>
<p><strong>Development cycle:</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># 1. Write production-ready code (no placeholders!)</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co"># 2. Add/update tests</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span>              <span class="co"># Must pass</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co"># 3. Update docs if function signatures changed</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document()"</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co"># 4. Check package builds cleanly</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="ex">R</span> CMD check .</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"pkgdown::build_site()"</span>        <span class="co"># If docs changed</span></span></code></pre></div>
<p><strong>Commit workflow (ALWAYS):</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># 1. Bump version in DESCRIPTION (patch: 0.8.7‚Üí0.8.8, minor: 0.8.7‚Üí0.9.0, major: 0.8.7‚Üí1.0.0)</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co"># 2. Stage relevant files: git add DESCRIPTION R/my_file.R tests/...</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co"># 3. Commit with version: git commit -m "Fix bug (v0.8.8)"</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># 4. Push: git push origin main</span></span></code></pre></div>
<p><strong>Essential commands:</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Testing</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span>                    <span class="co"># Run all tests</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"testthat::test_file('tests/testthat/test-foo.R')"</span>  <span class="co"># Single test</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co"># Documentation</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document()"</span>                <span class="co"># Update docs</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"?function_name"</span>                      <span class="co"># Check doc renders</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"pkgdown::build_site()"</span>              <span class="co"># Rebuild website</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co"># Package checks</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="ex">R</span> CMD check .                                     <span class="co"># Full package check</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::check_dependencies()"</span>        <span class="co"># Verify Python env</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="co"># Git</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--oneline</span> <span class="at">-10</span>                            <span class="co"># Recent commits</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="fu">git</span> diff                                          <span class="co"># See changes</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--grep</span><span class="op">=</span><span class="st">"NPE"</span>                             <span class="co"># Search commits</span></span></code></pre></div>
<p><strong>Critical paths (DON‚ÄôT BREAK THESE):</strong> - <code><a href="reference/run_MOSAIC.html">run_MOSAIC()</a></code> ‚Üí R/run_MOSAIC.R:575 (main calibration workflow) - <code><a href="reference/calc_model_likelihood.html">calc_model_likelihood()</a></code> ‚Üí R/calc_model_likelihood.R:66 (called 1000s of times) - <code><a href="reference/sample_parameters.html">sample_parameters()</a></code> ‚Üí R/sample_parameters.R (301 parameters) - NPE optimization ‚Üí outputs/ subdirectory pattern (100-1200√ó speedup)</p>
<p><strong>File rules:</strong> - ‚úÖ Use <code>./claude/</code> for ALL temporary/exploratory files - ‚úÖ Use <code><a href="reference/get_paths.html">get_paths()</a></code> for ALL file operations (never hardcode paths) - ‚ùå Never modify: laser-cholera/, ees-cholera-mapping/, jhu_cholera_data/ (read-only) - ‚ùå Never modify: MOSAIC-data/raw/ (read-only) - ‚ùå Never create files in package root without necessity</p>
<p><strong>When stuck:</strong> - Check <a href="#id_-common-tasks-step-by-step">Common Tasks</a> for step-by-step guides - Check <a href="#id_-when-things-go-wrong">Troubleshooting</a> for common issues - Check <a href="#id_-why-we-do-this-design-decisions">Design Decisions</a> for context - ASK the user if unclear!</p>
<hr></div>
<div class="section level2">
<h2 id="id_-first-time-on-mosaic">üöÄ First Time on MOSAIC<a class="anchor" aria-label="anchor" href="#id_-first-time-on-mosaic"></a></h2>
<p><strong>You‚Äôre a new Claude instance starting work on MOSAIC. Here‚Äôs what to do FIRST.</strong></p>
<div class="section level3">
<h3 id="step-1-understand-current-state-5-minutes">Step 1: Understand Current State (5 minutes)<a class="anchor" aria-label="anchor" href="#step-1-understand-current-state-5-minutes"></a></h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># What version are we at?</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"^Version:"</span> DESCRIPTION</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co"># Output example: Version: 0.8.7</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co"># What happened recently?</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--oneline</span> <span class="at">-10</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co"># Shows recent commits and their versions</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co"># Read recent changes</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="fu">head</span> <span class="at">-50</span> NEWS.md</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co"># Shows what's been added/fixed recently</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="co"># Any uncommitted work?</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="fu">git</span> status</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co"># Should be clean. If not, ask user before proceeding.</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="co"># Do tests pass? (CRITICAL - establish baseline)</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="co"># All tests should pass. If not, something's wrong - ask user.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-understand-the-task">Step 2: Understand the Task<a class="anchor" aria-label="anchor" href="#step-2-understand-the-task"></a></h3>
<p><strong>Ask yourself:</strong> - [ ] Does this functionality already exist? (219 functions - check first!) - [ ] Is this a bug fix (patch 0.8.7‚Üí0.8.8) or new feature (minor 0.8.7‚Üí0.9.0)? - [ ] Which files will I modify? - [ ] How does this fit into the run_MOSAIC workflow? - [ ] Are there tests I can look at for similar functionality?</p>
<p><strong>Find existing functionality:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Search for similar functions</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">ls</span> R/ <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> <span class="st">"keyword"</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co"># Search code for patterns</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">git</span> grep <span class="st">"pattern"</span> R/</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co"># Check function reference</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"library(MOSAIC); help(package='MOSAIC')"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-read-relevant-context">Step 3: Read Relevant Context<a class="anchor" aria-label="anchor" href="#step-3-read-relevant-context"></a></h3>
<p><strong>For different task types, read these sections:</strong></p>
<table class="table"><colgroup><col width="36%"><col width="63%"></colgroup><thead><tr class="header"><th>Task Type</th>
<th>Read These Sections</th>
</tr></thead><tbody><tr class="odd"><td>Bug in run_MOSAIC</td>
<td>
<a href="#the-run_mosaic-workflow-centerpiece-of-the-package">run_MOSAIC Workflow</a>, <a href="#key-files-reference">Key Files</a>
</td>
</tr><tr class="even"><td>Bug in likelihood</td>
<td>
<a href="#likelihood-calculation">Likelihood Calculation</a>, <a href="#id_5-performance-standards">Performance</a>
</td>
</tr><tr class="odd"><td>Add parameter</td>
<td>
<a href="#parameter-system-architecture">Parameter System</a>, <a href="#common-tasks-step-by-step">Common Tasks</a>
</td>
</tr><tr class="even"><td>Performance issue</td>
<td>
<a href="#critical-npe-performance-optimization">NPE Optimization</a>, <a href="#id_5-performance-standards">Performance Standards</a>
</td>
</tr><tr class="odd"><td>Documentation</td>
<td><a href="#id_7-documentation-standards">Documentation Standards</a></td>
</tr><tr class="even"><td>Any change</td>
<td>
<a href="#working-with-claude-code-development-standards">Development Standards</a> (always!)</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="step-4-plan-before-coding">Step 4: Plan Before Coding<a class="anchor" aria-label="anchor" href="#step-4-plan-before-coding"></a></h3>
<p><strong>Before writing ANY code:</strong> 1. Understand what exists (read relevant files) 2. Understand the design (check <a href="#id_-why-we-do-this-design-decisions">Design Decisions</a>) 3. Plan the approach (think about scale: 40K simulations, 16-32 workers) 4. Write tests first (TDD - test-driven development) 5. Then implement</p>
<p><strong>Red flags that mean ‚Äúask user first‚Äù:</strong> - Need to add new R package dependency - Need to add new Python package - Need to change function signature of exported function - Need to modify run_MOSAIC core loop - Unsure about approach (multiple valid solutions)</p>
</div>
<div class="section level3">
<h3 id="step-5-follow-development-standards">Step 5: Follow Development Standards<a class="anchor" aria-label="anchor" href="#step-5-follow-development-standards"></a></h3>
<p>See <a href="#working-with-claude-code-development-standards">Development Standards</a> for complete checklists.</p>
<p><strong>Core principles:</strong> - ‚úÖ Production-ready code only (no placeholders) - ‚úÖ Test before and after changes - ‚úÖ Bump version on every commit - ‚úÖ Push to remote when done - ‚ùå Never break existing workflows - ‚ùå Never add debug code - ‚ùå Never hardcode paths</p>
<p><strong>Now you‚Äôre ready!</strong> Proceed with your task following the <a href="#working-with-claude-code-development-standards">Development Standards</a>.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_-common-tasks-step-by-step">üìã Common Tasks: Step-by-Step<a class="anchor" aria-label="anchor" href="#id_-common-tasks-step-by-step"></a></h2>
<p>Detailed walkthroughs for common development tasks on MOSAIC.</p>
<div class="section level3">
<h3 id="task-1-fix-a-bug">Task 1: Fix a Bug<a class="anchor" aria-label="anchor" href="#task-1-fix-a-bug"></a></h3>
<p><strong>Test-Driven Development workflow:</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># 1. Create test that reproduces the bug</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> tests/testthat/test-my_bugfix.R <span class="op">&lt;&lt; 'EOF'</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="st">test_that("function handles edge case correctly", {</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="st">  edge_case_input &lt;- c(1, 2, NA, 3)</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="st">  result &lt;- my_function(edge_case_input, na.rm = TRUE)</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="st">  expect_equal(result, expected_value)</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="st">  expect_true(is.finite(result))</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="st">})</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co"># 2. Verify test FAILS (proves it catches the bug)</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"testthat::test_file('tests/testthat/test-my_bugfix.R')"</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co"># 3. Fix the bug in R/my_function.R</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="co"># - Handle NAs, validate inputs, add comments explaining WHY</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="co"># 4. Verify test PASSES</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"testthat::test_file('tests/testthat/test-my_bugfix.R')"</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="co"># 5. Verify ALL tests pass</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a><span class="co"># 6. Update docs if needed</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document()"</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a><span class="co"># 7. Bump version (0.8.7 ‚Üí 0.8.8), commit, push</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a><span class="fu">git</span> add DESCRIPTION R/my_function.R tests/testthat/test-my_bugfix.R</span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">"Fix NA handling in my_function (v0.8.8)</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="st">- Handle NA values explicitly instead of crashing</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a><span class="st">- Add validation and clear error messages</span></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a><span class="st">- Add regression test for NA edge case"</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a><span class="fu">git</span> push origin main</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="task-2-modify-calc_model_likelihood-hot-path">Task 2: Modify calc_model_likelihood() (HOT PATH!)<a class="anchor" aria-label="anchor" href="#task-2-modify-calc_model_likelihood-hot-path"></a></h3>
<p><strong>‚ö†Ô∏è CRITICAL: Called THOUSANDS of times - profile before/after!</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># 1. Understand function: NB likelihood, shape terms, guardrails</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co"># 2. Create performance baseline</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /tmp/test_likelihood_performance.R <span class="op">&lt;&lt; 'EOF'</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="st">library(MOSAIC)</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="st">obs_cases &lt;- matrix(rpois(10*100, 10), nrow=10)</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="st">est_cases &lt;- matrix(rpois(10*100, 10), nrow=10)</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="st">obs_deaths &lt;- matrix(rpois(10*100, 1), nrow=10)</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="st">est_deaths &lt;- matrix(rpois(10*100, 1), nrow=10)</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="st">system.time({</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="st">  for (i in 1:100) {</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="st">    ll &lt;- calc_model_likelihood(obs_cases, est_cases, obs_deaths, est_deaths)</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="st">})</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="ex">Rscript</span> /tmp/test_likelihood_performance.R  <span class="co"># Record baseline</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="co"># 3. Make minimal, focused changes - don't break guardrails</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co"># 4. Test performance - must not regress!</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="ex">Rscript</span> /tmp/test_likelihood_performance.R</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a><span class="co"># 5. Standard workflow: test, document, version bump, commit, push</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><strong>MOSAIC</strong> (Metapopulation Outbreak Simulation And Interventions for Cholera) v0.8.7 is a production-quality R package for simulating cholera transmission dynamics across Sub-Saharan Africa. It integrates with the Python laser-cholera simulation engine (<a href="https://laser-cholera.readthedocs.io" class="external-link uri">https://laser-cholera.readthedocs.io</a>) and provides 219 functions for data processing, parameter estimation, Bayesian calibration, and visualization.</p>
<p><strong>Key Capabilities:</strong> - Cholera transmission simulation using metapopulation SEIR models - Neural Posterior Estimation (NPE) for Bayesian calibration - Environmental suitability modeling with climate forcing - Vaccination and WASH intervention analysis - Spatial transmission dynamics with human mobility</p>
</div>
<div class="section level2">
<h2 id="critical-file-management-rules">Critical File Management Rules<a class="anchor" aria-label="anchor" href="#critical-file-management-rules"></a></h2>
<div class="section level3">
<h3 id="never-create-files-in-package-root-without-necessity">NEVER Create Files in Package Root Without Necessity<a class="anchor" aria-label="anchor" href="#never-create-files-in-package-root-without-necessity"></a></h3>
<p><strong>MOSAIC-pkg is a standard R package sensitive to unwanted files.</strong> Always follow these rules:</p>
<ol style="list-style-type: decimal"><li><strong>Use <code>./claude/</code> for ALL temporary, exploratory, or analysis files</strong></li>
<li>
<strong>Only create files in these locations when essential:</strong>
<ul><li>
<code>R/</code> - New R function files (follow naming conventions)</li>
<li>
<code>tests/testthat/</code> - New test files (prefix with <code>test-</code>)</li>
<li>
<code>man/</code> - Auto-generated documentation (via roxygen2)</li>
<li>
<code>data/</code> - Package data objects (.rda files)</li>
<li>Files explicitly requested by user</li>
</ul></li>
<li>
<strong>Before creating ANY file, ask:</strong>
<ul><li>Is this essential for R package functionality?</li>
<li>Has the user explicitly requested this file?</li>
<li>Can this go in <code>./claude/</code> instead?</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="claude-directory-conventions">Claude Directory Conventions<a class="anchor" aria-label="anchor" href="#claude-directory-conventions"></a></h3>
<p>When creating files in <code>./claude/</code>: - <strong>Development plans</strong>: <code>plan_*.md</code> - <strong>Analysis reports</strong>: Descriptive names with context - <strong>Bug summaries</strong>: Include issue type (e.g., <code>na_bugs_summary.md</code>) - <strong>Feature docs</strong>: Clear descriptive names</p>
</div>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="multi-repository-structure">Multi-Repository Structure<a class="anchor" aria-label="anchor" href="#multi-repository-structure"></a></h3>
<pre><code>MOSAIC/                          # Root (set via set_root_directory())
‚îú‚îÄ‚îÄ MOSAIC-pkg/                  # THIS PACKAGE (EDITABLE)
‚îÇ   ‚îú‚îÄ‚îÄ R/                       # 219 function files
‚îÇ   ‚îú‚îÄ‚îÄ tests/testthat/          # 38 test files
‚îÇ   ‚îú‚îÄ‚îÄ inst/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ extdata/             # Default parameters (JSON, 3.9 MB)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ py/                  # Python environment.yml
‚îÇ   ‚îú‚îÄ‚îÄ data/                    # R data objects (.rda)
‚îÇ   ‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input/               # LASER model inputs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ output/              # LASER model outputs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LAUNCH.R             # Main workflow pipeline
‚îÇ   ‚îú‚îÄ‚îÄ claude/                  # USE THIS for temporary files
‚îÇ   ‚îú‚îÄ‚îÄ man/                     # Auto-generated documentation
‚îÇ   ‚îî‚îÄ‚îÄ DESCRIPTION              # Package metadata
‚îú‚îÄ‚îÄ MOSAIC-data/                 # Data repository (EDITABLE)
‚îÇ   ‚îú‚îÄ‚îÄ raw/                     # READ-ONLY - never modify
‚îÇ   ‚îî‚îÄ‚îÄ processed/               # Output from processing functions
‚îú‚îÄ‚îÄ MOSAIC-docs/                 # Documentation website (EDITABLE)
‚îÇ   ‚îú‚îÄ‚îÄ figures/                 # Output from plot_*() functions
‚îÇ   ‚îî‚îÄ‚îÄ tables/                  # Output tables
‚îú‚îÄ‚îÄ laser-cholera/               # Python simulation engine (READ-ONLY)
‚îÇ                                # Docs: https://laser-cholera.readthedocs.io
‚îú‚îÄ‚îÄ ees-cholera-mapping/         # Web scraping tools (READ-ONLY)
‚îî‚îÄ‚îÄ jhu_cholera_data/            # JHU scraper (READ-ONLY)</code></pre>
</div>
<div class="section level3">
<h3 id="files-ignored-by-r-cmd-check-rbuildignore">Files Ignored by R CMD check (.Rbuildignore)<a class="anchor" aria-label="anchor" href="#files-ignored-by-r-cmd-check-rbuildignore"></a></h3>
<p>These directories are excluded from package builds: - <code>deprecated/</code>, <code>data-raw/</code>, <code>local/</code>, <code>azure/</code>, <code>model/</code>, <code>src/</code> - <code>docs/</code>, <code>pkgdown/</code>, <code>vignettes/articles</code>, <code>.github</code>, <code>claude/</code></p>
</div>
</div>
<div class="section level2">
<h2 id="the-run_mosaic-workflow-centerpiece-of-the-package">The run_MOSAIC Workflow: Centerpiece of the Package<a class="anchor" aria-label="anchor" href="#the-run_mosaic-workflow-centerpiece-of-the-package"></a></h2>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h3>
<p>The <code><a href="reference/run_MOSAIC.html">run_MOSAIC()</a></code> / <code>run_mosaic_iso()</code> workflow is <strong>the centerpiece of the MOSAIC package</strong>. It orchestrates the complete Bayesian calibration pipeline from prior sampling through posterior estimation. This is a production-quality implementation spanning 4,243 lines across 3 files.</p>
<p><strong>Files:</strong> - <code>R/run_MOSAIC.R</code> (2,856 lines) - Main workflow and public API - <code>R/run_MOSAIC_helpers.R</code> (1,037 lines) - Internal helpers and validation - <code>R/run_MOSAIC_infrastructure.R</code> (350 lines) - Directory setup and I/O</p>
</div>
<div class="section level3">
<h3 id="two-user-interfaces">Two User Interfaces<a class="anchor" aria-label="anchor" href="#two-user-interfaces"></a></h3>
<div class="section level4">
<h4 id="id_1-simple-interface-run_mosaic_iso">1. Simple Interface: <code>run_mosaic_iso()</code>
<a class="anchor" aria-label="anchor" href="#id_1-simple-interface-run_mosaic_iso"></a></h4>
<p><strong>Recommended for most users.</strong> Automatically loads defaults for specified countries.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Single location</span></span>
<span><span class="fu">run_mosaic_iso</span><span class="op">(</span></span>
<span>  iso_code <span class="op">=</span> <span class="st">"ETH"</span>,</span>
<span>  dir_output <span class="op">=</span> <span class="st">"./output/eth_calibration"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Multiple locations</span></span>
<span><span class="fu">run_mosaic_iso</span><span class="op">(</span></span>
<span>  iso_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ETH"</span>, <span class="st">"KEN"</span>, <span class="st">"TZA"</span><span class="op">)</span>,</span>
<span>  dir_output <span class="op">=</span> <span class="st">"./output/east_africa"</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="reference/mosaic_control_defaults.html">mosaic_control_defaults</a></span><span class="op">(</span></span>
<span>    parallel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>enable <span class="op">=</span> <span class="cn">TRUE</span>, n_cores <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="id_2-advanced-interface-run_mosaic">2. Advanced Interface: <code>run_MOSAIC()</code>
<a class="anchor" aria-label="anchor" href="#id_2-advanced-interface-run_mosaic"></a></h4>
<p><strong>Full control over model specification.</strong> Accepts custom config and priors.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load and customize config</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_location_config.html">get_location_config</a></span><span class="op">(</span>iso <span class="op">=</span> <span class="st">"ETH"</span><span class="op">)</span></span>
<span><span class="va">config</span><span class="op">$</span><span class="va">date_start</span> <span class="op">&lt;-</span> <span class="st">"2020-01-01"</span></span>
<span><span class="va">config</span><span class="op">$</span><span class="va">date_stop</span> <span class="op">&lt;-</span> <span class="st">"2024-12-31"</span></span>
<span></span>
<span><span class="co"># Load and customize priors</span></span>
<span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_location_priors.html">get_location_priors</a></span><span class="op">(</span>iso <span class="op">=</span> <span class="st">"ETH"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run with custom settings</span></span>
<span><span class="fu"><a href="reference/run_MOSAIC.html">run_MOSAIC</a></span><span class="op">(</span></span>
<span>  config <span class="op">=</span> <span class="va">config</span>,</span>
<span>  priors <span class="op">=</span> <span class="va">priors</span>,</span>
<span>  dir_output <span class="op">=</span> <span class="st">"./output/custom_run"</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="reference/mosaic_control_defaults.html">mosaic_control_defaults</a></span><span class="op">(</span></span>
<span>    calibration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_simulations <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>      n_iterations <span class="op">=</span> <span class="fl">5</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="workflow-stages">Workflow Stages<a class="anchor" aria-label="anchor" href="#workflow-stages"></a></h3>
<p>The workflow executes two main stages:</p>
<div class="section level4">
<h4 id="stage-1-bayesian-filtering-with-resampling-bfrs"><strong>STAGE 1: Bayesian Filtering with Resampling (BFRS)</strong><a class="anchor" aria-label="anchor" href="#stage-1-bayesian-filtering-with-resampling-bfrs"></a></h4>
<p>Three-phase adaptive calibration:</p>
<p><strong>Phase 1: Adaptive Calibration</strong> - Runs batches until convergence (R¬≤ target achieved) - <strong>Auto mode</strong> (default): <code>n_simulations = NULL</code> - Adaptive batch sizing based on convergence - Stops when <code>target_r2</code> reached (default 0.5) - Monitors ESS (Effective Sample Size) per parameter - <strong>Fixed mode</strong>: <code>n_simulations = 5000</code> - Runs exact number specified - No early stopping</p>
<p><strong>Phase 2: Single Predictive Batch</strong> - Size calculated from calibration phase - Generates samples for posterior inference - Uses importance sampling with weights from Phase 1</p>
<p><strong>Phase 3: Adaptive Fine-tuning</strong> - 5-tier batch sizing system: - <strong>Massive</strong>: 20,000 simulations - <strong>Large</strong>: 10,000 simulations - <strong>Standard</strong>: 5,000 simulations - <strong>Precision</strong>: 2,500 simulations - <strong>Final</strong>: 1,000 simulations - Tier selected based on convergence metrics - Refines posterior around high-likelihood regions</p>
<p><strong>Outputs:</strong> Results are written to <code>dir_output/1_bfrs/</code> with parameter files, simulation outputs, and convergence diagnostics.</p>
<p><strong>Note:</strong> Output directory structure is subject to change as the package evolves.</p>
</div>
<div class="section level4">
<h4 id="stage-2-neural-posterior-estimation-npe-optional">
<strong>STAGE 2: Neural Posterior Estimation (NPE)</strong> <em>(Optional)</em>
<a class="anchor" aria-label="anchor" href="#stage-2-neural-posterior-estimation-npe-optional"></a></h4>
<ul><li>
<strong>When enabled:</strong> <code>control$npe$enable = TRUE</code>
</li>
<li>Trains normalizing flow model on BFRS results</li>
<li>Provides fast posterior sampling without additional simulations</li>
<li>Uses PyTorch/Zuko for neural density estimation</li>
</ul><p><strong>Outputs:</strong> Results are written to <code>dir_output/2_npe/</code> with trained model, posterior samples, and diagnostics.</p>
</div>
</div>
<div class="section level3">
<h3 id="control-structure">Control Structure<a class="anchor" aria-label="anchor" href="#control-structure"></a></h3>
<p>Created with <code><a href="reference/mosaic_control_defaults.html">mosaic_control_defaults()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/mosaic_control_defaults.html">mosaic_control_defaults</a></span><span class="op">(</span></span>
<span>  <span class="co"># === CALIBRATION SETTINGS ===</span></span>
<span>  calibration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n_simulations <span class="op">=</span> <span class="cn">NULL</span>,          <span class="co"># NULL = auto mode, integer = fixed mode</span></span>
<span>    n_iterations <span class="op">=</span> <span class="fl">3</span>,              <span class="co"># LASER iterations per simulation</span></span>
<span>    max_simulations <span class="op">=</span> <span class="fl">100000</span>,      <span class="co"># Safety limit for auto mode</span></span>
<span>    batch_size <span class="op">=</span> <span class="fl">1000</span>,             <span class="co"># Simulations per batch</span></span>
<span>    min_batches <span class="op">=</span> <span class="fl">3</span>,               <span class="co"># Minimum batches before convergence check</span></span>
<span>    max_batches <span class="op">=</span> <span class="fl">100</span>,             <span class="co"># Maximum batches in auto mode</span></span>
<span>    target_r2 <span class="op">=</span> <span class="fl">0.5</span>                <span class="co"># R¬≤ convergence threshold</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># === PARAMETER SAMPLING ===</span></span>
<span>  sampling <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sample_tau_i <span class="op">=</span> <span class="cn">TRUE</span>,           <span class="co"># Sample diffusion parameter</span></span>
<span>    sample_beta_j0_tot <span class="op">=</span> <span class="cn">TRUE</span>,     <span class="co"># Sample transmission rate</span></span>
<span>    sample_p_beta <span class="op">=</span> <span class="cn">TRUE</span>,          <span class="co"># Sample H2H proportion</span></span>
<span>    sample_theta_j <span class="op">=</span> <span class="cn">TRUE</span>,         <span class="co"># Sample WASH coverage</span></span>
<span>    sample_mu_j <span class="op">=</span> <span class="cn">TRUE</span>,            <span class="co"># Sample case fatality ratio</span></span>
<span>    <span class="co"># ... (see sample_parameters.R for all 34 parameters)</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># === PARALLELIZATION ===</span></span>
<span>  parallel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    enable <span class="op">=</span> <span class="cn">FALSE</span>,                <span class="co"># Set TRUE for cluster execution</span></span>
<span>    n_cores <span class="op">=</span> <span class="fl">1</span>,                   <span class="co"># Number of parallel workers</span></span>
<span>    type <span class="op">=</span> <span class="st">"PSOCK"</span>,                <span class="co"># "PSOCK" or "FORK"</span></span>
<span>    progress <span class="op">=</span> <span class="cn">TRUE</span>                <span class="co"># Show progress bar</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># === CONVERGENCE TARGETS ===</span></span>
<span>  targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    ESS_param <span class="op">=</span> <span class="fl">100</span>,               <span class="co"># Target ESS per parameter</span></span>
<span>    ESS_param_prop <span class="op">=</span> <span class="fl">0.1</span>,          <span class="co"># Proportion threshold (10%)</span></span>
<span>    ESS_best <span class="op">=</span> <span class="fl">50</span>,                 <span class="co"># Target for top-weighted samples</span></span>
<span>    A_best <span class="op">=</span> <span class="fl">0.01</span>,                 <span class="co"># Proportion for "best" (top 1%)</span></span>
<span>    CVw_best <span class="op">=</span> <span class="fl">2.0</span>,                <span class="co"># CV of weights threshold</span></span>
<span>    percentile_max <span class="op">=</span> <span class="fl">99</span>            <span class="co"># Percentile for fine-tuning</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># === FINE-TUNING ===</span></span>
<span>  fine_tuning <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    batch_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      massive <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>      large <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>      standard <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>      precision <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>      final <span class="op">=</span> <span class="fl">1000</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># === NEURAL POSTERIOR ESTIMATION ===</span></span>
<span>  npe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    enable <span class="op">=</span> <span class="cn">FALSE</span>,                <span class="co"># Set TRUE to enable NPE stage</span></span>
<span>    weight_strategy <span class="op">=</span> <span class="st">"quantile"</span>,  <span class="co"># or "threshold"</span></span>
<span>    quantile <span class="op">=</span> <span class="fl">0.95</span>                <span class="co"># Use top 5% of weighted samples</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># === LIKELIHOOD CALCULATION ===</span></span>
<span>  likelihood <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    add_max_terms <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    add_peak_timing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    add_peak_magnitude <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    add_cumulative_total <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    add_wis <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    weight_cases <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>    weight_deaths <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>    weight_max_terms <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    weight_peak_timing <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    weight_peak_magnitude <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    weight_cumulative_total <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>    weight_wis <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    enable_guardrails <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    floor_likelihood <span class="op">=</span> <span class="op">-</span><span class="fl">999999999</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># === I/O SETTINGS ===</span></span>
<span>  io <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    format <span class="op">=</span> <span class="st">"parquet"</span>,            <span class="co"># "parquet" or "csv"</span></span>
<span>    compression <span class="op">=</span> <span class="st">"zstd"</span>,          <span class="co"># "none", "snappy", "gzip", "lz4", "zstd"</span></span>
<span>    compression_level <span class="op">=</span> <span class="fl">10</span>         <span class="co"># 1-22 for zstd</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulation-worker-architecture">Simulation Worker Architecture<a class="anchor" aria-label="anchor" href="#simulation-worker-architecture"></a></h3>
<p><strong>Key Features:</strong> - <strong>Reproducible seeding scheme</strong>: - <code>seed_sim = sim_id</code> (parameters) - <code>seed_iter = (sim_id - 1) * n_iterations + j</code> (LASER model) - <strong>Iteration collapsing</strong>: Multiple LASER runs averaged via log-mean-exp - <strong>Memory management</strong>: Explicit garbage collection to prevent Python object buildup - <strong>Error handling</strong>: Graceful failure without crashing entire batch</p>
<p><strong>Located:</strong> <code>R/run_MOSAIC.R</code> lines 29-281 (<code>.mosaic_run_simulation_worker()</code>)</p>
</div>
<div class="section level3">
<h3 id="parallel-execution">Parallel Execution<a class="anchor" aria-label="anchor" href="#parallel-execution"></a></h3>
<p><strong>CRITICAL Thread Safety:</strong></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Each worker limited to single-threaded BLAS</span></span>
<span><span class="fu">MOSAIC</span><span class="fu">:::</span><span class="fu">.mosaic_set_blas_threads</span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Without this:</span></span>
<span><span class="co"># 16 workers √ó 8 BLAS threads = 128 total (severe oversubscription!)</span></span>
<span><span class="co"># With this:</span></span>
<span><span class="co"># 16 workers √ó 1 BLAS thread = 16 threads (optimal!)</span></span></code></pre></div>
<p><strong>Cluster Types:</strong> - <strong>PSOCK</strong> (default): Works on all platforms, requires explicit export - <strong>FORK</strong> (Linux/Mac): Faster startup, shares memory</p>
<p><strong>Setup:</strong> <code>R/run_MOSAIC.R</code> lines 757-826</p>
</div>
<div class="section level3">
<h3 id="adaptive-convergence-detection">Adaptive Convergence Detection<a class="anchor" aria-label="anchor" href="#adaptive-convergence-detection"></a></h3>
<p><strong>Metrics monitored:</strong> - <strong>R¬≤ (correlation)</strong>: Model fit to observed data - <strong>ESS (Effective Sample Size)</strong>: Per parameter and overall - <strong>CVw (Coefficient of Variation of Weights)</strong>: Weight distribution quality - <strong>A_best</strong>: Proportion of high-quality samples</p>
<p><strong>Early stopping when:</strong> - R¬≤ ‚â• <code>target_r2</code> (default 0.5) - ESS meets target (default 100 per parameter) - CVw_best &lt; 2.0 (well-distributed weights)</p>
<p><strong>Located:</strong> <code>R/run_MOSAIC_helpers.R</code> (<code>.mosaic_check_convergence()</code>)</p>
</div>
<div class="section level3">
<h3 id="output-structure">Output Structure<a class="anchor" aria-label="anchor" href="#output-structure"></a></h3>
<p><strong>Main directories:</strong> - <code>dir_output/1_bfrs/</code> - Stage 1 calibration results (parameters, simulations, diagnostics) - <code>dir_output/2_npe/</code> - Stage 2 NPE results (if enabled) - <code>dir_output/results/</code> - Final posterior summaries and visualizations</p>
<p><strong>Note:</strong> Specific file structure is subject to change as the package evolves. Use functions like <code>read_calibration_results()</code> rather than hardcoding file paths.</p>
</div>
<div class="section level3">
<h3 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a></h3>
<p><strong>Batch Size:</strong> - Too small: Overhead dominates, slow convergence - Too large: Memory issues, long iteration times - <strong>Recommended</strong>: 500-2000 simulations per batch</p>
<p><strong>Iterations per Simulation:</strong> - <code>n_iterations = 1</code>: Fastest, but noisier likelihood estimates - <code>n_iterations = 3</code>: Good balance (default) - <code>n_iterations = 5+</code>: More stable, but slower</p>
<p><strong>Parallel Scaling:</strong> - Linear speedup up to ~32 cores (depends on batch size) - Beyond 32 cores: Diminishing returns due to overhead - <strong>Best practice</strong>: <code>batch_size</code> ‚â• <code>n_cores</code> for efficiency</p>
<p><strong>Memory Usage:</strong> - ~1-2 GB per worker (LASER simulations) - Scale accordingly: 16 cores ‚âà 32 GB RAM - NPE training: Additional 4-8 GB for PyTorch</p>
</div>
</div>
<div class="section level2">
<h2 id="function-organization-219-files">Function Organization (219 Files)<a class="anchor" aria-label="anchor" href="#function-organization-219-files"></a></h2>
<div class="section level3">
<h3 id="naming-conventions">Naming Conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a></h3>
<p>Functions follow strict prefixes indicating their purpose:</p>
<table class="table"><colgroup><col width="23%"><col width="26%"><col width="20%"><col width="29%"></colgroup><thead><tr class="header"><th>Prefix</th>
<th>Purpose</th>
<th>Count</th>
<th>Examples</th>
</tr></thead><tbody><tr class="odd"><td><code>process_*()</code></td>
<td>Data cleaning &amp; preprocessing</td>
<td>25</td>
<td>
<code><a href="reference/process_WHO_weekly_data.html">process_WHO_weekly_data()</a></code>, <code><a href="reference/process_climate_data.html">process_climate_data()</a></code>
</td>
</tr><tr class="even"><td><code>est_*()</code></td>
<td>Parameter estimation</td>
<td>18</td>
<td>
<code><a href="reference/est_initial_E_I.html">est_initial_E_I()</a></code>, <code><a href="reference/est_vaccination_rate.html">est_vaccination_rate()</a></code>, <code><a href="reference/est_WASH_coverage.html">est_WASH_coverage()</a></code>
</td>
</tr><tr class="odd"><td><code>plot_*()</code></td>
<td>Visualization &amp; figures</td>
<td>30+</td>
<td>
<code><a href="reference/plot_model_ppc.html">plot_model_ppc()</a></code>, <code><a href="reference/plot_vaccination_maps.html">plot_vaccination_maps()</a></code>, <code><a href="reference/plot_model_convergence.html">plot_model_convergence()</a></code>
</td>
</tr><tr class="even"><td><code>get_*()</code></td>
<td>Data retrieval &amp; utilities</td>
<td>25+</td>
<td>
<code><a href="reference/get_paths.html">get_paths()</a></code>, <code><a href="reference/get_climate_historical.html">get_climate_historical()</a></code>, <code><a href="reference/get_WASH_data.html">get_WASH_data()</a></code>
</td>
</tr><tr class="odd"><td><code>calc_*()</code></td>
<td>Mathematical calculations</td>
<td>25+</td>
<td>
<code><a href="reference/calc_model_likelihood.html">calc_model_likelihood()</a></code>, <code><a href="reference/calc_spatial_correlation.html">calc_spatial_correlation()</a></code>
</td>
</tr><tr class="even"><td><code>check_*()</code></td>
<td>Validation &amp; verification</td>
<td>5</td>
<td>
<code><a href="reference/check_dependencies.html">check_dependencies()</a></code>, <code><a href="reference/check_affine_normalization.html">check_affine_normalization()</a></code>
</td>
</tr><tr class="odd"><td><code>sample_*()</code></td>
<td>Parameter sampling</td>
<td>2</td>
<td>
<code><a href="reference/sample_parameters.html">sample_parameters()</a></code>, <code><a href="reference/sample_from_prior.html">sample_from_prior()</a></code>
</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="function-categories-by-purpose">Function Categories by Purpose<a class="anchor" aria-label="anchor" href="#function-categories-by-purpose"></a></h3>
<p><strong>Core LASER Integration:</strong> - <code>run_LASER.R</code> - Wrapper for Python laser-cholera simulations (68 lines) - <code>make_LASER_config.R</code> - Config validation &amp; creation (897 lines, validates 60+ parameters) - <code>get_default_LASER_config.R</code> - Retrieve default configurations</p>
<p><strong>Run MOSAIC Workflow (CENTERPIECE):</strong> - <code>run_MOSAIC.R</code> - Main calibration workflow (2,856 lines) - <code>run_MOSAIC_helpers.R</code> - Internal helpers (1,037 lines) - <code>run_MOSAIC_infrastructure.R</code> - Directory setup (350 lines)</p>
<p><strong>Neural Posterior Estimation (NPE):</strong> - <code>npe.R</code> - Main NPE workflow (train_npe, sample_posterior, etc.) - <code>npe_utils.R</code> - Helper functions for data preparation - <code>npe_diagnostics.R</code> - Convergence &amp; quality checks - <code>npe_plots.R</code> - Posterior visualization - <code>npe_posterior.R</code> - Posterior sampling &amp; analysis - <code>calc_npe_diagnostics.R</code> - Quantitative diagnostics</p>
<p><strong>Parameter System:</strong> - <code>sample_parameters.R</code> - Sample from priors (301 parameters: 21 global + 280 location-specific) - <code>priors_default.R</code> - Documentation for default priors - Initial condition estimation: <code>est_initial_S.R</code>, <code>est_initial_E_I.R</code>, <code>est_initial_R.R</code>, <code>est_initial_V1_V2.R</code></p>
<p><strong>Likelihood &amp; Model Evaluation:</strong> - <code>calc_model_likelihood.R</code> - Multi-component likelihood (NB + shape terms + guardrails) - <code>calc_model_convergence.R</code> - MCMC convergence diagnostics - <code>calc_model_posterior_distributions.R</code> - Posterior summaries - <code>calc_model_weights_gibbs.R</code> - Importance weight calculation - <code>calc_model_ess.R</code> - Effective sample size</p>
<p><strong>Data Processing Pipeline:</strong> - Climate: <code>download_climate_data.R</code>, <code>process_climate_data.R</code> - Surveillance: <code>process_WHO_weekly_data.R</code>, <code>process_JHU_data.R</code>, <code>process_SUPP_data.R</code> - Demographics: <code>process_UN_demographics_data.R</code>, <code>est_demographic_rates.R</code> - Vaccination: <code>process_WHO_vaccination_data.R</code>, <code>est_vaccination_rate.R</code> - WASH: <code>get_WASH_data.R</code>, <code>est_WASH_coverage.R</code></p>
<p><strong>Visualization:</strong> - Model diagnostics: <code>plot_model_ppc.R</code>, <code>plot_model_convergence.R</code>, <code>plot_model_fit_stochastic.R</code> - Spatial: <code>plot_mosaic_country_map.R</code>, <code>plot_vaccination_maps.R</code>, <code>plot_mobility.R</code> - Parameters: <code>plot_seasonal_transmission.R</code>, <code>plot_shedding_rate.R</code>, <code>plot_vibrio_decay_rate.R</code></p>
<p><strong>Utilities:</strong> - <code>get_paths.R</code> - Directory structure management (CRITICAL for all file operations) - <code>set_root_directory.R</code> - Set MOSAIC root directory - ISO code conversions: 8 files for geographic coding</p>
<p><strong>Python Environment:</strong> - <code>install_dependencies.R</code> - Set up conda environment from <code>inst/py/environment.yml</code> - <code>check_dependencies.R</code> - Comprehensive diagnostics with capability checks - <code>remove_MOSAIC_python_env.R</code> - Cleanup for troubleshooting - <code>check_python_env.R</code>, <code>lock_python_env.R</code>, <code>get_python_paths.R</code></p>
</div>
</div>
<div class="section level2">
<h2 id="key-data-objects">Key Data Objects<a class="anchor" aria-label="anchor" href="#key-data-objects"></a></h2>
<div class="section level3">
<h3 id="package-data-datarda---17-files">Package Data (<code>data/*.rda</code> - 17 files)<a class="anchor" aria-label="anchor" href="#package-data-datarda---17-files"></a></h3>
<p><strong>Configurations:</strong> - <code>config_default.rda</code> - Default LASER configuration (158 KB) - <code>config_simulation_endemic.rda</code> - 5-year endemic simulation - <code>config_simulation_epidemic.rda</code> - 1-year outbreak simulation</p>
<p><strong>Parameters:</strong> - <code>priors_default.rda</code> - Prior distributions for 301 parameters (9.7 KB) - <code>estimated_parameters.rda</code> - Literature-derived estimates</p>
<p><strong>Geographic:</strong> - <code>iso_codes_africa.rda</code>, <code>iso_codes_ssa.rda</code>, <code>iso_codes_who_afro.rda</code> - <code>iso_codes_africa_{north,west,east,central,south}.rda</code> - <code>iso_codes_mosaic.rda</code> - 40 countries used in MOSAIC</p>
<p><strong>Outbreak Data:</strong> - <code>epidemic_peaks.rda</code> - Historical outbreak timing data</p>
</div>
<div class="section level3">
<h3 id="external-data-instextdata">External Data (<code>inst/extdata/</code>)<a class="anchor" aria-label="anchor" href="#external-data-instextdata"></a></h3>
<ul><li>
<code>default_parameters.json</code> - Full parameter file (3.9 MB, 133 KB compressed)</li>
<li>
<code>priors_default.json</code> - JSON format priors (147 KB)</li>
<li>
<code>sim_endemic_parameters.json</code> - Endemic simulation config (297 KB)</li>
<li>
<code>enso_forecast_current.json</code>, <code>dmi_forecast_current.json</code> - Hardcoded climate fallbacks</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="python-integration">Python Integration<a class="anchor" aria-label="anchor" href="#python-integration"></a></h2>
<div class="section level3">
<h3 id="environment-setup">Environment Setup<a class="anchor" aria-label="anchor" href="#environment-setup"></a></h3>
<p><strong>Location:</strong> <code>~/.virtualenvs/r-mosaic</code> (fixed path)</p>
<p><strong>Three capability tiers:</strong> 1. <strong>Core</strong> (required): laser-cholera, laser-core, numpy, h5py, pyarrow 2. <strong>Suitability</strong> (optional): tensorflow, keras 3. <strong>NPE</strong> (optional): torch, sbi, lampe, zuko, scikit-learn</p>
<p><strong>Install/Check:</strong></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First time setup</span></span>
<span><span class="fu">MOSAIC</span><span class="fu">::</span><span class="fu"><a href="reference/install_dependencies.html">install_dependencies</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check installation</span></span>
<span><span class="fu">MOSAIC</span><span class="fu">::</span><span class="fu"><a href="reference/check_dependencies.html">check_dependencies</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Troubleshooting</span></span>
<span><span class="fu">MOSAIC</span><span class="fu">::</span><span class="fu">remove_MOSAIC_python_env</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">MOSAIC</span><span class="fu">::</span><span class="fu"><a href="reference/install_dependencies.html">install_dependencies</a></span><span class="op">(</span>force <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="critical-thread-safety">Critical: Thread Safety<a class="anchor" aria-label="anchor" href="#critical-thread-safety"></a></h3>
<p><strong>ALWAYS set BLAS threads to 1 before importing PyTorch</strong> to prevent cluster deadlocks:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This is built into train_npe() but critical for custom PyTorch usage</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">".mosaic_set_blas_threads"</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"MOSAIC"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">MOSAIC</span><span class="fu">:::</span><span class="fu">.mosaic_set_blas_threads</span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span></span>
<span>  OMP_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>  MKL_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>  OPENBLAS_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>  NUMEXPR_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Then import</span></span>
<span><span class="va">torch</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/import.html" class="external-link">import</a></span><span class="op">(</span><span class="st">"torch"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Why:</strong> PyTorch initializes BLAS/MKL on import. If R has already set BLAS threads differently, this causes deadlocks on clusters.</p>
</div>
<div class="section level3">
<h3 id="laser-model-integration">LASER Model Integration<a class="anchor" aria-label="anchor" href="#laser-model-integration"></a></h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import laser-cholera</span></span>
<span><span class="va">lc</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/import.html" class="external-link">import</a></span><span class="op">(</span><span class="st">"laser_cholera"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run model directly</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">lc</span><span class="op">$</span><span class="va">metapop</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="fu">run_model</span><span class="op">(</span></span>
<span>  paramfile <span class="op">=</span> <span class="st">"config.json"</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123L</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or use wrapper (recommended)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/run_LASER.html">run_LASER</a></span><span class="op">(</span></span>
<span>  paramfile <span class="op">=</span> <span class="st">"config.json"</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123L</span>,</span>
<span>  visualize <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="parameter-system-architecture">Parameter System Architecture<a class="anchor" aria-label="anchor" href="#parameter-system-architecture"></a></h2>
<div class="section level3">
<h3 id="total-301-parameters">Total: 301 Parameters<a class="anchor" aria-label="anchor" href="#total-301-parameters"></a></h3>
<p><strong>21 Global Parameters:</strong> - <strong>Transmission:</strong> alpha_1, alpha_2, beta dynamics - <strong>Disease progression:</strong> iota (incubation), gamma_1/gamma_2 (recovery), epsilon (immunity waning) - <strong>Vaccination:</strong> phi_1/phi_2 (effectiveness), omega_1/omega_2 (waning) - <strong>Environment:</strong> decay_days_short/long, decay_shape_1/2, zeta_1/zeta_2, kappa - <strong>Observation:</strong> rho (reporting), sigma (symptomatic proportion) - <strong>Mobility:</strong> mobility_gamma, mobility_omega</p>
<p><strong>280 Location-Specific (40 countries √ó 7 params):</strong> - <code>beta_j0_tot</code> - Total baseline transmission rate - <code>p_beta</code> - Proportion human-to-human transmission - <code>tau_i</code> - Travel/diffusion probability - <code>theta_j</code> - WASH coverage (proportion with adequate WASH) - <code>mu_j</code> - Case fatality ratio - <code>a1, a2, b1, b2</code> - Seasonality Fourier coefficients - <code>psi_star_a, psi_star_b, psi_star_z, psi_star_k</code> - Suitability calibration</p>
<p><strong>6 Initial Conditions (per location):</strong> - <code>S_j_initial</code>, <code>E_j_initial</code>, <code>I_j_initial</code>, <code>R_j_initial</code>, <code>V1_j_initial</code>, <code>V2_j_initial</code></p>
</div>
<div class="section level3">
<h3 id="prior-distributions">Prior Distributions<a class="anchor" aria-label="anchor" href="#prior-distributions"></a></h3>
<p><strong>Default priors in <code>priors_default.rda</code> / <code>inst/extdata/priors_default.json</code></strong></p>
<p><strong>Initial Conditions (Beta distributions for epidemiological realism):</strong> - S (Susceptible): Beta(30, 7.5) ‚Üí 80% mean - V1 (One dose): Beta(0.5, 49.5) ‚Üí 1% mean - V2 (Two doses): Beta(0.5, 99.5) ‚Üí 0.5% mean - E (Exposed): Beta(0.01, 9999.99) ‚Üí 0.0001% mean - I (Infected): Beta(0.01, 9999.99) ‚Üí 0.0001% mean - R (Recovered): Beta(3.5, 14) ‚Üí 20% mean</p>
<p><strong>Transmission Parameters:</strong> - alpha_1: Beta distribution (range 0-1) - alpha_2: Beta distribution (range 0-1) - beta_j0_hum/env: Gamma distributions (country-specific)</p>
<p><strong>Disease Progression:</strong> - iota: Lognormal distribution - gamma_1: Uniform(1/7, 1/3) day‚Åª¬π - gamma_2: Uniform(1/14, 1/7) day‚Åª¬π - epsilon: Lognormal distribution</p>
</div>
</div>
<div class="section level2">
<h2 id="likelihood-calculation">Likelihood Calculation<a class="anchor" aria-label="anchor" href="#likelihood-calculation"></a></h2>
<div class="section level3">
<h3 id="calc_model_likelihood-architecture">calc_model_likelihood() Architecture<a class="anchor" aria-label="anchor" href="#calc_model_likelihood-architecture"></a></h3>
<p><strong>Located:</strong> <code>R/calc_model_likelihood.R</code></p>
<p><strong>Core Component:</strong> Negative Binomial time-series likelihood - Per location and outcome (cases, deaths) - Weighted MoM dispersion estimation with k_min floor (default 3) - Handles NA values gracefully</p>
<p><strong>Shape Terms (optional, with default weights):</strong> 1. <strong>Multi-peak timing</strong> (weight 0.5): Normal likelihood on time differences between matched peaks 2. <strong>Multi-peak magnitude</strong> (weight 0.5): Log-Normal on peak ratio with adaptive sigma 3. <strong>Cumulative progression</strong> (weight 0.3): NB at fractions [0.25, 0.5, 0.75, 1.0] 4. <strong>Max terms</strong> (weight 0.5): Legacy Poisson maxima (default ON) 5. <strong>WIS</strong> (weight 0.8): Weighted Interval Score across quantiles (default ON)</p>
<p><strong>Guardrails (enabled by default):</strong> - Cumulative over-prediction: <code>sum(est) / sum(obs) &gt; 10</code> ‚Üí floor - Cumulative under-prediction: <code>sum(est) / sum(obs) &lt; 0.1</code> ‚Üí floor - Per-timestep max ratio: <code>est[i] / obs[i] &gt; 100</code> ‚Üí floor - Per-timestep min ratio: <code>est[i] / obs[i] &lt; 0.01</code> ‚Üí floor - Negative correlation: <code>cor(est, obs) &lt; 0</code> ‚Üí floor - Returns <code>floor_likelihood = -999999999</code> on violations</p>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/calc_model_likelihood.html">calc_model_likelihood</a></span><span class="op">(</span></span>
<span>  obs_cases <span class="op">=</span> <span class="va">obs_cases_matrix</span>,      <span class="co"># n_locations √ó n_timesteps</span></span>
<span>  est_cases <span class="op">=</span> <span class="va">est_cases_matrix</span>,</span>
<span>  obs_deaths <span class="op">=</span> <span class="va">obs_deaths_matrix</span>,</span>
<span>  est_deaths <span class="op">=</span> <span class="va">est_deaths_matrix</span>,</span>
<span>  weight_cases <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weight_deaths <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weights_location <span class="op">=</span> <span class="cn">NULL</span>,           <span class="co"># Uniform if NULL</span></span>
<span>  weights_time <span class="op">=</span> <span class="cn">NULL</span>,               <span class="co"># Uniform if NULL</span></span>
<span>  config <span class="op">=</span> <span class="va">config</span>,                   <span class="co"># Optional (for metadata)</span></span>
<span>  nb_k_min <span class="op">=</span> <span class="fl">3</span>,                      <span class="co"># Dispersion floor</span></span>
<span>  add_peak_timing <span class="op">=</span> <span class="cn">TRUE</span>,            <span class="co"># Enable shape term</span></span>
<span>  add_peak_magnitude <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  add_cumulative_total <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  add_max_terms <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  add_wis <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  enable_guardrails <span class="op">=</span> <span class="cn">TRUE</span>,          <span class="co"># Enable safety checks</span></span>
<span>  guardrail_verbose <span class="op">=</span> <span class="cn">FALSE</span>,         <span class="co"># Print violations</span></span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>                    <span class="co"># Print component summaries</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="critical-npe-performance-optimization">CRITICAL: NPE Performance Optimization<a class="anchor" aria-label="anchor" href="#critical-npe-performance-optimization"></a></h2>
<div class="section level3">
<h3 id="problem-40k-simulation-files">Problem: 40K Simulation Files<a class="anchor" aria-label="anchor" href="#problem-40k-simulation-files"></a></h3>
<p>During BFRS sampling, ~40K simulations create individual <code>out_NNNNNNN.parquet</code> files. Only 1-5% receive non-zero NPE weights.</p>
</div>
<div class="section level3">
<h3 id="wrong-approach-removed-in-v087">WRONG Approach (Removed in v0.8.7)<a class="anchor" aria-label="anchor" href="#wrong-approach-removed-in-v087"></a></h3>
<pre><code># OLD: Combined all files, then filtered
simulations.parquet (194 MB, all 40K) ‚Üí filter to weighted ‚Üí 2-5 MB
Time: 30-120 seconds
Memory: High</code></pre>
</div>
<div class="section level3">
<h3 id="correct-approach-current">CORRECT Approach (Current)<a class="anchor" aria-label="anchor" href="#correct-approach-current"></a></h3>
<pre><code>outputs/                          # Subdirectory for organization
‚îú‚îÄ‚îÄ timeseries_0000001.parquet   # Individual simulation files
‚îú‚îÄ‚îÄ timeseries_0000002.parquet
‚îî‚îÄ‚îÄ ... (39,465 files)

simulations.parquet               # Metadata only (18 MB)
convergence_results.parquet       # Diagnostics
priors.json                       # Parameter priors

# Load only weighted simulation files directly
Time: 0.1-0.5 seconds
Memory: Low
Speedup: 100-1200√ó faster (2-3 orders of magnitude)</code></pre>
</div>
<div class="section level3">
<h3 id="implementation-details">Implementation Details<a class="anchor" aria-label="anchor" href="#implementation-details"></a></h3>
<p><strong>Directory structure created at:</strong> <code>R/run_MOSAIC.R</code> (directory setup section)</p>
<p><strong>Output file creation:</strong> <code>.mosaic_run_simulation_worker()</code> line 268 writes to <code>outputs/</code> subdirectory</p>
<p><strong>Loading logic:</strong> <code>R/npe.R</code> in <code>.prepare_npe_data()</code> function</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load only weighted simulation files</span></span>
<span><span class="va">outputs_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">iteration_dir</span>, <span class="st">"outputs"</span><span class="op">)</span></span>
<span><span class="va">weighted_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"timeseries_%07d.parquet"</span>, <span class="va">sim_ids_weighted</span><span class="op">)</span></span>
<span><span class="co"># Read each file directly</span></span></code></pre></div>
<p><strong>Cleanup:</strong> After NPE completes</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove entire outputs/ directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">iteration_dir</span>, <span class="st">"outputs"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Frees 50-200 MB disk space</span></span></code></pre></div>
<p><strong>IMPORTANT:</strong> - ‚ùå DO NOT combine individual files into <code>outputs.parquet</code> - ‚úÖ DO organize files in <code>outputs/</code> subdirectory - ‚úÖ DO keep individual files until NPE training completes - ‚úÖ Entire <code>outputs/</code> directory removed automatically after NPE</p>
</div>
</div>
<div class="section level2">
<h2 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h2>
<div class="section level3">
<h3 id="running-tests">Running Tests<a class="anchor" aria-label="anchor" href="#running-tests"></a></h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># All tests</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co"># Specific test file</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"testthat::test_file('tests/testthat/test-calc_model_likelihood.R')"</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="co"># With coverage</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"covr::package_coverage()"</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="co"># Single function test</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"testthat::test_file('tests/testthat/test-calc_spatial_correlation.R')"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="test-structure-38-files">Test Structure (38 files)<a class="anchor" aria-label="anchor" href="#test-structure-38-files"></a></h3>
<p><strong>Organized by component:</strong> - Likelihood: <code>test-calc_log_likelihood_negbin.R</code>, <code>test-calc_log_likelihood_poisson.R</code> - Model evaluation: <code>test-calc_model_likelihood.R</code>, <code>test-calc_model_convergence.R</code> - Spatial: <code>test-calc_spatial_correlation.R</code>, <code>test-calc_spatial_hazard.R</code> - Initial conditions: <code>test-est_initial_E_I.R</code>, <code>test-est_initial_R.R</code>, <code>test-est_initial_V1_V2.R</code> - NPE: <code>test-npe_v5_2.R</code>, <code>test-get_npe_observed_data.R</code>, <code>test-get_npe_simulated_data.R</code> - Configuration: <code>test-convert_config_to_dataframe.R</code>, <code>test-get_location_config.R</code> - Statistics: <code>test-weighted_statistics.R</code>, <code>test-calc_kl_divergence.R</code></p>
</div>
</div>
<div class="section level2">
<h2 id="development-guidelines">Development Guidelines<a class="anchor" aria-label="anchor" href="#development-guidelines"></a></h2>
<div class="section level3">
<h3 id="adding-new-functions">Adding New Functions<a class="anchor" aria-label="anchor" href="#adding-new-functions"></a></h3>
<ol style="list-style-type: decimal"><li>
<p><strong>Create function file in <code>R/</code> following naming convention</strong></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># R/est_new_parameter.R or R/plot_new_diagnostic.R</span></span></code></pre></div>
</li>
<li>
<p><strong>Add roxygen2 documentation</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Estimate New Parameter</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param data Input data</span></span>
<span><span class="co">#' @param ... Additional arguments</span></span>
<span><span class="co">#' @return Estimated parameter value</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">est_new_parameter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Implementation</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p><strong>Update documentation</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document()"</span></span></code></pre></div>
</li>
<li>
<p><strong>Add unit tests in <code>tests/testthat/</code></strong></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tests/testthat/test-est_new_parameter.R</span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"est_new_parameter returns valid output"</span>, <span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">est_new_parameter</span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="va">result</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Run tests</strong></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span></code></pre></div>
</li>
<li>
<p><strong>Check package</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="ex">R</span> CMD check .</span></code></pre></div>
</li>
</ol></div>
<div class="section level3">
<h3 id="path-management">Path Management<a class="anchor" aria-label="anchor" href="#path-management"></a></h3>
<p><strong>ALWAYS use <code><a href="reference/get_paths.html">get_paths()</a></code> for file operations:</strong></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PATHS</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_paths.html">get_paths</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read from processed data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html" class="external-link">read_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">PATHS</span><span class="op">$</span><span class="va">DATA_PROCESSED</span>, <span class="st">"cholera/weekly/ETH.parquet"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write to model input</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">config</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">PATHS</span><span class="op">$</span><span class="va">MODEL_INPUT</span>, <span class="st">"parameters.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save figures</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">PATHS</span><span class="op">$</span><span class="va">DOCS_FIGURES</span>, <span class="st">"transmission_map.png"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Available paths (see <code>R/get_paths.R</code>):</strong> - <code>PATHS$ROOT</code> - MOSAIC root directory - <code>PATHS$DATA_RAW</code>, <code>PATHS$DATA_PROCESSED</code> - Data directories - <code>PATHS$DATA_CLIMATE</code>, <code>PATHS$DATA_ENSO</code>, <code>PATHS$DATA_WHO_WEEKLY</code>, etc. - <code>PATHS$MODEL_INPUT</code>, <code>PATHS$MODEL_OUTPUT</code> - Model directories - <code>PATHS$DOCS_FIGURES</code>, <code>PATHS$DOCS_TABLES</code> - Documentation outputs</p>
</div>
<div class="section level3">
<h3 id="error-handling">Error Handling<a class="anchor" aria-label="anchor" href="#error-handling"></a></h3>
<p><strong>Parameter validation:</strong></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extensive validation in make_LASER_config()</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">iota</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">iota</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span> <span class="op">||</span> <span class="va">iota</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"iota must be a numeric scalar greater than zero."</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">b_jt</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">b_jt</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">location_name</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">b_jt</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"b_jt must be a matrix with rows equal to length(location_name) and columns equal to the daily sequence from date_start to date_stop."</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Graceful degradation:</strong></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Handle missing data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>  <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html" class="external-link">read_parquet</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span>,</span>
<span>  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Could not read file: "</span>, <span class="va">file_path</span>, <span class="st">"\nUsing defaults."</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">default_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h3>
<p><strong>All exported functions MUST have roxygen2 documentation:</strong></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Function Title</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @description</span></span>
<span><span class="co">#' Detailed description of what the function does.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param param1 Description of param1</span></span>
<span><span class="co">#' @param param2 Description of param2</span></span>
<span><span class="co">#' @return Description of return value</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' \dontrun{</span></span>
<span><span class="co">#' result &lt;- my_function(param1 = "value")</span></span>
<span><span class="co">#' }</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">param1</span>, <span class="va">param2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Implementation</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Build documentation:</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document()"</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"pkgdown::build_site()"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="common-development-tasks">Common Development Tasks<a class="anchor" aria-label="anchor" href="#common-development-tasks"></a></h2>
<div class="section level3">
<h3 id="id_1-package-development">1. Package Development<a class="anchor" aria-label="anchor" href="#id_1-package-development"></a></h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="co"># Document functions</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document()"</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="co"># Run all tests</span></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="co"># Check package</span></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a><span class="ex">R</span> CMD check .</span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a><span class="co"># Build package</span></span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a><span class="ex">R</span> CMD build .</span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a><span class="co"># Install from source</span></span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::install()"</span></span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a><span class="co"># Load for interactive development</span></span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::load_all()"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_2-python-environment-management">2. Python Environment Management<a class="anchor" aria-label="anchor" href="#id_2-python-environment-management"></a></h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="co"># Check dependencies</span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::check_dependencies()"</span></span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="co"># Install/update Python environment</span></span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::install_dependencies()"</span></span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="co"># Force reinstall</span></span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::install_dependencies(force = TRUE)"</span></span>
<span id="cb35-9"><a href="#cb35-9" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" tabindex="-1"></a><span class="co"># Remove environment (troubleshooting)</span></span>
<span id="cb35-11"><a href="#cb35-11" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::remove_MOSAIC_python_env()"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_3-running-main-workflow">3. Running Main Workflow<a class="anchor" aria-label="anchor" href="#id_3-running-main-workflow"></a></h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="bu">cd</span> model/</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="ex">Rscript</span> LAUNCH.R</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_4-parallel-execution-azure-style">4. Parallel Execution (Azure-style)<a class="anchor" aria-label="anchor" href="#id_4-parallel-execution-azure-style"></a></h3>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co"># Run parallel simulations</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="ex">Rscript</span> azure/azure_run_laser.R <span class="pp">[</span><span class="ss">n_sim</span><span class="pp">]</span> <span class="pp">[</span><span class="ss">n_iter</span><span class="pp">]</span> <span class="pp">[</span><span class="ss">n_cores</span><span class="pp">]</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="id_-why-we-do-this-design-decisions">üéØ Why We Do This: Design Decisions<a class="anchor" aria-label="anchor" href="#id_-why-we-do-this-design-decisions"></a></h2>
<p>Understanding the <strong>why</strong> behind key architectural choices helps you work with (not against) the system.</p>
<div class="section level3">
<h3 id="why-bump-version-on-every-commit">Why bump version on EVERY commit?<a class="anchor" aria-label="anchor" href="#why-bump-version-on-every-commit"></a></h3>
<p><strong>Problem:</strong> Without version tracking, debugging reported bugs is impossible - can‚Äôt identify when bugs were introduced or which commit fixed them.</p>
<p><strong>Solution:</strong> Semantic versioning in DESCRIPTION + commit messages</p>
<p><strong>Example:</strong> User reports ‚Äúcalc_model_likelihood crashes‚Äù ‚Üí Check their version (0.8.7) ‚Üí Search git log for that version ‚Üí Find exact commit with fix ‚Üí Determine if they need to upgrade.</p>
<p><strong>Benefits:</strong> Traceable history, easy rollback, clear deployment state, professional version management</p>
<p><strong>Scheme:</strong> Patch (0.8.7‚Üí0.8.8): bug fixes; Minor (0.8.7‚Üí0.9.0): new features; Major (0.8.7‚Üí1.0.0): breaking changes</p>
<hr></div>
<div class="section level3">
<h3 id="why-npe-uses-outputs-subdirectory">Why NPE uses outputs/ subdirectory?<a class="anchor" aria-label="anchor" href="#why-npe-uses-outputs-subdirectory"></a></h3>
<p><strong>Problem:</strong> 40K BFRS simulations create individual files, but only 1-5% have non-zero NPE weights. Loading all files then filtering wastes time.</p>
<p><strong>Old approach:</strong> Combine all 40K files ‚Üí 194 MB parquet ‚Üí filter to 2-5 MB used (30-120 seconds)</p>
<p><strong>New approach:</strong> Store in <code>outputs/</code> subdirectory ‚Üí load only weighted file IDs directly (0.1-0.5 seconds)</p>
<p><strong>Speedup:</strong> 100-1200√ó faster (2-3 orders of magnitude)</p>
<p><strong>Why it matters:</strong> NPE training is iterative - saving 120s √ó 10 attempts = 20 minutes. At 100K simulations, old approach unusable.</p>
<p><strong>Implementation:</strong> Files written in <code>.mosaic_run_simulation_worker()</code>, loaded in <code>.prepare_npe_data()</code>, cleaned after NPE completes.</p>
<p><strong>Key rules:</strong> - ‚ùå Don‚Äôt combine files into single <code>outputs.parquet</code> - ‚úÖ Load only weighted files directly - ‚úÖ Clean up <code>outputs/</code> after NPE completes</p>
<hr></div>
<div class="section level3">
<h3 id="why-blas-threads-must--1-in-parallel-execution">Why BLAS threads must = 1 in parallel execution?<a class="anchor" aria-label="anchor" href="#why-blas-threads-must--1-in-parallel-execution"></a></h3>
<p><strong>Problem:</strong> BLAS libraries multithread by default. With parallel workers, this causes severe oversubscription (16 workers √ó 8 BLAS threads = 128 threads on 16 cores), leading to context switching, cache thrashing, and potential deadlocks.</p>
<p><strong>Solution:</strong> Set BLAS threads = 1 in each worker</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MOSAIC</span><span class="fu">:::</span><span class="fu">.mosaic_set_blas_threads</span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>OMP_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span>, MKL_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span>, OPENBLAS_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Result:</strong> 16 workers √ó 1 BLAS thread = 16 threads = optimal CPU usage, linear speedup, no deadlocks</p>
<p><strong>Implementation:</strong> Set in cluster initialization (<code>R/run_MOSAIC.R</code>) and NPE training (<code>R/npe.R</code>)</p>
<p><strong>Critical:</strong> REQUIRED for stable parallel execution. Without it, jobs may hang indefinitely.</p>
<hr></div>
<div class="section level3">
<h3 id="why-get_paths-for-all-file-operations">Why get_paths() for ALL file operations?<a class="anchor" aria-label="anchor" href="#why-get_paths-for-all-file-operations"></a></h3>
<p><strong>Problem:</strong> Hardcoded paths break across different systems, directory structures, and testing environments.</p>
<p><strong>Solution:</strong> Centralized path management via <code><a href="reference/get_paths.html">get_paths()</a></code></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BAD: file.path("~/MOSAIC/MOSAIC-data/processed/climate/ETH.parquet")</span></span>
<span><span class="co"># GOOD:</span></span>
<span><span class="va">PATHS</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_paths.html">get_paths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">PATHS</span><span class="op">$</span><span class="va">DATA_CLIMATE</span>, <span class="st">"ETH.parquet"</span><span class="op">)</span></span></code></pre></div>
<p><strong>How:</strong> User calls <code><a href="reference/set_root_directory.html">set_root_directory()</a></code> once ‚Üí <code><a href="reference/get_paths.html">get_paths()</a></code> builds all paths relative to root ‚Üí Returns 30+ standard paths</p>
<p><strong>Benefits:</strong> Portable across systems, single source of truth, self-documenting, consistent, testable</p>
<p><strong>Usage:</strong> 50+ files use it. See <code>R/get_paths.R</code> for definitions.</p>
<p><strong>Rule:</strong> ALWAYS use <code><a href="reference/get_paths.html">get_paths()</a></code>. NEVER hardcode paths.</p>
<hr></div>
<div class="section level3">
<h3 id="why-no-placeholder-code-ever">Why no placeholder code ever?<a class="anchor" aria-label="anchor" href="#why-no-placeholder-code-ever"></a></h3>
<p><strong>Problem:</strong> Placeholder code ships to production. Developer commits <code>return(NULL) # TODO</code> ‚Üí gets distracted ‚Üí weeks pass ‚Üí someone calls function ‚Üí production breaks.</p>
<p><strong>Solution:</strong> Production-ready code from commit #1. Complete implementation before committing.</p>
<p><strong>Benefits:</strong> Every commit shippable, no technical debt, clear git history, forces proper planning, no surprises</p>
<p><strong>Rule:</strong> Can‚Äôt implement fully now? DON‚ÄôT commit. Ask for help or break into smaller pieces.</p>
<hr></div>
<div class="section level3">
<h3 id="why-concise-documentation">Why concise documentation?<a class="anchor" aria-label="anchor" href="#why-concise-documentation"></a></h3>
<p><strong>Problem:</strong> Verbose roxygen2 docs cause R CMD check warnings, are hard to scan, and take forever to maintain.</p>
<p><strong>Bad:</strong> Multi-line <code>@param</code> with nested <code>\itemize{}</code> lists and complex LaTeX ‚Üí warnings, users give up</p>
<p><strong>Good:</strong> One-line <code>@param</code> descriptions ‚Üí clear, scannable, builds cleanly</p>
<p><strong>Guidelines:</strong> Title (1 line), Description (1-2 sentences), <code>@param</code> (1 line each), <code>@return</code> (1 line), Examples (simple, in <code>\dontrun{}</code>). Avoid nested lists, complex equations, verbose text.</p>
<p><strong>Detailed explanations go in:</strong> Vignettes, CLAUDE.md, code comments - NOT roxygen2</p>
<hr></div>
<div class="section level3">
<h3 id="why-design-for-scale-test-small">Why ‚Äúdesign for scale, test small‚Äù?<a class="anchor" aria-label="anchor" href="#why-design-for-scale-test-small"></a></h3>
<p><strong>Problem:</strong> MOSAIC runs at production scale (40K simulations, 16-32 workers, 100-200 GB memory). Testing at full scale takes hours - development would be impossibly slow.</p>
<p><strong>Solution:</strong> Test with 10-100 simulations (seconds) but write code thinking about 40K: - Will loops handle 40K efficiently? - Pre-allocate or grow objects? (growing is O(n¬≤)) - Vectorized or slow element-wise? - Memory usage scale linearly?</p>
<p><strong>Bad:</strong> <code>results &lt;- list(); for(i in 1:n) results[[i]] &lt;- ...</code> # Growing list O(n¬≤)</p>
<p><strong>Good:</strong> <code>results &lt;- vector("list", n); for(i in 1:n) results[[i]] &lt;- ...</code> # Pre-allocated</p>
<p><strong>Benefits:</strong> Fast development, scalable code, catch issues early, efficient iteration</p>
<p><strong>Rule:</strong> Test with 100 examples. Think about 40K examples.</p>
<hr></div>
<div class="section level3">
<h3 id="why-always-push-to-remote-after-completing-work">Why always push to remote after completing work?<a class="anchor" aria-label="anchor" href="#why-always-push-to-remote-after-completing-work"></a></h3>
<p><strong>Problem:</strong> Local-only commits are fragile: Computer crashes/disk fails ‚Üí work lost; Need different computer ‚Üí work stuck; Collaborator needs fix ‚Üí can‚Äôt access; CI/CD doesn‚Äôt run ‚Üí bugs not caught</p>
<p><strong>Solution:</strong> Push every completed unit of work: <code>git push origin main</code></p>
<p><strong>Benefits:</strong> Backup (safe on remote), collaboration (others access), CI/CD (auto tests), transparency (user sees progress), portability (continue elsewhere)</p>
<p><strong>Rule:</strong> Version bump means ‚Äúthis is complete‚Äù - push immediately.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_-when-things-go-wrong">üîß When Things Go Wrong<a class="anchor" aria-label="anchor" href="#id_-when-things-go-wrong"></a></h2>
<p>Systematic troubleshooting guide for common issues.</p>
<div class="section level3">
<h3 id="tests-failing-after-your-changes">Tests Failing After Your Changes<a class="anchor" aria-label="anchor" href="#tests-failing-after-your-changes"></a></h3>
<p><strong>Step 1: Identify which test is failing</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="co"># Run all tests to see failures</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a><span class="co"># Run just the failing test for details</span></span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"testthat::test_file('tests/testthat/test-my_function.R')"</span></span></code></pre></div>
<p><strong>Step 2: Common causes and fixes</strong></p>
<table class="table"><colgroup><col width="33%"><col width="48%"><col width="18%"></colgroup><thead><tr class="header"><th>Symptom</th>
<th>Likely Cause</th>
<th>Fix</th>
</tr></thead><tbody><tr class="odd"><td>‚ÄúObject not found‚Äù</td>
<td>Function not exported or typo</td>
<td>Check @export tag, check spelling</td>
</tr><tr class="even"><td>‚ÄúUnexpected type‚Äù</td>
<td>Function signature changed</td>
<td>Update all calls to new signature</td>
</tr><tr class="odd"><td>‚ÄúNA/NaN produced‚Äù</td>
<td>Edge case not handled</td>
<td>Add NA handling, check for empty inputs</td>
</tr><tr class="even"><td>‚ÄúDimensions don‚Äôt match‚Äù</td>
<td>Matrix/vector size changed</td>
<td>Check assumptions about data dimensions</td>
</tr><tr class="odd"><td>‚ÄúTest times out‚Äù</td>
<td>Infinite loop or very slow</td>
<td>Add browser() before problem line, debug</td>
</tr></tbody></table><p><strong>Step 3: Debug interactively</strong></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load package in dev mode</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the problematic code step by step</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">test_input</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">my_function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co"># Add browser() in function to step through</span></span></code></pre></div>
<p><strong>Step 4: Check if you broke a dependency</strong></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co"># Find functions that call your modified function</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-r</span> <span class="st">"my_function("</span> R/</span></code></pre></div>
<hr></div>
<div class="section level3">
<h3 id="r-cmd-check-errors-or-warnings">R CMD Check Errors or Warnings<a class="anchor" aria-label="anchor" href="#r-cmd-check-errors-or-warnings"></a></h3>
<p><strong>Common errors and quick fixes:</strong></p>
<table class="table"><colgroup><col width="58%"><col width="41%"></colgroup><thead><tr class="header"><th>Error</th>
<th>Fix</th>
</tr></thead><tbody><tr class="odd"><td>‚ÄúUndocumented parameters‚Äù</td>
<td>Add missing <code>@param</code> tags matching function signature</td>
</tr><tr class="even"><td>‚ÄúFunctions not exported‚Äù</td>
<td>Add <code>@export</code> tag, run <code><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">devtools::document()</a></code>
</td>
</tr><tr class="odd"><td>‚ÄúBroken \link{}‚Äù</td>
<td>Use <code>\code{\link{function}}</code> not <code>\link{function}</code>
</td>
</tr><tr class="even"><td>‚ÄúUndefined global variable‚Äù</td>
<td>Add to <code>R/globals.R</code>: <code>utils::globalVariables(c("var"))</code>
</td>
</tr><tr class="odd"><td>‚ÄúComplex \eqn{} error‚Äù</td>
<td>Simplify equation or move to vignette</td>
</tr></tbody></table><hr></div>
<div class="section level3">
<h3 id="pkgdownbuild_site-failing">pkgdown::build_site() Failing<a class="anchor" aria-label="anchor" href="#pkgdownbuild_site-failing"></a></h3>
<p><strong>Error: ‚ÄúCan‚Äôt find function‚Äù</strong></p>
<p><strong>Causes:</strong> (1) Function not exported - add <code>@export</code> tag; (2) Function in <code>_pkgdown.yml</code> but doesn‚Äôt exist - remove or fix typo; (3) Docs not regenerated - run <code><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">devtools::document()</a></code> first</p>
<p><strong>Workflow for function changes:</strong></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="fu">devtools::document()</span>              <span class="co"># Update docs</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="co"># Update _pkgdown.yml if needed</span></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="fu">pkgdown::build_site()</span>             <span class="co"># Test build</span></span></code></pre></div>
<hr></div>
<div class="section level3">
<h3 id="python-environment-issues">Python Environment Issues<a class="anchor" aria-label="anchor" href="#python-environment-issues"></a></h3>
<p><strong>Symptom:</strong> ‚ÄúFailed to import laser_cholera‚Äù or reticulate crashes</p>
<p><strong>Solution steps:</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="co"># Step 1: Check current configuration</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::check_python_env()"</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a><span class="co"># Step 2: Check dependencies comprehensively</span></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::check_dependencies()"</span></span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a><span class="co"># Step 3: Check if environment exists</span></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> ~/.virtualenvs/r-mosaic/</span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a><span class="co"># Step 4: If environment is broken, reinstall</span></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::remove_MOSAIC_python_env()"</span></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::install_dependencies(force = TRUE)"</span></span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a><span class="co"># Step 5: Restart R and try again</span></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"library(MOSAIC); MOSAIC::check_dependencies()"</span></span></code></pre></div>
<p><strong>If problem persists:</strong></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="co"># Check conda availability</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="fu">which</span> conda</span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a><span class="ex">conda</span> <span class="at">--version</span></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a><span class="co"># Check Python version</span></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a><span class="ex">python</span> <span class="at">--version</span>  <span class="co"># Should be 3.9+</span></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a><span class="co"># Manually check laser-cholera</span></span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a><span class="ex">~/.virtualenvs/r-mosaic/bin/python</span> <span class="at">-c</span> <span class="st">"import laser_cholera; print('OK')"</span></span></code></pre></div>
<hr></div>
<div class="section level3">
<h3 id="pytorch-hangs-when-importing-cluster-deadlock">PyTorch Hangs When Importing (Cluster Deadlock)<a class="anchor" aria-label="anchor" href="#pytorch-hangs-when-importing-cluster-deadlock"></a></h3>
<p><strong>Symptom:</strong> Code hangs indefinitely when running <code>torch &lt;- reticulate::import("torch")</code></p>
<p><strong>Cause:</strong> BLAS threading conflict</p>
<p><strong>Fix is built into run_MOSAIC and train_npe, but for custom code:</strong></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BEFORE importing torch:</span></span>
<span><span class="fu">MOSAIC</span><span class="fu">:::</span><span class="fu">.mosaic_set_blas_threads</span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span></span>
<span>  OMP_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>  MKL_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>  OPENBLAS_NUM_THREADS <span class="op">=</span> <span class="st">"1"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># NOW safe to import:</span></span>
<span><span class="va">torch</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/import.html" class="external-link">import</a></span><span class="op">(</span><span class="st">"torch"</span><span class="op">)</span></span></code></pre></div>
<hr></div>
<div class="section level3">
<h3 id="memory-issues-during-calibration">Memory Issues During Calibration<a class="anchor" aria-label="anchor" href="#memory-issues-during-calibration"></a></h3>
<p><strong>Symptom:</strong> ‚ÄúCannot allocate vector‚Äù or out of RAM</p>
<p><strong>Diagnosis:</strong> <code>free -h</code> (Linux) or <code>vm_stat</code> (macOS)</p>
<p><strong>Common causes:</strong> 1. <strong>Too many workers</strong> - Each uses ~2 GB. With 16 GB RAM: max 8 workers 2. <strong>Growing objects in loops</strong> - Use <code>results &lt;- vector("list", n)</code> not <code>results &lt;- c()</code> 3. <strong>No cleanup</strong> - Add periodic <code><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc()</a></code> every 100 iterations</p>
<hr></div>
<div class="section level3">
<h3 id="git-push-rejected">Git Push Rejected<a class="anchor" aria-label="anchor" href="#git-push-rejected"></a></h3>
<p><strong>Cause:</strong> Remote has commits you don‚Äôt have</p>
<p><strong>Fix:</strong> <code>git fetch origin &amp;&amp; git pull origin main</code> ‚Üí resolve conflicts if any ‚Üí <code>git push origin main</code></p>
<hr></div>
<div class="section level3">
<h3 id="quick-diagnostic-checklist">Quick Diagnostic Checklist<a class="anchor" aria-label="anchor" href="#quick-diagnostic-checklist"></a></h3>
<p>When something breaks, run through this checklist:</p>
<ul class="task-list"><li><label><input type="checkbox">Did tests pass before my changes? (<code>git log</code> to see what changed)</label></li>
<li><label><input type="checkbox">Do tests pass now? (<code><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">devtools::test()</a></code>)</label></li>
<li><label><input type="checkbox">Does package check cleanly? (<code>R CMD check .</code>)</label></li>
<li><label><input type="checkbox">Did I regenerate docs? (<code><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">devtools::document()</a></code>)</label></li>
<li><label><input type="checkbox">Did I update _pkgdown.yml if needed?</label></li>
<li><label><input type="checkbox">Do I have all dependencies? (<code><a href="reference/check_dependencies.html">MOSAIC::check_dependencies()</a></code>)</label></li>
<li><label><input type="checkbox">Am I using <code><a href="reference/get_paths.html">get_paths()</a></code> for file operations?</label></li>
<li><label><input type="checkbox">Did I add <code>@export</code> if function should be exported?</label></li>
<li><label><input type="checkbox">Did I bump version?</label></li>
<li><label><input type="checkbox">Can I reproduce the issue with a minimal example?</label></li>
</ul><p><strong>Still stuck? ASK THE USER!</strong></p>
<hr></div>
</div>
<div class="section level2">
<h2 id="key-files-reference">Key Files Reference<a class="anchor" aria-label="anchor" href="#key-files-reference"></a></h2>
<div class="section level3">
<h3 id="critical-core-files">Critical Core Files<a class="anchor" aria-label="anchor" href="#critical-core-files"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong><code>R/run_MOSAIC.R</code></strong> (2,856 lines) <strong>[CENTERPIECE]</strong>
<ul><li>Complete Bayesian calibration workflow</li>
<li>Three-phase adaptive calibration</li>
<li>Parallel execution infrastructure</li>
<li><strong>Must read to understand MOSAIC workflow</strong></li>
</ul></li>
<li>
<strong><code>R/run_MOSAIC_helpers.R</code></strong> (1,037 lines)
<ul><li>Control validation and merging</li>
<li>Convergence detection algorithms</li>
<li>Internal helper functions</li>
<li><strong>Reference for extending run_MOSAIC</strong></li>
</ul></li>
<li>
<strong><code>R/run_MOSAIC_infrastructure.R</code></strong> (350 lines)
<ul><li>Directory setup and organization</li>
<li>I/O operations (parquet/CSV)</li>
<li>Logging infrastructure</li>
<li><strong>Reference for file structure</strong></li>
</ul></li>
<li>
<strong><code>R/make_LASER_config.R</code></strong> (897 lines)
<ul><li>Validates all 60+ model parameters</li>
<li>Extensive checks on dimensions, types, ranges</li>
<li>Handles compartments, demographics, vaccination, FOI</li>
<li><strong>Always read before modifying parameter structure</strong></li>
</ul></li>
<li>
<strong><code>R/run_LASER.R</code></strong> (68 lines)
<ul><li>Simple wrapper for Python laser-cholera</li>
<li>Suppresses NumPy warnings</li>
<li><strong>Reference for Python integration patterns</strong></li>
</ul></li>
<li>
<strong><code>R/sample_parameters.R</code></strong> (500+ lines)
<ul><li>Samples all 301 parameters from priors</li>
<li>Handles both global and location-specific</li>
<li><strong>Read before modifying parameter sampling</strong></li>
</ul></li>
<li>
<strong><code>R/calc_model_likelihood.R</code></strong> (1000+ lines)
<ul><li>Multi-component likelihood calculation</li>
<li>Guardrails for numerical stability</li>
<li><strong>Critical for understanding calibration</strong></li>
</ul></li>
<li>
<strong><code>R/npe.R</code></strong> (1500+ lines)
<ul><li>Main NPE workflow</li>
<li>PyTorch integration</li>
<li><strong>Reference for advanced calibration</strong></li>
</ul></li>
<li>
<strong><code>R/get_paths.R</code></strong> (81 lines)
<ul><li>Defines all directory paths</li>
<li><strong>Must use for all file operations</strong></li>
</ul></li>
<li>
<strong><code>R/check_dependencies.R</code></strong> (274 lines)
<ul><li>Comprehensive environment diagnostics</li>
<li>Three capability tiers (core, suitability, NPE)</li>
<li><strong>Reference for troubleshooting</strong></li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="configuration-files">Configuration Files<a class="anchor" aria-label="anchor" href="#configuration-files"></a></h3>
<ul><li>
<code>inst/extdata/default_parameters.json</code> (3.9 MB) - Full default config</li>
<li>
<code>inst/py/environment.yml</code> - Python dependencies</li>
<li>
<code>.Rbuildignore</code> - Files excluded from package build</li>
</ul></div>
<div class="section level3">
<h3 id="documentation-files">Documentation Files<a class="anchor" aria-label="anchor" href="#documentation-files"></a></h3>
<ul><li>
<code>README.md</code> - Package overview</li>
<li>
<code>NEWS.md</code> - Version history and changes</li>
<li>
<code>man/</code> - Auto-generated function documentation</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="key-design-decisions">Key Design Decisions<a class="anchor" aria-label="anchor" href="#key-design-decisions"></a></h2>
<div class="section level3">
<h3 id="id_1-universal-export-pattern">1. Universal Export Pattern<a class="anchor" aria-label="anchor" href="#id_1-universal-export-pattern"></a></h3>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NAMESPACE</span></span>
<span><span class="fu">exportPattern</span><span class="op">(</span><span class="st">"^[[:alpha:]]+"</span><span class="op">)</span></span></code></pre></div>
<p>All functions starting with letters are exported. This simplifies development but means internal functions need special naming (e.g., <code>.mosaic_set_blas_threads</code>).</p>
</div>
<div class="section level3">
<h3 id="id_2-centralized-path-management">2. Centralized Path Management<a class="anchor" aria-label="anchor" href="#id_2-centralized-path-management"></a></h3>
<p>All file operations go through <code><a href="reference/get_paths.html">get_paths()</a></code> to maintain consistency across the multi-repo structure.</p>
</div>
<div class="section level3">
<h3 id="id_3-python-environment-isolation">3. Python Environment Isolation<a class="anchor" aria-label="anchor" href="#id_3-python-environment-isolation"></a></h3>
<p>Fixed path <code>~/.virtualenvs/r-mosaic</code> ensures consistency across sessions and prevents conflicts.</p>
</div>
<div class="section level3">
<h3 id="id_4-guardrails-in-likelihood">4. Guardrails in Likelihood<a class="anchor" aria-label="anchor" href="#id_4-guardrails-in-likelihood"></a></h3>
<p>Inline guardrails in <code><a href="reference/calc_model_likelihood.html">calc_model_likelihood()</a></code> prevent numerical instabilities without requiring external validation.</p>
</div>
<div class="section level3">
<h3 id="id_5-performance-critical-npe-design">5. Performance-Critical NPE Design<a class="anchor" aria-label="anchor" href="#id_5-performance-critical-npe-design"></a></h3>
<p>Individual parquet files in <code>outputs/</code> subdirectory allow selective loading based on weights, achieving 100-1200√ó speedup.</p>
</div>
<div class="section level3">
<h3 id="id_6-backward-compatibility">6. Backward Compatibility<a class="anchor" aria-label="anchor" href="#id_6-backward-compatibility"></a></h3>
<p>Functions like <code><a href="reference/sample_parameters.html">sample_parameters()</a></code> support both old (individual args) and new (sample_args list) interfaces.</p>
</div>
<div class="section level3">
<h3 id="id_7-adaptive-calibration">7. Adaptive Calibration<a class="anchor" aria-label="anchor" href="#id_7-adaptive-calibration"></a></h3>
<p>Auto mode (<code>n_simulations = NULL</code>) dynamically adjusts batch sizes based on convergence metrics, stopping when targets met.</p>
</div>
</div>
<div class="section level2">
<h2 id="system-requirements">System Requirements<a class="anchor" aria-label="anchor" href="#system-requirements"></a></h2>
<p><strong>R:</strong> &gt;= 4.1.1</p>
<p><strong>System Libraries:</strong> - GDAL &gt;= 2.0.0 - PROJ &gt;= 4.8.0 - GEOS &gt;= 3.4.0 - UDUNITS-2</p>
<p><strong>Python:</strong> &gt;= 3.9 (managed via conda)</p>
<p><strong>Critical R Packages:</strong> - reticulate (Python interface) - arrow (fast parquet I/O) - sf (spatial operations) - dplyr, data.table (data manipulation) - ggplot2 (visualization)</p>
<p><strong>Optional R Packages:</strong> - mobility (JAGS-based mobility estimation - rarely needed) - tensorflow, keras3 (suitability modeling) - testthat (testing)</p>
<p><strong>Python Packages (managed automatically):</strong> - <strong>Core:</strong> laser-cholera, laser-core, numpy, h5py, pyarrow - <strong>Suitability:</strong> tensorflow, keras - <strong>NPE:</strong> torch, sbi, lampe, zuko, scikit-learn</p>
</div>
<div class="section level2">
<h2 id="version-history">Version History<a class="anchor" aria-label="anchor" href="#version-history"></a></h2>
<div class="section level3">
<h3 id="checking-package-history">Checking Package History<a class="anchor" aria-label="anchor" href="#checking-package-history"></a></h3>
<p><strong>View recent changes:</strong></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="co"># Last 10 commits with one-line summaries</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--oneline</span> <span class="at">-10</span></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a><span class="co"># Detailed log with diffs</span></span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a><span class="fu">git</span> log <span class="at">-5</span> <span class="at">--stat</span></span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a><span class="co"># Changes since a specific version</span></span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a><span class="fu">git</span> log v0.8.6..HEAD <span class="at">--oneline</span></span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a><span class="co"># View specific file history</span></span>
<span id="cb48-11"><a href="#cb48-11" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--follow</span> <span class="at">--</span> R/run_MOSAIC.R</span>
<span id="cb48-12"><a href="#cb48-12" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" tabindex="-1"></a><span class="co"># Search commits by message</span></span>
<span id="cb48-14"><a href="#cb48-14" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--grep</span><span class="op">=</span><span class="st">"NPE"</span> <span class="at">--oneline</span></span></code></pre></div>
<p><strong>View version in DESCRIPTION:</strong></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="co"># Current version</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"^Version:"</span> DESCRIPTION</span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a><span class="co"># Version history</span></span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a><span class="fu">git</span> log <span class="at">--oneline</span> <span class="at">--all</span> <span class="at">--decorate</span> <span class="at">--graph</span> DESCRIPTION</span></code></pre></div>
<p><strong>View NEWS.md:</strong></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="fu">cat</span> NEWS.md <span class="kw">|</span> <span class="fu">head</span> <span class="at">-50</span></span></code></pre></div>
<p><strong>Check what changed between versions:</strong></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="co"># Compare two versions</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a><span class="fu">git</span> diff v0.8.6 v0.8.7</span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a><span class="co"># List files changed</span></span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a><span class="fu">git</span> diff <span class="at">--name-only</span> v0.8.6 v0.8.7</span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a><span class="co"># Show changes to specific file</span></span>
<span id="cb51-8"><a href="#cb51-8" tabindex="-1"></a><span class="fu">git</span> diff v0.8.6 v0.8.7 <span class="at">--</span> R/npe.R</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="additional-resources">Additional Resources<a class="anchor" aria-label="anchor" href="#additional-resources"></a></h2>
<p><strong>Documentation:</strong> <a href="https://institutefordiseasemodeling.github.io/MOSAIC-docs/" class="external-link uri">https://institutefordiseasemodeling.github.io/MOSAIC-docs/</a></p>
<p><strong>Package Website:</strong> <a href="https://institutefordiseasemodeling.github.io/MOSAIC-pkg/" class="uri">https://institutefordiseasemodeling.github.io/MOSAIC-pkg/</a></p>
<p><strong>GitHub Issues:</strong> <a href="https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/issues" class="external-link uri">https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/issues</a></p>
</div>
<div class="section level2">
<h2 id="working-with-claude-code-development-standards">Working with Claude Code: Development Standards<a class="anchor" aria-label="anchor" href="#working-with-claude-code-development-standards"></a></h2>
<div class="section level3">
<h3 id="core-principles">Core Principles<a class="anchor" aria-label="anchor" href="#core-principles"></a></h3>
<p>Claude Code working on MOSAIC must act as a <strong>production systems software engineer</strong> maintaining a clean, efficient, production-ready scientific computing codebase.</p>
</div>
<div class="section level3">
<h3 id="non-negotiable-requirements">Non-Negotiable Requirements<a class="anchor" aria-label="anchor" href="#non-negotiable-requirements"></a></h3>
<div class="section level4">
<h4 id="id_1-code-quality-standards">1. Code Quality Standards<a class="anchor" aria-label="anchor" href="#id_1-code-quality-standards"></a></h4>
<p><strong>NEVER:</strong> - Use placeholder code (e.g., <code># TODO: implement this</code>, <code>pass</code>, <code>return None</code>) - Leave commented-out code in commits - Add debug print/cat statements - Use hardcoded values (paths, magic numbers without explanation) - Add superfluous arguments or features beyond what was requested</p>
<p><strong>ALWAYS:</strong> - Write production-ready code from the start - Complete implementations fully before committing - Remove all debugging artifacts - Use constants/parameters for configurable values - Be concise - do only what is asked, nothing more</p>
<p><strong>If you have a good idea for improvement:</strong> ASK FIRST before implementing it.</p>
</div>
<div class="section level4">
<h4 id="id_2-package-version-management">2. Package Version Management<a class="anchor" aria-label="anchor" href="#id_2-package-version-management"></a></h4>
<p><strong>CRITICAL: Always bump version when committing.</strong> Edit DESCRIPTION file, commit with version in message. See <a href="#why-bump-version-on-every-commit">Why bump version</a> for detailed rationale.</p>
<p><strong>Scheme:</strong> Patch (0.8.7‚Üí0.8.8): bugs/docs; Minor (0.8.7‚Üí0.9.0): features; Major (0.8.7‚Üí1.0.0): breaking changes</p>
</div>
<div class="section level4">
<h4 id="id_3-testing-requirements">3. Testing Requirements<a class="anchor" aria-label="anchor" href="#id_3-testing-requirements"></a></h4>
<p><strong>Before making ANY changes:</strong></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="co"># Run existing tests to establish baseline</span></span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span></code></pre></div>
<p><strong>After making changes:</strong></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="co"># Run tests again</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a><span class="co"># For new functions, add tests</span></span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a><span class="co"># tests/testthat/test-my_new_function.R</span></span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a><span class="co"># Run R CMD check</span></span>
<span id="cb53-8"><a href="#cb53-8" tabindex="-1"></a><span class="ex">R</span> CMD check .</span></code></pre></div>
<p><strong>For bug fixes:</strong> - Add regression test that fails with old code, passes with fix - Test edge cases: NA, NULL, empty vectors, single values, large inputs</p>
<p><strong>For new features:</strong> - Unit tests for all new functions - Integration test showing it works in workflow - Test with realistic data, not just toy examples</p>
</div>
<div class="section level4">
<h4 id="id_4-never-break-existing-workflows">4. Never Break Existing Workflows<a class="anchor" aria-label="anchor" href="#id_4-never-break-existing-workflows"></a></h4>
<p><strong>Critical paths that MUST continue working:</strong> - <code>run_mosaic_iso()</code> / <code><a href="reference/run_MOSAIC.html">run_MOSAIC()</a></code> - Complete calibration pipeline - <code><a href="reference/calc_model_likelihood.html">calc_model_likelihood()</a></code> - Likelihood calculation - <code><a href="reference/sample_parameters.html">sample_parameters()</a></code> - Parameter sampling - NPE training workflow - Parallel execution on clusters</p>
<p><strong>Before committing, verify:</strong></p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test basic workflow still works</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://institutefordiseasemodeling.github.io/MOSAIC-pkg/">MOSAIC</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/set_root_directory.html">set_root_directory</a></span><span class="op">(</span><span class="st">"~/MOSAIC"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Try a small test run</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_location_config.html">get_location_config</a></span><span class="op">(</span>iso <span class="op">=</span> <span class="st">"ETH"</span><span class="op">)</span></span>
<span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_location_priors.html">get_location_priors</a></span><span class="op">(</span>iso <span class="op">=</span> <span class="st">"ETH"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample parameters</span></span>
<span><span class="va">test_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sample_parameters.html">sample_parameters</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">123</span>, priors <span class="op">=</span> <span class="va">priors</span>, config <span class="op">=</span> <span class="va">config</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If you changed likelihood, test it</span></span>
<span><span class="co"># If you changed run_MOSAIC, test a small calibration</span></span>
<span><span class="co"># etc.</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="id_5-performance-standards">5. Performance Standards<a class="anchor" aria-label="anchor" href="#id_5-performance-standards"></a></h4>
<p><strong>NEVER regress performance:</strong> - Consider performance implications before coding - Preserve critical optimizations (NPE outputs/ subdirectory, vectorization) - Profile before/after if touching hot paths (use small test cases)</p>
<p><strong>Hot paths (be extra careful):</strong> - <code><a href="reference/run_MOSAIC.html">run_MOSAIC()</a></code> - Main calibration loop - <code><a href="reference/calc_model_likelihood.html">calc_model_likelihood()</a></code> - Called thousands of times - <code>.mosaic_run_simulation_worker()</code> - Parallel worker - <code>.prepare_npe_data()</code> - NPE data loading</p>
<p><strong>Scaling awareness:</strong> See <a href="#why-design-for-scale-test-small">Why design for scale, test small</a> for detailed guidance. Test with 10-100 examples, think about 40K. Pre-allocate, avoid growing objects, vectorize, consider memory (N workers √ó ~2 GB per worker), ensure thread safety (BLAS threads = 1).</p>
</div>
<div class="section level4">
<h4 id="id_6-git-workflow">6. Git Workflow<a class="anchor" aria-label="anchor" href="#id_6-git-workflow"></a></h4>
<p><strong>Standard workflow:</strong> Bump version ‚Üí test ‚Üí document ‚Üí stage files ‚Üí commit (with version in message) ‚Üí push</p>
<p><strong>Commit format:</strong> Brief summary (50 chars) with version, blank line, bullets explaining what/why</p>
<p><strong>Atomic commits:</strong> One logical change per commit, don‚Äôt mix changes, don‚Äôt commit broken code</p>
</div>
<div class="section level4">
<h4 id="id_7-documentation-standards">7. Documentation Standards<a class="anchor" aria-label="anchor" href="#id_7-documentation-standards"></a></h4>
<p><strong>When to update:</strong> Adding functions, changing signatures, modifying behavior</p>
<p><strong>Keep it concise:</strong> See <a href="#why-concise-documentation">Why concise documentation</a> for rationale. One-line <code>@param</code>, avoid complex roxygen2 syntax (nested lists, complex LaTeX), detailed explanations go in vignettes/CLAUDE.md</p>
<p><strong>Maintain pkgdown:</strong> Update <code>_pkgdown.yml</code> when adding/removing functions, test with <code><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">pkgdown::build_site()</a></code></p>
<p><strong>Checklist:</strong> <code><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">devtools::document()</a></code> ‚Üí check for warnings ‚Üí test <code><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">pkgdown::build_site()</a></code></p>
</div>
<div class="section level4">
<h4 id="id_8-dependencies">8. Dependencies<a class="anchor" aria-label="anchor" href="#id_8-dependencies"></a></h4>
<p><strong>NEVER add new dependencies without explicit user approval.</strong></p>
<p><strong>If changing Python integration:</strong></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="co"># Always verify afterward</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"MOSAIC::check_dependencies()"</span></span></code></pre></div>
<p><strong>Maintain backward compatibility:</strong> - Don‚Äôt change function signatures without deprecation - Support old parameter names with warnings - Document breaking changes clearly</p>
</div>
<div class="section level4">
<h4 id="id_9-r-package-specific">9. R Package Specific<a class="anchor" aria-label="anchor" href="#id_9-r-package-specific"></a></h4>
<p><strong>Code style:</strong></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use explicit namespace calls</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">...</span><span class="op">)</span>  <span class="co"># Good</span></span>
<span><span class="fu">mutate</span><span class="op">(</span><span class="va">df</span>, <span class="va">...</span><span class="op">)</span>          <span class="co"># Bad (unless in depends)</span></span>
<span></span>
<span><span class="co"># Use get_paths() for ALL file operations</span></span>
<span><span class="va">PATHS</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_paths.html">get_paths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">PATHS</span><span class="op">$</span><span class="va">MODEL_OUTPUT</span>, <span class="st">"results.parquet"</span><span class="op">)</span>  <span class="co"># Good</span></span>
<span><span class="st">"~/MOSAIC/output/results.parquet"</span>                 <span class="co"># Bad (hardcoded)</span></span>
<span></span>
<span><span class="co"># Handle NAs properly</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>    <span class="co"># Consider what NAs mean</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>            <span class="co"># Check for unexpected NAs</span></span>
<span></span>
<span><span class="co"># Vectorize when possible</span></span>
<span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span>                    <span class="co"># Good</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>  <span class="co"># Bad</span></span></code></pre></div>
<p><strong>Function design:</strong> - Validate inputs early with clear error messages - Return consistent types (don‚Äôt return NULL sometimes, list other times) - Use S3 methods when appropriate - Keep functions focused (single responsibility)</p>
</div>
<div class="section level4">
<h4 id="id_10-scientific-computing-standards">10. Scientific Computing Standards<a class="anchor" aria-label="anchor" href="#id_10-scientific-computing-standards"></a></h4>
<p><strong>Preserve reproducibility:</strong> - Maintain seeding schemes (seed_sim, seed_iter in run_MOSAIC) - Document stochastic components - Test reproducibility with same seed</p>
<p><strong>Numerical stability:</strong> - Preserve likelihood guardrails - Handle edge cases (0, Inf, -Inf) - Use log-space for very small/large numbers - Test with extreme values</p>
<p><strong>Parallel execution:</strong> - Ensure thread safety (BLAS threads = 1) - Test parallel and sequential modes - Avoid race conditions - Clean up resources (close clusters)</p>
</div>
</div>
<div class="section level3">
<h3 id="workflow-checklist">Workflow Checklist<a class="anchor" aria-label="anchor" href="#workflow-checklist"></a></h3>
<p><strong>Before:</strong> Read git log, check if exists, run tests, understand workflow fit <strong>During:</strong> Production-ready code (no placeholders), test incrementally, comment complex logic, no hardcoding, stay focused <strong>Before commit:</strong> Bump version, test, document, R CMD check, verify no debug code, check workflows still work <strong>Commit:</strong> Stage relevant files, clear message with version, push <strong>After:</strong> Verify push, check CI/CD, update issues</p>
</div>
<div class="section level3">
<h3 id="communication-protocol">Communication Protocol<a class="anchor" aria-label="anchor" href="#communication-protocol"></a></h3>
<p><strong>When starting a task:</strong> 1. Explain what you‚Äôre going to do 2. List files you‚Äôll modify 3. Describe testing approach 4. Ask for clarification if requirements unclear</p>
<p><strong>During work:</strong> 1. Show test results as you go 2. Report any unexpected issues 3. Ask before implementing ‚Äúimprovements‚Äù 4. Explain non-obvious decisions</p>
<p><strong>When complete:</strong> 1. Summarize what changed 2. Report test results 3. Show git commit and push output 4. Note any limitations or follow-up needed</p>
</div>
<div class="section level3">
<h3 id="quick-reference">Quick Reference<a class="anchor" aria-label="anchor" href="#quick-reference"></a></h3>
<p><strong>Essential commands:</strong></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test()"</span></span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a><span class="co"># Document</span></span>
<span id="cb57-5"><a href="#cb57-5" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document()"</span></span>
<span id="cb57-6"><a href="#cb57-6" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" tabindex="-1"></a><span class="co"># Check</span></span>
<span id="cb57-8"><a href="#cb57-8" tabindex="-1"></a><span class="ex">R</span> CMD check .</span>
<span id="cb57-9"><a href="#cb57-9" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" tabindex="-1"></a><span class="co"># Version</span></span>
<span id="cb57-11"><a href="#cb57-11" tabindex="-1"></a><span class="fu">grep</span> <span class="st">"^Version:"</span> DESCRIPTION</span>
<span id="cb57-12"><a href="#cb57-12" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" tabindex="-1"></a><span class="co"># Git workflow</span></span>
<span id="cb57-14"><a href="#cb57-14" tabindex="-1"></a><span class="fu">git</span> status</span>
<span id="cb57-15"><a href="#cb57-15" tabindex="-1"></a><span class="fu">git</span> diff</span>
<span id="cb57-16"><a href="#cb57-16" tabindex="-1"></a><span class="fu">git</span> add <span class="op">&lt;</span>files<span class="op">&gt;</span></span>
<span id="cb57-17"><a href="#cb57-17" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">"message (vX.Y.Z)"</span></span>
<span id="cb57-18"><a href="#cb57-18" tabindex="-1"></a><span class="fu">git</span> push origin main</span></code></pre></div>
<p><strong>Files to check:</strong> - [ ] Use <code>./claude/</code> for temporary files - [ ] Never create files in package root without necessity - [ ] Respect read-only repos (laser-cholera, ees-cholera-mapping, jhu_cholera_data) - [ ] Never modify MOSAIC-data/raw/</p>
<p><strong>Key functions to understand:</strong> - <code><a href="reference/run_MOSAIC.html">run_MOSAIC()</a></code> - Centerpiece calibration workflow - <code><a href="reference/calc_model_likelihood.html">calc_model_likelihood()</a></code> - Core likelihood calculation - <code><a href="reference/sample_parameters.html">sample_parameters()</a></code> - Parameter sampling with 301 parameters - <code><a href="reference/get_paths.html">get_paths()</a></code> - MUST use for all file operations</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gilesjohnr" class="external-link">John R Giles</a>, <a href="https://github.com/ChristopherWLorton" class="external-link">Christopher W Lorton</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

