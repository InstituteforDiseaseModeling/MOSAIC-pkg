<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Prepare NPE Training Data from BFRS Results — prepare_npe_data • MOSAIC</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Prepare NPE Training Data from BFRS Results — prepare_npe_data"><meta name="description" content="Loads simulation outputs and parameters from BFRS results directory and prepares
them for Neural Posterior Estimation (NPE) training. Optimized to load only
individual output files for weighted simulations, avoiding the need to read
and filter a large combined outputs file."><meta property="og:description" content="Loads simulation outputs and parameters from BFRS results directory and prepares
them for Neural Posterior Estimation (NPE) training. Optimized to load only
individual output files for weighted simulations, avoiding the need to read
and filter a large combined outputs file."><meta property="og:image" content="https://institutefordiseasemodeling.github.io/MOSAIC-pkg/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MOSAIC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Deployment.html">Deployment</a></li>
    <li><a class="dropdown-item" href="../articles/Installation.html">Installation</a></li>
    <li><a class="dropdown-item" href="../articles/Running-MOSAIC.html">Running MOSAIC</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Prepare NPE Training Data from BFRS Results</h1>
      <small class="dont-index">Source: <a href="https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/blob/HEAD/R/npe.R" class="external-link"><code>R/npe.R</code></a></small>
      <div class="d-none name"><code>prepare_npe_data.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Loads simulation outputs and parameters from BFRS results directory and prepares
them for Neural Posterior Estimation (NPE) training. Optimized to load only
individual output files for weighted simulations, avoiding the need to read
and filter a large combined outputs file.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">prepare_npe_data</span><span class="op">(</span></span>
<span>  <span class="va">bfrs_dir</span>,</span>
<span>  results <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  param_names <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-bfrs-dir">bfrs_dir<a class="anchor" aria-label="anchor" href="#arg-bfrs-dir"></a></dt>
<dd><p>Directory containing BFRS results with:</p><ul><li><p>simulations.parquet: Parameter values and weights</p></li>
<li><p>outputs/timeseries/timeseries_NNNNNNN.parquet: Individual timeseries files</p></li>
<li><p>priors.json: Parameter prior distributions</p></li>
</ul></dd>


<dt id="arg-results">results<a class="anchor" aria-label="anchor" href="#arg-results"></a></dt>
<dd><p>Optional data frame of BFRS results already loaded in memory
(NULL = load from file). Preferred when results are already available to
avoid redundant file I/O. Must contain columns: sim, likelihood, and parameter columns.</p></dd>


<dt id="arg-param-names">param_names<a class="anchor" aria-label="anchor" href="#arg-param-names"></a></dt>
<dd><p>Character vector of parameter names to extract (NULL = auto-detect)</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical, print progress messages (default: TRUE)</p></dd>


<dt id="arg-chunk-size">chunk_size<a class="anchor" aria-label="anchor" href="#arg-chunk-size"></a></dt>
<dd><p>Integer, chunk size for processing large datasets (NULL = auto)</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>List containing:</p><dl><dt>parameters</dt>
<dd><p>Matrix of parameter values (n_sims × n_params)</p></dd>

<dt>observations</dt>
<dd><p>Matrix of flattened time series (n_sims × n_features)</p></dd>

<dt>weights</dt>
<dd><p>Vector of simulation weights</p></dd>

<dt>bounds</dt>
<dd><p>Matrix of parameter bounds (n_params × 2)</p></dd>

<dt>param_names</dt>
<dd><p>Character vector of parameter names</p></dd>

<dt>n_samples, n_params, n_timesteps, n_locations</dt>
<dd><p>Integer dimensions</p></dd>

<dt>observed_data</dt>
<dd><p>Optional data frame of observed data (if available)</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function implements a high-performance loading strategy:</p><ol><li><p>Loads simulations.parquet to identify weighted simulations</p></li>
<li><p>Loads only the individual timeseries files for weighted simulations</p></li>
<li><p>Combines loaded files using data.table::rbindlist() for efficiency</p></li>
<li><p>Reshapes data from long to wide format for NPE training</p></li>
</ol><p>Performance: For typical BFRS results with 1\<!-- % weighted simulations: --></p><ul><li><p>Old approach (combined file): 30-120 seconds to load and filter 45M rows</p></li>
<li><p>New approach (individual files): 0.1-0.5 seconds to load 450K rows directly</p></li>
<li><p>Speedup: 100-1200× faster</p></li>
</ul><p>The function expects individual output files in the outputs/timeseries/ subdirectory.
These files are created during simulation. The entire outputs/ directory can be
removed after NPE training completes to free disk space.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Basic usage (loads from file)</span></span></span>
<span class="r-in"><span><span class="va">npe_data</span> <span class="op">&lt;-</span> <span class="fu">prepare_npe_data</span><span class="op">(</span></span></span>
<span class="r-in"><span>    bfrs_dir <span class="op">=</span> <span class="st">"path/to/1_bfrs"</span>,</span></span>
<span class="r-in"><span>    param_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_env"</span>, <span class="st">"beta_hum"</span>, <span class="st">"tau_i"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Optimized usage (pass pre-loaded results)</span></span></span>
<span class="r-in"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html" class="external-link">read_parquet</a></span><span class="op">(</span><span class="st">"path/to/1_bfrs/outputs/simulations.parquet"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">results</span><span class="op">$</span><span class="va">weight_npe</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_npe_weights.html">get_npe_weights</a></span><span class="op">(</span><span class="va">results</span>, strategy <span class="op">=</span> <span class="st">"continuous_best"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">npe_data</span> <span class="op">&lt;-</span> <span class="fu">prepare_npe_data</span><span class="op">(</span></span></span>
<span class="r-in"><span>    bfrs_dir <span class="op">=</span> <span class="st">"path/to/1_bfrs"</span>,</span></span>
<span class="r-in"><span>    results <span class="op">=</span> <span class="va">results</span>,</span></span>
<span class="r-in"><span>    param_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_env"</span>, <span class="st">"beta_hum"</span>, <span class="st">"tau_i"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gilesjohnr" class="external-link">John R Giles</a>, <a href="https://github.com/ChristopherWLorton" class="external-link">Christopher W Lorton</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

