% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calc_model_convergence_loss.R
\name{calc_model_convergence_loss}
\alias{calc_model_convergence_loss}
\title{Calculate convergence diagnostics from a loss and write to files}
\usage{
calc_model_convergence_loss(
  PATHS,
  results,
  output_dir,
  eta = 1,
  top_quantile = 0.05,
  outlier_mult = 1,
  ess_min = 1000,
  A_min = 0.8,
  cvw_max = 1,
  B_min = 50,
  verbose = TRUE
)
}
\arguments{
\item{PATHS}{MOSAIC paths list from \code{get_paths()} (kept for API consistency).}

\item{results}{Data frame with columns: \code{sim}, \code{loss} (numeric; lower is better).}

\item{output_dir}{Directory to write output files.}

\item{eta}{Positive scalar for Gibbs weighting (default \code{1}).}

\item{top_quantile}{Quantile threshold for selection (default \code{0.05} = top 5\\%).}

\item{outlier_mult}{Multiplier for IQR to define high outliers (default \code{1.5}). Values above Q3 + outlier_mult*IQR
are excluded before applying quantile selection. Use \code{Inf} to disable outlier removal.}

\item{ess_min}{Target minimum ESS over all finite-loss sims (default \code{1000}).}

\item{A_min}{Target minimum agreement index within \eqn{\mathcal{B}} (default \code{0.8}).}

\item{cvw_max}{Target maximum coefficient of variation within \eqn{\mathcal{B}} (default \code{1.0}).}

\item{B_min}{Target minimum size of \eqn{\mathcal{B}} (default \code{50}).}

\item{verbose}{Print progress messages (default \code{TRUE}).}
}
\value{
A list with:
\itemize{
\item \code{status} — "PASS" / "WARN" / "FAIL"
\item \code{n_total} — total rows in \code{results}
\item \code{n_successful} — number with finite loss
\item \code{n_best} — size of best subset \eqn{\mathcal{B}}
\item \code{files_written} — written file names
}
}
\description{
Uses a Gibbs posterior constructed from a user-supplied loss to compute
weights and convergence diagnostics. Keeps only simulations with finite loss.
Effective sample size (ESS) is computed over all finite-loss simulations.
The best subset \eqn{\mathcal{B}} is defined by a robust loss band above the
minimum loss, and agreement metrics (A, CVw) are computed within \eqn{\mathcal{B}}.
}
\details{
Let \eqn{L_i} be the scalar loss (smaller is better). Define
\eqn{\Delta L_i = L_i - \min_j L_j} and the Gibbs weights
\deqn{w_i(\eta) \propto \exp\!\left(-\eta\,\Delta L_i\right),}
normalized across all finite-loss simulations. The best subset \eqn{\mathcal{B}}
is defined as:
\deqn{\mathcal{B}=\{i:\ L_i \le Q_{p}(L_{\text{non-outlier}})\},}
where \eqn{Q_p} is the p-quantile (e.g., p = 0.05 for top 5\\%) calculated on
losses after removing high outliers. This provides robust and predictable selection.
}
\section{File Outputs}{

\itemize{
\item \code{convergence_results_loss.parquet} — columns:
sim, seed, loss, delta_loss, w, w_tilde, in_best_band, in_top_pct, rank_loss
\item \code{convergence_diagnostics_loss.json} — aggregate metrics and settings
}
}

\examples{
\dontrun{
set.seed(1)
results <- data.frame(
  sim  = 1:1000,
  loss = rexp(1000, rate = 1) + rnorm(1000, sd = 0.1)
)
out <- calc_model_convergence_loss(
  PATHS = get_paths(),
  results = results,
  output_dir = "path/to/output",
  eta = 1.5,
  top_quantile = 0.05
)
print(out)
}

}
\seealso{
\code{\link[=plot_model_convergence_loss]{plot_model_convergence_loss()}},
\code{\link[=calc_model_loss_delta]{calc_model_loss_delta()}},
\code{\link[=calc_gibbs_weights]{calc_gibbs_weights()}},
\code{\link[=calc_model_ess]{calc_model_ess()}},
\code{\link[=calc_model_agreement_index]{calc_model_agreement_index()}},
\code{\link[=calc_model_cvw]{calc_model_cvw()}},
\code{\link[=select_best_by_loss_band]{select_best_by_loss_band()}}

Other calibration-metrics: 
\code{\link{calc_gibbs_weights}()},
\code{\link{calc_model_agreement_index}()},
\code{\link{calc_model_aic_delta}()},
\code{\link{calc_model_akaike_weights}()},
\code{\link{calc_model_convergence}()},
\code{\link{calc_model_cvw}()},
\code{\link{calc_model_ess}()},
\code{\link{calc_model_loss_delta}()},
\code{\link{calc_model_max_weight}()},
\code{\link{plot_model_convergence}()},
\code{\link{select_best_by_loss_band}()}
}
\concept{calibration-metrics}
