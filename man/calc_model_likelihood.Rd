% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calc_model_likelihood.R
\name{calc_model_likelihood}
\alias{calc_model_likelihood}
\title{Compute the total model likelihood (Simplified)}
\usage{
calc_model_likelihood(
  obs_cases,
  est_cases,
  obs_deaths,
  est_deaths,
  weight_cases = NULL,
  weight_deaths = NULL,
  weights_location = NULL,
  weights_time = NULL,
  nb_k_min = 3,
  zero_buffer = TRUE,
  verbose = FALSE,
  add_max_terms = TRUE,
  add_peak_timing = TRUE,
  add_peak_magnitude = TRUE,
  add_cumulative_total = TRUE,
  add_wis = TRUE,
  weight_peak_timing = 0.5,
  weight_peak_magnitude = 0.5,
  weight_cumulative_total = 0.3,
  weight_wis = 0.8,
  peak_method = c("smooth", "simple"),
  sigma_peak_time = 2,
  sigma_peak_log = 0.5,
  wis_quantiles = c(0.0275, 0.25, 0.5, 0.75, 0.975),
  cumulative_timepoints = c(0.25, 0.5, 0.75, 1),
  enable_guardrails = TRUE,
  floor_likelihood = -999999999,
  guardrail_verbose = FALSE,
  cumulative_over_ratio = 10,
  cumulative_under_ratio = 0.1,
  min_cumulative_for_check = 100,
  negative_correlation_threshold = 0,
  max_timestep_ratio = 100,
  min_timestep_ratio = 0.01,
  min_obs_for_ratio = 1
)
}
\arguments{
\item{obs_cases, est_cases}{Matrices \code{n_locations x n_time_steps} of observed
and estimated cases.}

\item{obs_deaths, est_deaths}{Matrices \code{n_locations x n_time_steps} of observed
and estimated deaths.}

\item{weight_cases, weight_deaths}{Optional scalar weights for case/death blocks.
Default 1.}

\item{weights_location}{Optional length-\code{n_locations} non-negative weights.}

\item{weights_time}{Optional length-\code{n_time_steps} non-negative weights.}

\item{nb_k_min}{Numeric; minimum NB dispersion floor used for the core NB likelihood
and WIS quantiles. Default \code{3}.}

\item{zero_buffer}{Kept for backward compatibility (not used by the NB core).}

\item{verbose}{Logical; if \code{TRUE}, prints component summaries per location.}

\item{add_max_terms}{Logical; legacy max Poisson terms. Default \code{FALSE}.}

\item{add_peak_timing, add_peak_magnitude, add_cumulative_total}{Logical; default \code{TRUE}.}

\item{add_wis}{Logical; default \code{FALSE}.}

\item{weight_peak_timing, weight_peak_magnitude, weight_cumulative_total}{Component weights. Defaults \code{0.5, 0.5, 0.3}.}

\item{weight_wis}{Component weight for optional WIS term.}

\item{peak_method}{\code{"smooth"} (3-pt moving average) or \code{"simple"}.}

\item{sigma_peak_time}{SD (weeks) for peak timing Normal; default \code{2}.}

\item{sigma_peak_log}{SD on log-scale for peak magnitude; default \code{0.5}.}

\item{wis_quantiles}{Quantiles for WIS if enabled.}

\item{cumulative_timepoints}{Fractions for cumulative progression; default \code{c(0.25,0.5,0.75,1)}.}

\item{enable_guardrails}{Logical; default \code{TRUE}.}

\item{floor_likelihood}{Numeric; hard floor returned on violations. Default \code{-999999999}.}

\item{guardrail_verbose}{Logical; print guardrail reasons.}

\item{cumulative_over_ratio, cumulative_under_ratio}{Cumulative ratio bounds (default \code{10}, \code{0.1}).}

\item{min_cumulative_for_check}{Minimum observed total to apply ratio checks; default \code{100}.}

\item{negative_correlation_threshold}{Correlation floor; default \code{0} (requires positive correlation).}

\item{max_timestep_ratio}{Maximum ratio of estimated to observed per timestep (default \code{100}).}

\item{min_timestep_ratio}{Minimum ratio of estimated to observed per timestep (default \code{0.01}).}

\item{min_obs_for_ratio}{Minimum observed value to apply ratio checks (default \code{1}).}
}
\value{
Scalar total log-likelihood (finite) or \code{floor_likelihood} if floored.
May be \code{NA_real_} if all locations contribute nothing.
}
\description{
A simplified, robust wrapper for scoring model fits in MOSAIC.
The core is a Negative Binomial (NB) time-series log-likelihood per
location and outcome (cases, deaths) with a weighted MoM dispersion
estimate and a small \code{k_min} floor.
}
\details{
By default, three "shape" terms are included with modest weights:
(1) peak timing (Normal on peak index difference),
(2) peak magnitude (log-Normal on ratios), and
(3) cumulative progression (NB at a few cumulative fractions).

Minimal inline guardrails floor the score on egregious fits (cumulative
over/under prediction, per-timestep caps, and negative correlation).
Optional max terms and WIS are kept but OFF by default.
}
