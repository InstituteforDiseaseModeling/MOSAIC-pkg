% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/npe_funcs.R
\name{est_npe_posterior}
\alias{est_npe_posterior}
\title{Estimate MOSAIC Parameters using Trained NPE Models}
\usage{
est_npe_posterior(
  model_dir,
  observed_data,
  n_samples = 10000,
  quantiles = c(0.025, 0.25, 0.5, 0.75, 0.975),
  output_dir = NULL,
  verbose = TRUE,
  return_samples = TRUE,
  config_override = NULL
)
}
\arguments{
\item{model_dir}{Character string path to directory containing trained NPE models.
This should be the output directory from \code{\link{train_npe}}.}

\item{observed_data}{Data frame containing observed outbreak time series data with columns:
\itemize{
\item \code{j} — Location identifier (character, matching training data)
\item \code{t} — Time index (integer, starting from 1)
\item \code{cases} — Observed case counts (numeric)
}}

\item{n_samples}{Integer number of posterior samples to draw per ensemble model.
Default is 10,000. Higher values provide more accurate quantiles but slower computation.}

\item{quantiles}{Numeric vector of quantiles to compute for posterior summaries.
Default is \code{c(0.025, 0.25, 0.5, 0.75, 0.975)} for 95\% credible intervals.}

\item{output_dir}{Character string path for saving estimation results. If NULL (default),
results are not saved to files (only returned in memory). If a path is provided,
results are saved to that directory.}

\item{verbose}{Logical indicating whether to print progress messages. Default is TRUE.}

\item{return_samples}{Logical indicating whether to return raw posterior samples.
Default is TRUE. This parameter is included for backward compatibility - samples
are always included in the return value.}
}
\value{
A list containing:
\itemize{
\item \code{quantiles} — Data frame with posterior quantiles
\item \code{samples} — Matrix of raw posterior samples (n_samples × n_parameters)
\item \code{metadata} — List containing estimation metadata
\item \code{param_names} — Character vector of parameter names
}
The \code{quantiles} data frame contains columns:
\itemize{
\item \code{parameter} — Parameter name
\item \code{description} — Human-readable parameter description
\item \code{category} — Parameter category grouping
\item \code{param_type} — Type classification
\item \code{location} — Location code (for location-specific parameters)
\item \code{prior_distribution} — Prior distribution type
\item \code{type} — Set to "npe" for NPE-derived posteriors
\item \code{mean} — Posterior mean
\item \code{sd} — Posterior standard deviation
\item \code{mode} — Posterior mode (set to NA)
\item \code{kl} — KL divergence (set to NA)
\item \code{q*} — Quantile columns for each requested quantile
}
}
\description{
Performs fast Bayesian parameter estimation using previously trained Neural Posterior
Estimator models from \code{\link{train_npe}}. Provides posterior quantiles in the
same format as \code{\link{calc_model_posterior_quantiles}} for seamless integration
with MOSAIC workflows.
}
\details{
This function performs ensemble-based posterior estimation by:
\itemize{
\item Loading trained NPE models, encoders, and preprocessing components
\item Validating observed data format and dimensions against training data
\item Running posterior sampling across all ensemble models
\item Aggregating samples and computing summary statistics
\item Formatting output to match standard MOSAIC posterior format
}

The NPE provides orders-of-magnitude speedup compared to traditional MCMC while
maintaining comparable accuracy for well-trained models.
}
\section{External Dependencies}{

This function requires:
\itemize{
\item \strong{Lampe}: For loading and running trained NPE models (\url{https://github.com/probabilists/lampe})
\item \strong{PyTorch}: For neural network inference (\url{https://pytorch.org/})
}
}

\examples{
\dontrun{
# Prepare observed data
observed <- data.frame(
  j = c("ETH", "ETH", "ETH"),
  t = c(1, 2, 3),
  cases = c(45, 67, 52)
)

# Estimate parameters using trained NPE
result <- est_npe_posterior(
  model_dir = "path/to/trained/npe/models",
  observed_data = observed,
  n_samples = 5000,
  quantiles = c(0.05, 0.25, 0.5, 0.75, 0.95),
  output_dir = NULL  # Don't save to files
)

# Access results
posterior_quantiles <- result$quantiles
posterior_samples <- result$samples
}

}
\seealso{
\itemize{
\item \code{\link{train_npe}} for training NPE models
\item \code{\link{calc_model_posterior_quantiles}} for traditional posterior quantiles
\item \code{\link{plot_model_posterior_quantiles}} for comparing posterior estimates
}
}
