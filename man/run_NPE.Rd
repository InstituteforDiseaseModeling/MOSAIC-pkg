% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/run_NPE.R
\name{run_NPE}
\alias{run_NPE}
\title{Run Neural Posterior Estimation (NPE)}
\usage{
run_NPE(
  input_dir = NULL,
  output_dir = NULL,
  root_dir = NULL,
  results = NULL,
  priors = NULL,
  config = NULL,
  param_names = NULL,
  dirs = NULL,
  PATHS = NULL,
  control = NULL,
  verbose = TRUE
)
}
\arguments{
\item{input_dir}{Character. Directory containing completed BFRS run
(with \code{0_setup/} and \code{1_bfrs/} subdirectories).
Required for standalone mode. Ignored in embedded mode.}

\item{output_dir}{Character. Where to save NPE results.
In standalone mode: defaults to \code{input_dir/2_npe/}.
Specify custom path to run multiple NPE configurations.
In embedded mode: ignored (uses \code{dirs$npe}).}

\item{root_dir}{Character. MOSAIC root directory. If NULL, uses:
\enumerate{
\item Existing \code{getOption('root_directory')} if set
\item Current working directory as fallback
}
Set globally via \code{set_root_directory("~/MOSAIC")} to avoid
specifying on each call. Ignored in embedded mode if PATHS provided.}

\item{results}{Data frame. BFRS results with simulations and weights.
If provided, runs in embedded mode. If NULL, loads from \code{input_dir}.}

\item{priors}{List. Prior distributions for parameters.
Required in embedded mode. If NULL in standalone, loads from disk.}

\item{config}{List. LASER model configuration.
Required in embedded mode. If NULL in standalone, loads from disk.}

\item{param_names}{Character vector. Parameters to include in NPE.
If NULL, auto-detects from results column names.}

\item{dirs}{List. Directory structure from run_MOSAIC containing:
\code{$bfrs}, \code{$setup}, \code{$npe}, \code{$npe_model}, etc.
Required in embedded mode. Constructed in standalone mode.}

\item{PATHS}{List. Global MOSAIC paths from \code{get_paths()}.
Optional in both modes. If NULL, created from \code{root_dir} or
\code{getOption('root_directory')}.}

\item{control}{List. Control settings from \code{mosaic_control_defaults()}.
Required in embedded mode. In standalone mode: if NULL, loads from
\code{simulation_params.json}; if provided, overrides (for experimentation).}

\item{verbose}{Logical. Print progress messages (default: TRUE).}
}
\value{
Invisibly returns a list containing:
\describe{
\item{posterior_samples}{Matrix of posterior samples (n_samples Ã— n_params)}
\item{posterior_log_probs}{Vector of log q(theta|x) for SMC}
\item{posterior_quantiles}{Data frame of parameter quantiles}
\item{param_names}{Character vector of parameter names}
\item{architecture}{List with network architecture specification}
\item{diagnostics}{List with SBC, coverage, and validation metrics}
\item{model}{Trained NPE model object}
\item{config_npe}{Config with NPE posterior medians}
\item{posteriors_npe}{Fitted parametric distributions}
\item{npe_summary}{List with metadata and diagnostics}
\item{dirs}{List with output directory paths}
\item{mode}{Character: "standalone" or "embedded"}
}
}
\description{
Trains a normalizing flow model for neural posterior estimation using
results from Bayesian Filtering with Resampling (BFRS). Can run in two modes:
\enumerate{
\item \strong{Standalone mode}: Load from completed run_MOSAIC output directory
\item \strong{Embedded mode}: Use in-memory objects from within run_MOSAIC
}

Mode is automatically detected based on which arguments are provided.
}
\section{Standalone Mode}{

Provide \code{input_dir} to load data from a completed BFRS run:
\itemize{
\item Loads results from \code{1_bfrs/outputs/simulations.parquet}
\item Loads priors from \code{0_setup/priors.json}
\item Loads config from \code{0_setup/config_base.json}
\item Loads control from \code{0_setup/simulation_params.json} (or uses provided)
\item Auto-detects parameter names from results
\item Creates PATHS from root_dir
\item Constructs dirs from input_dir structure
}

Ideal for post-hoc experimentation with different NPE settings without
re-running expensive BFRS calibration.
}

\section{Embedded Mode}{

Provide \code{results} and other in-memory objects from run_MOSAIC:
\itemize{
\item Uses all objects already in memory (no disk I/O)
\item Requires: results, priors, config, control, dirs
\item Optional: param_names (auto-detects if NULL), PATHS (creates if NULL)
}

This is how run_MOSAIC calls NPE when \code{control$npe$enable = TRUE}.
}

\examples{
\dontrun{
# === STANDALONE MODE ===

# Minimal call (uses defaults):
library(MOSAIC)
set_root_directory("~/MOSAIC")  # Set once per session

npe_result <- run_NPE(
  input_dir = "./output/ethiopia_2024",
  verbose = TRUE
)

# Experiment with different weight strategies:
npe_best <- run_NPE(
  input_dir = "./output/ethiopia_2024",
  output_dir = "./output/ethiopia_2024/2_npe_strategy_best",
  control = mosaic_control_defaults(
    npe = list(weight_strategy = "continuous_best")
  )
)

npe_retained <- run_NPE(
  input_dir = "./output/ethiopia_2024",
  output_dir = "./output/ethiopia_2024/2_npe_strategy_retained",
  control = mosaic_control_defaults(
    npe = list(weight_strategy = "continuous_retained")
  )
)

# === EMBEDDED MODE ===

# Called automatically by run_MOSAIC when npe$enable = TRUE:
run_mosaic_iso(
  iso_code = "ETH",
  dir_output = "./output/ethiopia_2024",
  control = mosaic_control_defaults(
    calibration = list(n_simulations = 5000),
    npe = list(enable = TRUE)
  )
)
}

}
