% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/run_mosaic.R
\name{run_mosaic}
\alias{run_mosaic}
\alias{mosaic_run_defaults}
\alias{mosaic_sampling_defaults}
\alias{mosaic_io_presets}
\alias{run_MOSAIC}
\title{Run MOSAIC Calibration Workflow}
\usage{
run_mosaic(
  iso_code,
  dir_output,
  config = NULL,
  priors = NULL,
  sampling_args = NULL,
  n_iter = 3L,
  n_sims = "auto",
  control = NULL,
  resume = FALSE
)

mosaic_run_defaults()

mosaic_sampling_defaults()

mosaic_io_presets(preset = c("default", "debug", "fast", "archive"))

run_MOSAIC(...)
}
\arguments{
\item{iso_code}{Character vector of ISO3 codes (e.g., \code{c("MOZ","MWI","ZMB","ZWE")}).
Used to load default config and priors if not provided.}

\item{dir_output}{Character. Output directory for this calibration run (REQUIRED).
All results (simulations, diagnostics, plots, posteriors) will be saved here.
Must be unique per run to avoid overwriting results. The directory will be
created if it does not exist.}

\item{config}{Named list of model configuration. If \code{NULL} (default),
loads location-specific configuration via \code{get_location_config(iso_code)}.
Provide custom config to use different outbreak data or model settings.}

\item{priors}{Named list of prior distributions. If \code{NULL} (default),
loads location-specific priors via \code{get_location_priors(iso_code)}.
Provide custom priors to modify parameter ranges or distributions.}

\item{sampling_args}{Named list forwarded to \code{sample_parameters()}. If
\code{NULL} (default), uses \code{mosaic_sampling_defaults()}. Controls which
parameters are sampled vs held fixed.}

\item{n_iter}{Integer. Stochastic iterations per simulation (collapsed post-hoc
via log-mean-exp). Default 3.}

\item{n_sims}{Either \code{"auto"} for adaptive ESS-driven batching (stops at
\code{max_simulations} if not converged), or a positive integer for a fixed
number of simulations (runs exactly that many, ignoring \code{max_simulations}).}

\item{control}{Named list of algorithm settings. Start from \code{mosaic_run_defaults()}
and override fields as needed. See Details for structure.}

\item{resume}{Logical. If \code{TRUE}, reuses existing per-simulation files and
continues from last checkpoint (auto mode) or resumes fixed run.}

\item{preset}{Character. One of "default", "debug", "fast", or "archive"}
}
\value{
Invisibly returns a list with:
\describe{
\item{dirs}{Named list of output directories}
\item{files}{Named list of key output files}
\item{summary}{Named list with run statistics (batches, sims, converged, runtime)}
}
}
\description{
High-level entry point that executes the full MOSAIC calibration workflow:
\enumerate{
\item Adaptive calibration with RÂ² convergence detection
\item Single predictive batch (calculated from calibration phase)
\item Adaptive fine-tuning with 5-tier batch sizing
\item Post-hoc subset optimization for NPE priors
\item Posterior quantile and distribution estimation
\item Posterior predictive checks and uncertainty quantification
\item Optional: Neural Posterior Estimation (NPE) stage
}

The simulation engine samples parameters once per simulation seed, runs
\code{n_iter} stochastic iterations, collapses likelihoods via log-mean-exp,
and writes individual parquet files per simulation.

Returns default control settings for \code{run_mosaic()}

Returns default sampling settings for \code{sample_parameters()}

Returns pre-configured I/O settings for common use cases

Backward-compatible alias for \code{run_mosaic()}
}
\section{Control Structure}{

The \code{control} argument accepts a nested list with these sections:
\describe{
\item{paths}{Behavior flags: \code{clean_output}, \code{plots}}
\item{parallel}{Cluster settings: \code{n_cores}, \code{type}, \code{progress}}
\item{limits}{Hard constraints: \code{max_simulations}, \code{min_ess_check}}
\item{calibration}{Phase 1: \code{batch_size}, \code{min_batches}, \code{max_batches}, \code{target_r2}}
\item{fine_tuning}{Phase 3: \code{batch_sizes} list (massive/large/standard/precision/final)}
\item{targets}{Convergence: \code{ESS_param}, \code{ESS_param_prop}, \code{ESS_best}, \code{A_best}, \code{CVw_best}, \code{B_min}, \code{percentile_max}}
\item{npe}{Stage 2: \code{enable}, \code{weight_strategy}}
\item{io}{File format: \code{format}, \code{compression}, \code{compression_level}}
}
See \code{mosaic_run_defaults()} for defaults.
}

\section{MOSAIC Root Directory}{

The MOSAIC project root (containing MOSAIC-pkg/, MOSAIC-data/, etc.) is
auto-detected from \code{getOption("MOSAIC.root")}. Set once per session:
\preformatted{
  options(MOSAIC.root = "/path/to/MOSAIC")
}
Or add to \code{~/.Rprofile} for permanent configuration.
}

\section{Output Files}{

Results are organized in a structured directory tree:
\itemize{
\item \code{0_setup/}: Configuration files (simulation_params.json, priors.json, config_base.json)
\item \code{1_bfrs/outputs/}: Combined simulations.parquet and individual files during run
\item \code{1_bfrs/diagnostics/}: ESS metrics, convergence results, subset selection
\item \code{1_bfrs/posterior/}: Posterior quantiles and distributions
\item \code{1_bfrs/plots/}: Diagnostic, parameter, and prediction plots
\item \code{2_npe/}: Neural Posterior Estimation results (if enabled)
\item \code{3_results/}: Final combined results
}
}

\examples{
\dontrun{
# Set MOSAIC root (once per session or in ~/.Rprofile)
options(MOSAIC.root = "~/MOSAIC")

# Basic usage with defaults
result <- run_mosaic(
  iso_code = "ETH",
  dir_output = "~/results/ethiopia_2025"
)

# Multi-country calibration with custom settings
ctrl <- mosaic_run_defaults()
ctrl$parallel$n_cores <- 16
ctrl$calibration$target_r2 <- 0.95
ctrl$npe$enable <- TRUE

result <- run_mosaic(
  iso_code = c("MOZ", "MWI", "ZMB", "ZWE"),
  dir_output = "~/results/four_countries",
  n_iter = 5,
  n_sims = "auto",
  control = ctrl
)

# Fixed-size run for testing (CSV output for inspection)
ctrl <- mosaic_run_defaults()
ctrl$io <- mosaic_io_presets("debug")  # CSV format

result <- run_mosaic(
  iso_code = "ETH",
  dir_output = "~/results/test_run",
  n_iter = 1,
  n_sims = 1000,  # Exactly 1000 simulations
  control = ctrl
)

# Custom priors for sensitivity analysis
priors_tight <- get_location_priors("ETH")
priors_tight$tau_i$shape <- 20  # Tighter transmission rate prior

result <- run_mosaic(
  iso_code = "ETH",
  dir_output = "~/results/sensitivity_tight_tau",
  priors = priors_tight
)
}

}
