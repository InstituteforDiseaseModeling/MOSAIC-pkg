% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/run_MOSAIC.R
\name{run_MOSAIC}
\alias{run_MOSAIC}
\alias{run_mosaic}
\title{Run MOSAIC Calibration Workflow}
\usage{
run_MOSAIC(config, priors, dir_output, control = NULL, resume = FALSE)

run_mosaic(config, priors, dir_output, control = NULL, resume = FALSE)
}
\arguments{
\item{config}{Named list of LASER model configuration (REQUIRED). Contains location_name,
reported_cases, reported_deaths, and all model parameters. Create with custom data
or obtain via \code{get_location_config()}.}

\item{priors}{Named list of prior distributions (REQUIRED). Contains distribution
specifications for all parameters. Create custom or obtain via \code{get_location_priors()}.}

\item{dir_output}{Character. Output directory for this calibration run (REQUIRED).
All results will be saved here. Must be unique per run.}

\item{control}{Control list created with \code{\link[=mosaic_control_defaults]{mosaic_control_defaults()}}. If \code{NULL}, uses defaults.
Controls calibration strategy, parameter sampling, parallelization, and output settings.
Key settings:
\itemize{
\item \code{calibration$n_simulations}: NULL for auto mode, integer for fixed mode
\item \code{calibration$n_iterations}: LASER iterations per simulation (default: 3)
\item \code{calibration$max_simulations}: Maximum total simulations (default: 100000)
\item \code{sampling}: Which parameters to sample vs hold fixed
\item \code{parallel}: Cluster settings for parallel execution
}}

\item{resume}{Logical. If \code{TRUE}, continues from existing checkpoint. Default: FALSE.}
}
\value{
Invisibly returns a list with:
\describe{
\item{dirs}{Named list of output directories}
\item{files}{Named list of key output files}
\item{summary}{Named list with run statistics (batches, sims, converged, runtime)}
}
}
\description{
\strong{Complete Bayesian calibration workflow with full control over model specification.}

This function accepts pre-configured config and priors objects, allowing:
\itemize{
\item Completely custom configs (non-standard locations, custom data)
\item Fine-grained control over all model parameters
\item Testing with synthetic configurations
}

Executes the full MOSAIC calibration workflow:
\enumerate{
\item Adaptive calibration with RÂ² convergence detection
\item Single predictive batch (calculated from calibration phase)
\item Adaptive fine-tuning with 5-tier batch sizing
\item Post-hoc subset optimization for NPE priors
\item Posterior quantile and distribution estimation
\item Posterior predictive checks and uncertainty quantification
\item Optional: Neural Posterior Estimation (NPE) stage
}
}
\section{Control Structure}{

See \code{\link[=mosaic_control_defaults]{mosaic_control_defaults()}} for complete documentation. The control structure contains:
\describe{
\item{calibration}{n_simulations, n_iterations, max_simulations, batch_size, etc.}
\item{sampling}{sample_tau_i, sample_mobility_gamma, sample_mu_j, etc.}
\item{parallel}{enable, n_cores, type, progress}
\item{paths}{clean_output, plots}
\item{targets}{ESS_param, ESS_best, A_best, CVw_best, etc.}
\item{npe}{enable, weight_strategy}
\item{io}{format, compression, compression_level}
}
}

\section{Output Files}{

Results are organized in a structured directory tree:
\itemize{
\item \code{0_setup/}: Configuration files (JSON format)
\item \code{1_bfrs/outputs/}: Simulation results (Parquet format)
\item \code{1_bfrs/diagnostics/}: ESS metrics, convergence results
\item \code{1_bfrs/posterior/}: Posterior quantiles and distributions
\item \code{1_bfrs/plots/}: Diagnostic, parameter, and prediction plots
\item \code{2_npe/}: Neural Posterior Estimation results (if enabled)
\item \code{3_results/}: Final combined results
}
}

\examples{
\dontrun{
# === BASIC CUSTOM CONFIG ===

# Load and modify default config
config <- get_location_config(iso = "ETH")
config$population_size <- 1000000

priors <- get_location_priors(iso = "ETH")

run_MOSAIC(
  config = config,
  priors = priors,
  dir_output = "./output"
)

# === MULTI-LOCATION WITH CUSTOM CONTROL ===

config <- get_location_config(iso = c("ETH", "KEN", "TZA"))
priors <- get_location_priors(iso = c("ETH", "KEN", "TZA"))

ctrl <- mosaic_control_defaults(
  calibration = list(
    n_simulations = 5000,  # Fixed mode
    n_iterations = 5
  ),
  parallel = list(enable = TRUE, n_cores = 16)
)

run_MOSAIC(config, priors, "./output", ctrl)

# === CUSTOM PRIORS FOR SENSITIVITY ===

config <- get_location_config(iso = "ETH")
priors <- get_location_priors(iso = "ETH")

# Tighten transmission rate prior
priors$tau_i$shape <- 20
priors$tau_i$rate <- 4

run_MOSAIC(config, priors, "./output")

# === COMPLETELY CUSTOM CONFIG ===

# Non-standard location names
custom_config <- list(
  location_name = c("Region1", "Region2"),
  reported_cases = my_cases_data,
  reported_deaths = my_deaths_data,
  # ... all other LASER parameters
)

custom_priors <- list(
  # ... custom prior specifications
)

run_MOSAIC(custom_config, custom_priors, "./output")
}

}
\seealso{
\code{\link[=mosaic_control_defaults]{mosaic_control_defaults()}} for building control structures
}
