<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run MOSAIC Calibration Workflow — run_mosaic • MOSAIC</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run MOSAIC Calibration Workflow — run_mosaic"><meta name="description" content="High-level entry point that executes the full MOSAIC calibration workflow:
Adaptive calibration with R² convergence detection
Single predictive batch (calculated from calibration phase)
Adaptive fine-tuning with 5-tier batch sizing
Post-hoc subset optimization for NPE priors
Posterior quantile and distribution estimation
Posterior predictive checks and uncertainty quantification
Optional: Neural Posterior Estimation (NPE) stage


The simulation engine samples parameters once per simulation seed, runs
n_iter stochastic iterations, collapses likelihoods via log-mean-exp,
and writes individual parquet files per simulation.
Returns default control settings for run_mosaic()
Returns default sampling settings for sample_parameters()
Returns pre-configured I/O settings for common use cases
Backward-compatible alias for run_mosaic()"><meta property="og:description" content="High-level entry point that executes the full MOSAIC calibration workflow:
Adaptive calibration with R² convergence detection
Single predictive batch (calculated from calibration phase)
Adaptive fine-tuning with 5-tier batch sizing
Post-hoc subset optimization for NPE priors
Posterior quantile and distribution estimation
Posterior predictive checks and uncertainty quantification
Optional: Neural Posterior Estimation (NPE) stage


The simulation engine samples parameters once per simulation seed, runs
n_iter stochastic iterations, collapses likelihoods via log-mean-exp,
and writes individual parquet files per simulation.
Returns default control settings for run_mosaic()
Returns default sampling settings for sample_parameters()
Returns pre-configured I/O settings for common use cases
Backward-compatible alias for run_mosaic()"><meta property="og:image" content="https://institutefordiseasemodeling.github.io/MOSAIC-pkg/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MOSAIC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Deployment.html">Deployment</a></li>
    <li><a class="dropdown-item" href="../articles/Installation.html">Installation</a></li>
    <li><a class="dropdown-item" href="../articles/Running-MOSAIC.html">Running MOSAIC</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Run MOSAIC Calibration Workflow</h1>
      <small class="dont-index">Source: <a href="https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/blob/main/R/run_mosaic.R" class="external-link"><code>R/run_mosaic.R</code></a></small>
      <div class="d-none name"><code>run_mosaic.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>High-level entry point that executes the full MOSAIC calibration workflow:</p><ol><li><p>Adaptive calibration with R² convergence detection</p></li>
<li><p>Single predictive batch (calculated from calibration phase)</p></li>
<li><p>Adaptive fine-tuning with 5-tier batch sizing</p></li>
<li><p>Post-hoc subset optimization for NPE priors</p></li>
<li><p>Posterior quantile and distribution estimation</p></li>
<li><p>Posterior predictive checks and uncertainty quantification</p></li>
<li><p>Optional: Neural Posterior Estimation (NPE) stage</p></li>
</ol><p>The simulation engine samples parameters once per simulation seed, runs
<code>n_iter</code> stochastic iterations, collapses likelihoods via log-mean-exp,
and writes individual parquet files per simulation.</p>
<p>Returns default control settings for <code>run_mosaic()</code></p>
<p>Returns default sampling settings for <code><a href="sample_parameters.html">sample_parameters()</a></code></p>
<p>Returns pre-configured I/O settings for common use cases</p>
<p>Backward-compatible alias for <code>run_mosaic()</code></p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">run_mosaic</span><span class="op">(</span></span>
<span>  <span class="va">iso_code</span>,</span>
<span>  <span class="va">dir_output</span>,</span>
<span>  config <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  priors <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sampling_args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_iter <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>  n_sims <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  control <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  resume <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mosaic_run_defaults</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mosaic_sampling_defaults</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mosaic_io_presets</span><span class="op">(</span>preset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"default"</span>, <span class="st">"debug"</span>, <span class="st">"fast"</span>, <span class="st">"archive"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">run_MOSAIC</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-iso-code">iso_code<a class="anchor" aria-label="anchor" href="#arg-iso-code"></a></dt>
<dd><p>Character vector of ISO3 codes (e.g., <code>c("MOZ","MWI","ZMB","ZWE")</code>).
Used to load default config and priors if not provided.</p></dd>


<dt id="arg-dir-output">dir_output<a class="anchor" aria-label="anchor" href="#arg-dir-output"></a></dt>
<dd><p>Character. Output directory for this calibration run (REQUIRED).
All results (simulations, diagnostics, plots, posteriors) will be saved here.
Must be unique per run to avoid overwriting results. The directory will be
created if it does not exist.</p></dd>


<dt id="arg-config">config<a class="anchor" aria-label="anchor" href="#arg-config"></a></dt>
<dd><p>Named list of model configuration. If <code>NULL</code> (default),
loads location-specific configuration via <code>get_location_config(iso_code)</code>.
Provide custom config to use different outbreak data or model settings.</p></dd>


<dt id="arg-priors">priors<a class="anchor" aria-label="anchor" href="#arg-priors"></a></dt>
<dd><p>Named list of prior distributions. If <code>NULL</code> (default),
loads location-specific priors via <code>get_location_priors(iso_code)</code>.
Provide custom priors to modify parameter ranges or distributions.</p></dd>


<dt id="arg-sampling-args">sampling_args<a class="anchor" aria-label="anchor" href="#arg-sampling-args"></a></dt>
<dd><p>Named list forwarded to <code><a href="sample_parameters.html">sample_parameters()</a></code>. If
<code>NULL</code> (default), uses <code>mosaic_sampling_defaults()</code>. Controls which
parameters are sampled vs held fixed.</p></dd>


<dt id="arg-n-iter">n_iter<a class="anchor" aria-label="anchor" href="#arg-n-iter"></a></dt>
<dd><p>Integer. Stochastic iterations per simulation (collapsed post-hoc
via log-mean-exp). Default 3.</p></dd>


<dt id="arg-n-sims">n_sims<a class="anchor" aria-label="anchor" href="#arg-n-sims"></a></dt>
<dd><p>Either <code>"auto"</code> for adaptive ESS-driven batching (stops at
<code>max_simulations</code> if not converged), or a positive integer for a fixed
number of simulations (runs exactly that many, ignoring <code>max_simulations</code>).</p></dd>


<dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>Named list of algorithm settings. Start from <code>mosaic_run_defaults()</code>
and override fields as needed. See Details for structure.</p></dd>


<dt id="arg-resume">resume<a class="anchor" aria-label="anchor" href="#arg-resume"></a></dt>
<dd><p>Logical. If <code>TRUE</code>, reuses existing per-simulation files and
continues from last checkpoint (auto mode) or resumes fixed run.</p></dd>


<dt id="arg-preset">preset<a class="anchor" aria-label="anchor" href="#arg-preset"></a></dt>
<dd><p>Character. One of "default", "debug", "fast", or "archive"</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Invisibly returns a list with:</p><dl><dt>dirs</dt>
<dd><p>Named list of output directories</p></dd>

<dt>files</dt>
<dd><p>Named list of key output files</p></dd>

<dt>summary</dt>
<dd><p>Named list with run statistics (batches, sims, converged, runtime)</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="control-structure">Control Structure<a class="anchor" aria-label="anchor" href="#control-structure"></a></h2>


<p>The <code>control</code> argument accepts a nested list with these sections:</p><dl><dt>paths</dt>
<dd><p>Behavior flags: <code>clean_output</code>, <code>plots</code></p></dd>

<dt>parallel</dt>
<dd><p>Cluster settings: <code>n_cores</code>, <code>type</code>, <code>progress</code></p></dd>

<dt>limits</dt>
<dd><p>Hard constraints: <code>max_simulations</code>, <code>min_ess_check</code></p></dd>

<dt>calibration</dt>
<dd><p>Phase 1: <code>batch_size</code>, <code>min_batches</code>, <code>max_batches</code>, <code>target_r2</code></p></dd>

<dt>fine_tuning</dt>
<dd><p>Phase 3: <code>batch_sizes</code> list (massive/large/standard/precision/final)</p></dd>

<dt>targets</dt>
<dd><p>Convergence: <code>ESS_param</code>, <code>ESS_param_prop</code>, <code>ESS_best</code>, <code>A_best</code>, <code>CVw_best</code>, <code>B_min</code>, <code>percentile_max</code></p></dd>

<dt>npe</dt>
<dd><p>Stage 2: <code>enable</code>, <code>weight_strategy</code></p></dd>

<dt>io</dt>
<dd><p>File format: <code>format</code>, <code>compression</code>, <code>compression_level</code></p></dd>


</dl><p>See <code>mosaic_run_defaults()</code> for defaults.</p>
    </div>
    <div class="section level2">
    <h2 id="mosaic-root-directory">MOSAIC Root Directory<a class="anchor" aria-label="anchor" href="#mosaic-root-directory"></a></h2>


<p>The MOSAIC project root (containing MOSAIC-pkg/, MOSAIC-data/, etc.) is
auto-detected from <code>getOption("MOSAIC.root")</code>. Set once per session:</p><div class="sourceCode"><pre><code><span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>MOSAIC.root <span class="op">=</span> <span class="st">"/path/to/MOSAIC"</span><span class="op">)</span></span></code></pre></div><p>Or add to <code>~/.Rprofile</code> for permanent configuration.</p>
    </div>
    <div class="section level2">
    <h2 id="output-files">Output Files<a class="anchor" aria-label="anchor" href="#output-files"></a></h2>


<p>Results are organized in a structured directory tree:</p><ul><li><p><code>0_setup/</code>: Configuration files (simulation_params.json, priors.json, config_base.json)</p></li>
<li><p><code>1_bfrs/outputs/</code>: Combined simulations.parquet and individual files during run</p></li>
<li><p><code>1_bfrs/diagnostics/</code>: ESS metrics, convergence results, subset selection</p></li>
<li><p><code>1_bfrs/posterior/</code>: Posterior quantiles and distributions</p></li>
<li><p><code>1_bfrs/plots/</code>: Diagnostic, parameter, and prediction plots</p></li>
<li><p><code>2_npe/</code>: Neural Posterior Estimation results (if enabled)</p></li>
<li><p><code>3_results/</code>: Final combined results</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Set MOSAIC root (once per session or in ~/.Rprofile)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>MOSAIC.root <span class="op">=</span> <span class="st">"~/MOSAIC"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Basic usage with defaults</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">run_mosaic</span><span class="op">(</span></span></span>
<span class="r-in"><span>  iso_code <span class="op">=</span> <span class="st">"ETH"</span>,</span></span>
<span class="r-in"><span>  dir_output <span class="op">=</span> <span class="st">"~/results/ethiopia_2025"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Multi-country calibration with custom settings</span></span></span>
<span class="r-in"><span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu">mosaic_run_defaults</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">ctrl</span><span class="op">$</span><span class="va">parallel</span><span class="op">$</span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fl">16</span></span></span>
<span class="r-in"><span><span class="va">ctrl</span><span class="op">$</span><span class="va">calibration</span><span class="op">$</span><span class="va">target_r2</span> <span class="op">&lt;-</span> <span class="fl">0.95</span></span></span>
<span class="r-in"><span><span class="va">ctrl</span><span class="op">$</span><span class="va">npe</span><span class="op">$</span><span class="va">enable</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">run_mosaic</span><span class="op">(</span></span></span>
<span class="r-in"><span>  iso_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MOZ"</span>, <span class="st">"MWI"</span>, <span class="st">"ZMB"</span>, <span class="st">"ZWE"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  dir_output <span class="op">=</span> <span class="st">"~/results/four_countries"</span>,</span></span>
<span class="r-in"><span>  n_iter <span class="op">=</span> <span class="fl">5</span>,</span></span>
<span class="r-in"><span>  n_sims <span class="op">=</span> <span class="st">"auto"</span>,</span></span>
<span class="r-in"><span>  control <span class="op">=</span> <span class="va">ctrl</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fixed-size run for testing (CSV output for inspection)</span></span></span>
<span class="r-in"><span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu">mosaic_run_defaults</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">ctrl</span><span class="op">$</span><span class="va">io</span> <span class="op">&lt;-</span> <span class="fu">mosaic_io_presets</span><span class="op">(</span><span class="st">"debug"</span><span class="op">)</span>  <span class="co"># CSV format</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">run_mosaic</span><span class="op">(</span></span></span>
<span class="r-in"><span>  iso_code <span class="op">=</span> <span class="st">"ETH"</span>,</span></span>
<span class="r-in"><span>  dir_output <span class="op">=</span> <span class="st">"~/results/test_run"</span>,</span></span>
<span class="r-in"><span>  n_iter <span class="op">=</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>  n_sims <span class="op">=</span> <span class="fl">1000</span>,  <span class="co"># Exactly 1000 simulations</span></span></span>
<span class="r-in"><span>  control <span class="op">=</span> <span class="va">ctrl</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Custom priors for sensitivity analysis</span></span></span>
<span class="r-in"><span><span class="va">priors_tight</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_location_priors.html">get_location_priors</a></span><span class="op">(</span><span class="st">"ETH"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">priors_tight</span><span class="op">$</span><span class="va">tau_i</span><span class="op">$</span><span class="va">shape</span> <span class="op">&lt;-</span> <span class="fl">20</span>  <span class="co"># Tighter transmission rate prior</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">run_mosaic</span><span class="op">(</span></span></span>
<span class="r-in"><span>  iso_code <span class="op">=</span> <span class="st">"ETH"</span>,</span></span>
<span class="r-in"><span>  dir_output <span class="op">=</span> <span class="st">"~/results/sensitivity_tight_tau"</span>,</span></span>
<span class="r-in"><span>  priors <span class="op">=</span> <span class="va">priors_tight</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gilesjohnr" class="external-link">John R Giles</a>, <a href="https://github.com/ChristopherWLorton" class="external-link">Christopher W Lorton</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

