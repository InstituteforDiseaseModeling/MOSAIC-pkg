---
title: "Deployment"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deployment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Overview

This guide shows how to deploy MOSAIC on remote virtual machines or compute clusters for production use and large-scale simulations. MOSAIC provides ready-to-use bash scripts that handle all installation steps automatically.

The deployment scripts are **non-interactive** and execute remotely via `ssh user@host 'bash -s' < script.sh`. All scripts are available in the `vm/` directory of the MOSAIC-pkg repository.

---

## Complete VM Setup

The `vm/setup_mosaic.sh` script installs R, system dependencies, MOSAIC package, and Python components from scratch on Ubuntu/Debian systems.

### Execution Options

**Option 1: Direct from GitHub (recommended)**

No local files needed - downloads and executes the latest script directly:

```{sh vm-github, eval=FALSE}
curl -fsSL https://raw.githubusercontent.com/InstituteforDiseaseModeling/MOSAIC-pkg/main/vm/setup_mosaic.sh | ssh user@host 'bash -s'
```

**Option 2: From local MOSAIC repository**

If you have MOSAIC-pkg cloned locally (from Standard Setup in Installation vignette):

```{sh vm-local, eval=FALSE}
ssh user@host 'bash -s' < ~/MOSAIC/MOSAIC-pkg/vm/setup_mosaic.sh
```


### Script Contents

```{bash, code=readLines('../../vm/setup_mosaic.sh'), eval=FALSE}
```

---

## Minimal VM Setup

If R >= 4.1.1 is already installed on your VM, use `vm/setup_mosaic_minimal.sh`.

### Execution Options

**Option 1: Direct from GitHub (recommended)**

```{sh vm-minimal-github, eval=FALSE}
curl -fsSL https://raw.githubusercontent.com/InstituteforDiseaseModeling/MOSAIC-pkg/main/vm/setup_mosaic_minimal.sh | ssh user@host 'bash -s'
```

**Option 2: From local MOSAIC repository**

```{sh vm-minimal-local, eval=FALSE}
ssh user@host 'bash -s' < ~/MOSAIC/MOSAIC-pkg/vm/setup_mosaic_minimal.sh
```

### What it does

This script is identical to the complete setup but skips R installation (step 2/6). It installs:

- System libraries (GDAL, PROJ, GEOS, UDUNITS, Python)
- MOSAIC R package from GitHub
- Python dependencies (laser-cholera)
- Verifies installation with `check_dependencies()`

---

## Parallel Execution

For running multiple simulations in parallel on a cluster:

```{r vm-parallel}
# Set number of cores
library(MOSAIC)
options(mc.cores = parallel::detectCores() - 1)

# Run parallel simulations
ctrl <- mosaic_control_defaults(
  parallel = TRUE,
  n_cores = parallel::detectCores() - 1
)

results <- run_LASER(
  config = config_default,
  control = ctrl,
  n_sim = 100,
  seed = 123
)
```

---

## Troubleshooting

**Python issues:**
```{r troubleshoot}
# Check Python configuration
reticulate::py_config()

# Reset if needed
remove_MOSAIC_python_env()
install_dependencies()
```

---

## Next Steps

After deployment, see the **"Running MOSAIC"** vignette to learn model execution.
