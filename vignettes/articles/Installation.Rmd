---
title: "Installation"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Overview

MOSAIC has three installation levels depending on your needs:

| Setup                | Purpose                             | Requirements                   |
|:---------------------|:------------------------------------|:-------------------------------|
| **Quick Start**      | Run pre-configured models           | R + internet                   |
| **Standard**         | Process data & run prior models     | R + git + system libraries     |
| **Developer**        | Contribute code & full development  | All above + dev tools          |

Most users should start with **Quick Start**.

---

## Quick Start

Install the R package from GitHub and let it automatically set up Python dependencies. This is sufficient for running models with pre-configured parameters.

```{r quick-install}
# Install MOSAIC R package
devtools::install_github("InstituteforDiseaseModeling/MOSAIC-pkg")

# Load and install Python dependencies
library(MOSAIC)
install_dependencies()

# Verify installation
config <- config_default
results <- run_LASER(config, n_sim = 2, seed = 123)
```

---

## Standard Setup

Clone the full repository structure for data processing and parameter estimation. Requires system dependencies (GDAL, PROJ, GEOS, UDUNITS).

**Note**: We recommend creating a `~/MOSAIC` directory to organize all MOSAIC repositories in one location.

**macOS:**
```{sh std-macos}
brew install gdal proj geos udunits
```

**Ubuntu/Debian:**
```{sh std-ubuntu}
sudo apt-get install -y gdal-bin libgdal-dev libproj-dev libgeos-dev libudunits2-dev
```

**Clone repositories:**
```{sh std-clone}
mkdir -p ~/MOSAIC && cd ~/MOSAIC
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-pkg.git
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-data.git
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-docs.git
git clone git@github.com:InstituteforDiseaseModeling/laser-cholera.git
```

**Install and configure:**
```{r std-install}
# Install R package from source
devtools::install("~/MOSAIC/MOSAIC-pkg")

# Set up Python and paths
library(MOSAIC)
install_dependencies()
set_root_directory("~/MOSAIC")

# Verify
PATHS <- get_paths()
config <- config_default
results <- run_LASER(config, n_sim = 2, seed = 123)
```

---

## Developer Setup

Same as Standard Setup, plus optional data scraping repository and development tools.

**Clone additional repository (optional):**
```{sh dev-clone}
cd ~/MOSAIC
git clone git@github.com:InstituteforDiseaseModeling/ees-cholera-mapping.git
```

**Development workflow:**
```{r dev-workflow}
# Load for development
devtools::load_all("~/MOSAIC/MOSAIC-pkg")

# Run tests
devtools::test()

# Build documentation
devtools::document()
pkgdown::build_site()
```

---

## Troubleshooting

**Python issues:**
```{r troubleshoot}
# Check Python configuration
reticulate::py_config()

# Reset if needed
remove_MOSAIC_python_env()
install_dependencies()
```

**Path issues (Standard/Developer only):**
```{r paths}
# Check and reset root directory
getOption("root_directory")
set_root_directory("~/MOSAIC")
```

**Ubuntu 20.04 GLIBCXX compatibility:**

Ubuntu 20.04 has an older C++ standard library (GLIBCXX_3.4.28) that conflicts with some Python packages requiring GLIBCXX_3.4.29+. The solution is to use R wrappers that preload the compatible library from the Python environment before R starts.

This is automatically configured by the `vm/setup_mosaic_minimal.sh` script. For manual installations:

```{sh ubuntu-wrapper}
# 1. Create ~/bin directory
mkdir -p ~/bin

# 2. Create R wrapper (for interactive sessions)
cat > ~/bin/r-mosaic-R <<'EOF'
#!/usr/bin/env bash
# Find a modern libstdc++ inside common reticulate env locations
candidates=(
  "$HOME/.virtualenvs/r-mosaic/lib/libstdc++.so.6"
  "$HOME/.local/share/r-miniconda/envs/r-mosaic/lib/libstdc++.so.6"
  "$HOME/.local/share/r-miniconda/envs/r-reticulate/lib/libstdc++.so.6"
)
for f in "${candidates[@]}"; do
  if [ -f "$f" ] && strings "$f" 2>/dev/null | grep -q "GLIBCXX_3\.4\.29"; then
    export LD_PRELOAD="$f${LD_PRELOAD:+:$LD_PRELOAD}"
    export LD_LIBRARY_PATH="$(dirname "$f")${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
    break
  fi
done
[ -x "$HOME/.virtualenvs/r-mosaic/bin/python" ] && export RETICULATE_PYTHON="$HOME/.virtualenvs/r-mosaic/bin/python"
exec R "$@"
EOF
chmod +x ~/bin/r-mosaic-R

# 3. Create Rscript wrapper (for batch jobs)
cat > ~/bin/r-mosaic-Rscript <<'EOF'
#!/usr/bin/env bash
# Same preload logic for Rscript
candidates=(
  "$HOME/.virtualenvs/r-mosaic/lib/libstdc++.so.6"
  "$HOME/.local/share/r-miniconda/envs/r-mosaic/lib/libstdc++.so.6"
  "$HOME/.local/share/r-miniconda/envs/r-reticulate/lib/libstdc++.so.6"
)
for f in "${candidates[@]}"; do
  if [ -f "$f" ] && strings "$f" 2>/dev/null | grep -q "GLIBCXX_3\.4\.29"; then
    export LD_PRELOAD="$f${LD_PRELOAD:+:$LD_PRELOAD}"
    export LD_LIBRARY_PATH="$(dirname "$f")${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
    break
  fi
done
[ -x "$HOME/.virtualenvs/r-mosaic/bin/python" ] && export RETICULATE_PYTHON="$HOME/.virtualenvs/r-mosaic/bin/python"
exec Rscript "$@"
EOF
chmod +x ~/bin/r-mosaic-Rscript

# 4. Add to PATH
echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# 5. Use wrappers instead of R/Rscript
r-mosaic-Rscript -e 'library(MOSAIC); check_dependencies()'  # Batch
r-mosaic-R                                                     # Interactive
```

**Why both wrappers?**
- `r-mosaic-R`: For interactive R sessions
- `r-mosaic-Rscript`: For batch jobs and scripts (e.g., `r-mosaic-Rscript my_analysis.R`)

**How it works**: The wrappers check multiple common Python environment locations and only set `LD_PRELOAD` if they find a library with GLIBCXX_3.4.29+ symbols. This makes the wrappers robust to different installation methods (virtualenvs, miniconda, reticulate auto-install).

**Note**: Ubuntu 22.04+ do not need this workaround. The wrappers only affect R/Rscript sessions started through them, not system-wide installations.

**Optional: Mobility package for regenerating mobility estimates:**

The `mobility` package is only needed if you want to regenerate mobility estimates from scratch. Most users can skip this - pre-computed mobility files are included in `model/input/`.

```{r mobility-install}
# Only install if you need to regenerate mobility data
# Requires JAGS system library

# macOS:
# brew install jags

# Ubuntu/Debian:
# sudo apt-get install -y jags libjags-dev

# Then install R packages:
install.packages("rjags")
remotes::install_github("COVID-19-Mobility-Data-Network/mobility")
```

**When is this needed?** Only if you're calling `MOSAIC::est_mobility()` to regenerate mobility matrices. Otherwise, use the pre-computed files included with the package.

---

## Next Steps

- **Running MOSAIC**: Learn how to execute models and work with outputs
- **Deployment**: Set up MOSAIC on remote VMs or compute clusters
