---
title: "Installation"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Overview

MOSAIC has three installation levels depending on your needs:

| Setup                | Purpose                             | Requirements                   |
|:---------------------|:------------------------------------|:-------------------------------|
| **Quick Start**      | Run pre-configured models           | R + internet                   |
| **Standard**         | Process data & run prior models     | R + git + system libraries     |
| **Developer**        | Contribute code & full development  | All above + dev tools          |

Most users should start with **Quick Start**.

---

## Quick Start

Install the R package from GitHub and let it automatically set up Python dependencies. This is sufficient for running models with pre-configured parameters.

```{r quick-install}
# Install MOSAIC R package
devtools::install_github("InstituteforDiseaseModeling/MOSAIC-pkg")

# Load and install Python dependencies
library(MOSAIC)
install_dependencies()

# Verify installation
config <- config_default
results <- run_LASER(config, n_sim = 2, seed = 123)
```

---

## Standard Setup

Clone the full repository structure for data processing and parameter estimation. Requires system dependencies (GDAL, PROJ, GEOS, UDUNITS).

**Note**: We recommend creating a `~/MOSAIC` directory to organize all MOSAIC repositories in one location.

**macOS:**
```{sh std-macos}
brew install gdal proj geos udunits
```

**Ubuntu/Debian:**
```{sh std-ubuntu}
sudo apt-get install -y gdal-bin libgdal-dev libproj-dev libgeos-dev libudunits2-dev
```

**Clone repositories:**
```{sh std-clone}
mkdir -p ~/MOSAIC && cd ~/MOSAIC
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-pkg.git
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-data.git
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-docs.git
git clone git@github.com:InstituteforDiseaseModeling/laser-cholera.git
```

**Install and configure:**
```{r std-install}
# Install R package from source
devtools::install("~/MOSAIC/MOSAIC-pkg")

# Set up Python and paths
library(MOSAIC)
install_dependencies()
set_root_directory("~/MOSAIC")

# Verify
PATHS <- get_paths()
config <- config_default
results <- run_LASER(config, n_sim = 2, seed = 123)
```

---

## Developer Setup

Same as Standard Setup, plus optional data scraping repository and development tools.

**Clone additional repository (optional):**
```{sh dev-clone}
cd ~/MOSAIC
git clone git@github.com:InstituteforDiseaseModeling/ees-cholera-mapping.git
```

**Development workflow:**
```{r dev-workflow}
# Load for development
devtools::load_all("~/MOSAIC/MOSAIC-pkg")

# Run tests
devtools::test()

# Build documentation
devtools::document()
pkgdown::build_site()
```

---

## Troubleshooting

**Python issues:**
```{r troubleshoot}
# Check Python configuration
reticulate::py_config()

# Reset if needed
remove_MOSAIC_python_env()
install_dependencies()
```

**Path issues (Standard/Developer only):**
```{r paths}
# Check and reset root directory
getOption("root_directory")
set_root_directory("~/MOSAIC")
```

**Ubuntu 20.04 GLIBCXX compatibility:**

Ubuntu 20.04 has an older C++ standard library (GLIBCXX_3.4.28) that conflicts with some Python packages requiring GLIBCXX_3.4.29+. The solution is to use an R wrapper that preloads the compatible library from the Python environment.

This is automatically configured by the `vm/setup_mosaic_minimal.sh` script. For manual installations:

```{sh ubuntu-wrapper}
# 1. Verify conda library has required symbols
strings ~/.virtualenvs/r-mosaic/lib/libstdc++.so.6 | grep -E 'GLIBCXX_3\.4\.29|GLIBCXX_3\.4\.3[0-9]'

# 2. Create R wrapper script
mkdir -p ~/bin
cat > ~/bin/r-mosaic-R <<'EOF'
#!/usr/bin/env bash
export LD_PRELOAD="$HOME/.virtualenvs/r-mosaic/lib/libstdc++.so.6"
export LD_LIBRARY_PATH="$HOME/.virtualenvs/r-mosaic/lib:${LD_LIBRARY_PATH}"
exec R "$@"
EOF
chmod +x ~/bin/r-mosaic-R

# 3. Add to PATH
echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# 4. Use r-mosaic-R instead of R
r-mosaic-R -e 'library(MOSAIC); check_dependencies()'
```

**Note**: Ubuntu 22.04+ do not need this workaround. The wrapper only affects R sessions started with `r-mosaic-R`, not system-wide R installations.

---

## Next Steps

- **Running MOSAIC**: Learn how to execute models and work with outputs
- **Deployment**: Set up MOSAIC on remote VMs or compute clusters
