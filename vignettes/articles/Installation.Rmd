---
title: "Installation"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Overview

MOSAIC has three installation levels depending on your needs:

| Setup                | Purpose                             | Requirements                   |
|:---------------------|:------------------------------------|:-------------------------------|
| **Quick Start**      | Run pre-configured models           | R + internet                   |
| **Standard**         | Process data & estimate parameters  | R + git + system libraries     |
| **Developer**        | Contribute code & full development  | All above + dev tools          |

Most users should start with Quick Start.

---

## Quick Start

Install the R package from GitHub and let it automatically set up Python dependencies. This is sufficient for running models with pre-configured parameters.

```{r quick-install}
# Install MOSAIC R package
devtools::install_github("InstituteforDiseaseModeling/MOSAIC-pkg")

# Load and install Python dependencies
library(MOSAIC)
install_dependencies()

# Verify installation
config <- config_default
results <- run_LASER(config, n_sim = 2, seed = 123)
```

---

## Standard Setup

Clone the full repository structure for data processing and parameter estimation. Requires system dependencies (GDAL, PROJ, GEOS, UDUNITS).

**macOS:**
```{sh std-macos}
brew install gdal proj geos udunits
```

**Ubuntu/Debian:**
```{sh std-ubuntu}
sudo apt-get install -y gdal-bin libgdal-dev libproj-dev libgeos-dev libudunits2-dev
```

**Clone repositories:**
```{sh std-clone}
mkdir -p ~/MOSAIC && cd ~/MOSAIC
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-pkg.git
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-data.git
git clone git@github.com:InstituteforDiseaseModeling/MOSAIC-docs.git
git clone git@github.com:InstituteforDiseaseModeling/laser-cholera.git
```

**Install and configure:**
```{r std-install}
# Install R package from source
devtools::install("~/MOSAIC/MOSAIC-pkg")

# Set up Python and paths
library(MOSAIC)
install_dependencies()
set_root_directory("~/MOSAIC")

# Verify
PATHS <- get_paths()
config <- config_default
results <- run_LASER(config, n_sim = 2, seed = 123)
```

---

## Developer Setup

Same as Standard Setup, plus optional data scraping repository and development tools.

**Clone additional repository (optional):**
```{sh dev-clone}
cd ~/MOSAIC
git clone git@github.com:InstituteforDiseaseModeling/ees-cholera-mapping.git
```

**Development workflow:**
```{r dev-workflow}
# Load for development
devtools::load_all("~/MOSAIC/MOSAIC-pkg")

# Run tests
devtools::test()

# Build documentation
devtools::document()
pkgdown::build_site()
```

---

## Cluster/VM Deployment

Deploy MOSAIC on remote virtual machines or compute clusters using these transportable bash scripts. All scripts are non-interactive and can be executed via SSH or cloud-init.

**Complete Ubuntu/Debian VM Setup:**

Save this script as `setup_mosaic_vm.sh` and run via `ssh user@host 'bash -s' < setup_mosaic_vm.sh`

```{sh vm-setup}
#!/bin/bash
set -e  # Exit on any error

echo "======================================"
echo "MOSAIC VM Setup Script"
echo "======================================"

# Update system
echo "[1/6] Updating system packages..."
sudo apt-get update
sudo apt-get upgrade -y

# Install R and dependencies
echo "[2/6] Installing R (>= 4.1.1)..."
sudo apt-get install -y software-properties-common dirmngr
wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
sudo add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
sudo apt-get update
sudo apt-get install -y r-base r-base-dev

# Install system dependencies for geospatial operations
echo "[3/6] Installing geospatial libraries (GDAL, PROJ, GEOS)..."
sudo apt-get install -y \
  gdal-bin libgdal-dev \
  libproj-dev proj-bin \
  libgeos-dev libgeos++-dev \
  libudunits2-dev \
  libcurl4-openssl-dev \
  libssl-dev \
  libxml2-dev \
  libfontconfig1-dev \
  libharfbuzz-dev \
  libfribidi-dev \
  libfreetype6-dev \
  libpng-dev \
  libtiff5-dev \
  libjpeg-dev

# Install Python 3.9+
echo "[4/6] Installing Python 3.9+..."
sudo apt-get install -y \
  python3 \
  python3-pip \
  python3-venv \
  python3-dev

# Install R packages system-wide (non-interactive)
echo "[5/6] Installing MOSAIC R package..."
sudo Rscript -e "options(repos = c(CRAN = 'https://cloud.r-project.org')); \
  if (!requireNamespace('remotes', quietly = TRUE)) install.packages('remotes'); \
  remotes::install_github('InstituteforDiseaseModeling/MOSAIC-pkg', dependencies = TRUE, upgrade = 'always')"

# Install Python dependencies
echo "[6/6] Installing Python dependencies..."
sudo Rscript -e "MOSAIC::install_dependencies()"

echo "======================================"
echo "Installation complete!"
echo "======================================"
echo ""
echo "Verify installation with:"
echo "  Rscript -e \"library(MOSAIC); MOSAIC::check_dependencies()\""
```

**Minimal VM Setup (R already installed):**

If R is already installed on your VM, use this lighter script:

```{sh vm-minimal}
#!/bin/bash
set -e

echo "Installing MOSAIC dependencies..."

# System libraries
sudo apt-get update
sudo apt-get install -y \
  gdal-bin libgdal-dev \
  libproj-dev libgeos-dev \
  libudunits2-dev \
  python3 python3-pip python3-venv

# MOSAIC R package
Rscript -e "remotes::install_github('InstituteforDiseaseModeling/MOSAIC-pkg')"

# Python dependencies
Rscript -e "MOSAIC::install_dependencies()"

echo "Installation complete!"
```

**Parallel Execution Setup:**

For running multiple simulations in parallel on a cluster:

```{r vm-parallel}
# Set number of cores
library(MOSAIC)
options(mc.cores = parallel::detectCores() - 1)

# Run parallel simulations
ctrl <- mosaic_control(
  parallel = TRUE,
  n_cores = parallel::detectCores() - 1
)

results <- run_LASER(
  config = config_default,
  control = ctrl,
  n_sim = 100,
  seed = 123
)
```

**Azure VM Deployment:**

For Azure-specific deployment, see the `azure/` directory in MOSAIC-pkg for batch execution scripts.

---

## Troubleshooting

**Python issues:**
```{r troubleshoot}
# Check Python configuration
reticulate::py_config()

# Reset if needed
remove_MOSAIC_python_env()
install_dependencies()
```

**Path issues (Standard/Developer only):**
```{r paths}
# Check and reset root directory
getOption("root_directory")
set_root_directory("~/MOSAIC")
```

---

## Next Steps

After installation, see the **"Running MOSAIC"** vignette to learn model execution.
