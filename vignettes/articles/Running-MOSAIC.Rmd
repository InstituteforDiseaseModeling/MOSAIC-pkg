---
title: "Running MOSAIC"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  cache = TRUE,
  cache.path = "cache/"
)

# Create figures directory if it doesn't exist
if (!dir.exists("figures")) {
  dir.create("figures", recursive = TRUE)
}
```

## Overview

MOSAIC (Metapopulation Outbreak Simulation with Agent-based Implementation for Cholera) simulates cholera transmission dynamics using the LASER (Light-agent Spatial model for ERadication) engine. This guide shows how to run models using the core `run_LASER()` function.

**Before you begin**: Complete the Installation vignette to set up MOSAIC and its dependencies.

---

## Quick Start

MOSAIC includes pre-configured parameter sets for different transmission scenarios. Let's run and visualize two key scenarios: epidemic and endemic transmission.

### Epidemic Scenario

The epidemic configuration simulates outbreak dynamics with explosive growth patterns typical of cholera epidemics.

```{r epidemic-example}
library(MOSAIC)

# Run epidemic scenario
model_epidemic <- run_LASER(
  paramfile = config_simulation_epidemic,
  seed = 123
)

# Extract time series results (convert Python objects to R matrices)
cases_epidemic <- as.matrix(model_epidemic$results$expected_cases)
deaths_epidemic <- as.matrix(model_epidemic$results$disease_deaths)

# Diagnostic: Check if data manipulation is still needed
cat(sprintf("Raw cases dimensions: %d rows × %d cols\n",
            nrow(cases_epidemic), ncol(cases_epidemic)))

# Check if first row is time index (sequential integers starting from 0)
first_row_is_time <- all(cases_epidemic[1, ] == seq(0, ncol(cases_epidemic) - 1))
if (first_row_is_time) {
  cat("First row is time index, removing...\n")
  cases_epidemic <- cases_epidemic[-1, ]
  deaths_epidemic <- deaths_epidemic[-1, ]
} else {
  cat("First row is data, keeping...\n")
}

# Check if we need to transpose to [location × time]
needs_transpose <- nrow(cases_epidemic) > ncol(cases_epidemic)
if (needs_transpose) {
  cat(sprintf("Transposing from [%d × %d] to [location × time]...\n",
              nrow(cases_epidemic), ncol(cases_epidemic)))
  cases_epidemic <- t(cases_epidemic)
  deaths_epidemic <- t(deaths_epidemic)
} else {
  cat("Data already in [location × time] format\n")
}

cat(sprintf("Final cases dimensions: %d locations × %d timesteps\n\n",
            nrow(cases_epidemic), ncol(cases_epidemic)))

# Get metadata
locations <- c("FOO", "BAR", "BAZ")  # From config_simulation_epidemic
n_locations <- length(locations)
n_timesteps <- ncol(cases_epidemic)

# Calculate total burden
total_cases_epidemic <- sum(cases_epidemic, na.rm = TRUE)
total_deaths_epidemic <- sum(deaths_epidemic, na.rm = TRUE)

cat(sprintf("Epidemic Scenario Results:\n"))
cat(sprintf("  Total cases: %s\n", format(total_cases_epidemic, big.mark = ",")))
cat(sprintf("  Total deaths: %s\n", format(total_deaths_epidemic, big.mark = ",")))
cat(sprintf("  Locations: %d\n", n_locations))
cat(sprintf("  Time steps: %d\n", n_timesteps))

# Plot epidemic time series by location
png("figures/running_mosaic_epidemic.png", width = 800, height = 600, res = 120)

colors <- c("#009ADE", "#FF1F5B", "#00CD6C")  # Blue, Pink, Green
par(mfrow = c(2, 1), mar = c(3, 4, 3, 1), oma = c(2, 0, 0, 0))

matplot(t(cases_epidemic), type = "l", lty = 1, lwd = 2, col = colors,
        xlab = "", ylab = "Expected Cases",
        main = "Epidemic Transmission Simulation")
grid(col = "gray90")

matplot(t(deaths_epidemic), type = "l", lty = 1, lwd = 2, col = colors,
        xlab = "Time step", ylab = "Expected Deaths", main = "")
grid(col = "gray90")

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("bottom", legend = locations, col = colors, lty = 1, lwd = 2,
       horiz = TRUE, bty = "n", xpd = TRUE)

dev.off()
cat("Saved: figures/running_mosaic_epidemic.png\n")
```

```{r epidemic-plot, echo = FALSE, eval = TRUE, out.width = "90%"}
knitr::include_graphics("figures/running_mosaic_epidemic.png")
```

### Endemic Scenario

The endemic configuration simulates stable, persistent transmission patterns with seasonal fluctuations.

```{r endemic-example}
# Run endemic scenario
model_endemic <- run_LASER(
  paramfile = config_simulation_endemic,
  seed = 123
)

# Extract time series results (convert Python objects to R matrices)
cases_endemic <- as.matrix(model_endemic$results$expected_cases)
deaths_endemic <- as.matrix(model_endemic$results$disease_deaths)

# Diagnostic: Check if data manipulation is still needed
cat(sprintf("Raw cases dimensions: %d rows × %d cols\n",
            nrow(cases_endemic), ncol(cases_endemic)))

# Check if first row is time index
first_row_is_time <- all(cases_endemic[1, ] == seq(0, ncol(cases_endemic) - 1))
if (first_row_is_time) {
  cat("First row is time index, removing...\n")
  cases_endemic <- cases_endemic[-1, ]
  deaths_endemic <- deaths_endemic[-1, ]
} else {
  cat("First row is data, keeping...\n")
}

# Check if we need to transpose
needs_transpose <- nrow(cases_endemic) > ncol(cases_endemic)
if (needs_transpose) {
  cat(sprintf("Transposing from [%d × %d] to [location × time]...\n",
              nrow(cases_endemic), ncol(cases_endemic)))
  cases_endemic <- t(cases_endemic)
  deaths_endemic <- t(deaths_endemic)
} else {
  cat("Data already in [location × time] format\n")
}

cat(sprintf("Final cases dimensions: %d locations × %d timesteps\n\n",
            nrow(cases_endemic), ncol(cases_endemic)))

# Calculate total burden
total_cases_endemic <- sum(cases_endemic, na.rm = TRUE)
total_deaths_endemic <- sum(deaths_endemic, na.rm = TRUE)

cat(sprintf("Endemic Scenario Results:\n"))
cat(sprintf("  Total cases: %s\n", format(total_cases_endemic, big.mark = ",")))
cat(sprintf("  Total deaths: %s\n", format(total_deaths_endemic, big.mark = ",")))

# Plot endemic time series by location
png("figures/running_mosaic_endemic.png", width = 800, height = 600, res = 120)

colors <- c("#00CD6C", "#AF58BA", "#009ADE")  # Green, Purple, Blue
par(mfrow = c(2, 1), mar = c(3, 4, 3, 1), oma = c(2, 0, 0, 0))

matplot(t(cases_endemic), type = "l", lty = 1, lwd = 2, col = colors,
        xlab = "", ylab = "Expected Cases",
        main = "Endemic Transmission Simulation")
grid(col = "gray90")

matplot(t(deaths_endemic), type = "l", lty = 1, lwd = 2, col = colors,
        xlab = "Time step", ylab = "Expected Deaths", main = "")
grid(col = "gray90")

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("bottom", legend = locations, col = colors, lty = 1, lwd = 2,
       horiz = TRUE, bty = "n", xpd = TRUE)

dev.off()
cat("Saved: figures/running_mosaic_endemic.png\n")
```

```{r endemic-plot, echo = FALSE, eval = TRUE, out.width = "90%"}
knitr::include_graphics("figures/running_mosaic_endemic.png")
```

---



## Getting Help

- **Package documentation**: `help(package = "MOSAIC")`
- **Function help**: `?run_LASER`, `?make_LASER_config`
- **Report issues**: https://github.com/InstituteforDiseaseModeling/MOSAIC-pkg/issues
- **Examples**: See `MOSAIC-pkg/model/` directory for complete workflows
